<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Activate HQ â€” Lexington Command Center</title>
<link rel="manifest" href="manifest.json">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Activate HQ">
<meta name="theme-color" content="#00e5ff">
<!-- Apple touch icon fallback (inline SVG-based) -->
<link rel="apple-touch-icon" href="icon-192.png">

<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;1,400&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0c10;
  --surface: #12151c;
  --surface2: #1a1f2b;
  --border: #252b3a;
  --accent: #00e5ff;
  --accent2: #ff4d6d;
  --accent3: #a8ff3e;
  --text: #e8eaf0;
  --muted: #6b7394;
  --gold: #ffd166;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  min-height: 100vh;
  overflow-x: hidden;
}
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image:
    linear-gradient(rgba(0,229,255,0.025) 1px, transparent 1px),
    linear-gradient(90deg, rgba(0,229,255,0.025) 1px, transparent 1px);
  background-size: 40px 40px;
  pointer-events: none;
  z-index: 0;
}
.app { position: relative; z-index: 1; max-width: 1280px; margin: 0 auto; padding: 0 16px 60px; }

/* HEADER */
header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 20px 0 16px;
  border-bottom: 1px solid var(--border);
  margin-bottom: 20px;
  flex-wrap: wrap; gap: 12px;
}
.logo-area h1 {
  font-family: 'Bebas Neue', sans-serif;
  font-size: clamp(24px,4vw,38px);
  letter-spacing: 3px; color: var(--accent); line-height: 1;
}
.logo-area p { font-size: 11px; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; margin-top: 3px; font-family: 'DM Mono', monospace; }
.pulse-dot { width:8px;height:8px;border-radius:50%;background:var(--accent3);box-shadow:0 0 8px var(--accent3);animation:pulse 2s infinite;display:inline-block;margin-right:6px; }
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.date-badge { font-family:'DM Mono',monospace;font-size:12px;color:var(--muted);background:var(--surface);border:1px solid var(--border);padding:6px 14px;border-radius:6px; }

/* TABS */
.tabs {
  display: flex; gap: 3px; margin-bottom: 20px;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 10px; padding: 4px; overflow-x: auto; flex-wrap: nowrap;
}
.tab-btn {
  flex-shrink: 0; padding: 9px 13px; border: none; background: transparent;
  color: var(--muted); font-family: 'DM Sans', sans-serif; font-size: 12px;
  font-weight: 500; cursor: pointer; border-radius: 7px; transition: all .2s;
  white-space: nowrap;
}
.tab-btn:hover { color: var(--text); background: var(--surface2); }
.tab-btn.active { background: var(--accent); color: #000; font-weight: 700; box-shadow: 0 0 16px rgba(0,229,255,.3); }

/* PANELS */
.panel { display: none; animation: fadeIn .3s ease; }
.panel.active { display: block; }
@keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:none}}

/* SECTION TITLE */
.section-title {
  font-family: 'Bebas Neue', sans-serif; font-size: 18px;
  letter-spacing: 2px; color: var(--accent); margin-bottom: 14px;
  display: flex; align-items: center; gap: 8px;
}
.section-title span { color: var(--muted); font-size: 12px; font-family: 'DM Sans', sans-serif; letter-spacing: 0; font-weight: 400; }

/* GRIDS */
.grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px,1fr)); gap: 14px; margin-bottom: 18px; }
.grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap: 14px; margin-bottom: 18px; }
.grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(170px,1fr)); gap: 12px; margin-bottom: 18px; }

/* CARD */
.card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 18px; transition: border-color .2s; }
.card:hover { border-color: rgba(0,229,255,.2); }

/* STAT CARDS */
.stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 16px; position: relative; overflow: hidden; transition: transform .2s, border-color .2s; }
.stat-card:hover { transform: translateY(-2px); border-color: rgba(0,229,255,.35); }
.stat-card::after { content:'';position:absolute;bottom:0;left:0;right:0;height:3px; }
.stat-card.cyan::after{background:var(--accent)} .stat-card.red::after{background:var(--accent2)}
.stat-card.green::after{background:var(--accent3)} .stat-card.gold::after{background:var(--gold)}
.stat-card.purple::after{background:#c084fc}
.stat-label { font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;font-family:'DM Mono',monospace;margin-bottom:6px; }
.stat-value { font-family:'Bebas Neue',sans-serif;font-size:36px;letter-spacing:1px;line-height:1; }
.stat-value.cyan{color:var(--accent)} .stat-value.red{color:var(--accent2)}
.stat-value.green{color:var(--accent3)} .stat-value.gold{color:var(--gold)} .stat-value.purple{color:#c084fc}
.stat-sub{font-size:12px;color:var(--muted);margin-top:5px}
.stat-sub.up{color:var(--accent3)} .stat-sub.down{color:var(--accent2)}

/* INPUTS */
input[type="text"],input[type="number"],input[type="date"],input[type="time"],select,textarea {
  background:var(--surface2);border:1px solid var(--border);border-radius:8px;
  color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;
  padding:9px 12px;width:100%;outline:none;transition:border-color .2s;
}
input:focus,select:focus,textarea:focus{border-color:var(--accent)}
input::placeholder,textarea::placeholder{color:var(--muted)}
input[type="file"]{background:var(--surface2);border:1px dashed var(--border);border-radius:8px;color:var(--muted);font-size:13px;padding:10px 12px;width:100%;cursor:pointer;}
input[type="file"]:hover{border-color:var(--accent)}

.input-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;font-family:'DM Mono',monospace;margin-bottom:5px}

/* BUTTONS */
.btn{border:none;border-radius:8px;padding:9px 16px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:var(--accent);color:#000}
.btn-primary:hover{box-shadow:0 0 18px rgba(0,229,255,.4);transform:translateY(-1px)}
.btn-danger{background:transparent;border:1px solid var(--accent2);color:var(--accent2);padding:5px 10px;font-size:12px;border-radius:6px}
.btn-danger:hover{background:var(--accent2);color:#fff}
.btn-ghost{background:transparent;border:1px solid var(--border);color:var(--muted)}
.btn-ghost:hover{border-color:var(--accent);color:var(--accent)}
.btn-green{background:var(--accent3);color:#000}
.btn-sm{padding:5px 11px;font-size:12px}

/* BADGES */
.badge{padding:3px 8px;border-radius:4px;font-size:10px;font-family:'DM Mono',monospace;font-weight:600;text-transform:uppercase;letter-spacing:1px}
.badge-red{background:rgba(255,77,109,.15);color:var(--accent2);border:1px solid rgba(255,77,109,.3)}
.badge-gold{background:rgba(255,209,102,.15);color:var(--gold);border:1px solid rgba(255,209,102,.3)}
.badge-green{background:rgba(168,255,62,.1);color:var(--accent3);border:1px solid rgba(168,255,62,.25)}
.badge-cyan{background:rgba(0,229,255,.1);color:var(--accent);border:1px solid rgba(0,229,255,.25)}
.badge-purple{background:rgba(192,132,252,.15);color:#c084fc;border:1px solid rgba(192,132,252,.3)}

/* FILTER ROW */
.filter-row{display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap}
.filter-chip{padding:5px 12px;border-radius:20px;font-size:12px;font-weight:500;cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--muted);transition:all .15s}
.filter-chip.active-chip{border-color:var(--accent);color:var(--accent);background:rgba(0,229,255,.08)}

/* PROGRESS */
.progress-bar{height:6px;background:var(--surface2);border-radius:3px;overflow:hidden;margin-top:8px}
.progress-fill{height:100%;background:var(--accent3);border-radius:3px;transition:width .4s ease}

/* TODO */
.todo-input-row{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap}
.todo-list{display:flex;flex-direction:column;gap:6px}
.todo-item{display:flex;align-items:center;gap:10px;padding:11px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;transition:all .2s}
.todo-item:hover{border-color:rgba(0,229,255,.2)}
.todo-item.done{opacity:.4}
.todo-item.done .todo-text{text-decoration:line-through;color:var(--muted)}
.todo-check{width:18px;height:18px;border-radius:4px;border:2px solid var(--border);cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all .2s;background:transparent}
.todo-check.checked{background:var(--accent3);border-color:var(--accent3)}
.todo-check.checked::after{content:'âœ“';font-size:11px;color:#000;font-weight:700}
.todo-text{flex:1;font-size:14px}
.todo-priority{font-size:10px;font-family:'DM Mono',monospace;padding:2px 7px;border-radius:4px;text-transform:uppercase;letter-spacing:1px}
.prio-high{background:rgba(255,77,109,.15);color:var(--accent2);border:1px solid rgba(255,77,109,.3)}
.prio-mid{background:rgba(255,209,102,.15);color:var(--gold);border:1px solid rgba(255,209,102,.3)}
.prio-low{background:rgba(168,255,62,.1);color:var(--accent3);border:1px solid rgba(168,255,62,.25)}

/* LINKS */
.links-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
.link-card{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:16px 14px;text-align:center;cursor:pointer;transition:all .2s;text-decoration:none;display:block}
.link-card:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,229,255,.1)}
.link-icon{font-size:26px;margin-bottom:8px}
.link-name{font-size:12px;font-weight:600;color:var(--text);letter-spacing:.3px}
.link-desc{font-size:10px;color:var(--muted);margin-top:2px}

/* REVENUE CHART */
.chart-row{display:flex;align-items:center;gap:10px;margin-bottom:8px;font-size:13px}
.chart-label{width:70px;color:var(--muted);font-family:'DM Mono',monospace;font-size:11px}
.chart-bar-bg{flex:1;height:22px;background:var(--surface2);border-radius:4px;overflow:hidden}
.chart-bar{height:100%;border-radius:4px;display:flex;align-items:center;padding-left:8px;font-size:11px;font-weight:600;transition:width .6s ease}
.chart-val{width:60px;text-align:right;font-family:'DM Mono',monospace;font-size:12px;color:var(--muted)}
.metric-input-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}

/* OUTREACH */
.outreach-card{display:flex;align-items:center;gap:12px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:13px;margin-bottom:8px}
.avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:#000;flex-shrink:0}
.outreach-info{flex:1}
.outreach-name{font-size:14px;font-weight:600}
.outreach-meta{font-size:11px;color:var(--muted);margin-top:2px;font-family:'DM Mono',monospace}

/* CONVO NOTES */
.cn-card{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:15px;margin-bottom:10px;transition:border-color .2s}
.cn-card:hover{border-color:rgba(0,229,255,.25)}
.cn-card-header{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:8px}
.cn-person{font-size:15px;font-weight:600;flex:1}
.cn-body-text{font-size:13px;color:var(--muted);line-height:1.6;white-space:pre-wrap}
.cn-meta{font-size:11px;color:var(--muted);font-family:'DM Mono',monospace;margin-top:6px}

/* DOCS */
.doc-card{display:flex;align-items:center;gap:14px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:13px 16px;margin-bottom:8px;transition:border-color .2s}
.doc-card:hover{border-color:rgba(0,229,255,.3)}
.doc-icon{font-size:28px;flex-shrink:0}
.doc-info{flex:1}
.doc-name{font-size:14px;font-weight:600}
.doc-meta{font-size:11px;color:var(--muted);font-family:'DM Mono',monospace;margin-top:3px}

/* NOTES */
.notes-area{width:100%;min-height:130px;resize:vertical}

/* STAFF */
.staff-card{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px;transition:all .2s;cursor:pointer}
.staff-card:hover{border-color:rgba(0,229,255,.3);transform:translateY(-1px)}
.staff-header{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.staff-avatar{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;color:#000;flex-shrink:0}
.staff-name{font-size:14px;font-weight:600}
.staff-role{font-size:11px;color:var(--muted);margin-top:1px}
.staff-stats{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.staff-stat{font-size:11px;font-family:'DM Mono',monospace;color:var(--muted)}

/* SHIFT HANDOFF */
.handoff-card{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:15px;margin-bottom:10px}
.handoff-header{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px}
.handoff-section{margin-bottom:10px}
.handoff-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;font-family:'DM Mono',monospace;margin-bottom:4px}
.handoff-text{font-size:13px;line-height:1.6;white-space:pre-wrap}

/* TRAINING TRIP */
.trip-card{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:15px;margin-bottom:10px;transition:border-color .2s}
.trip-card:hover{border-color:rgba(0,229,255,.25)}
.trip-header{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px}
.trip-title{font-size:15px;font-weight:600;flex:1}
.trainee-row{display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px solid var(--border)}
.trainee-row:last-child{border-bottom:none}
.trainee-name{flex:1;font-size:13px}
.trainee-check{width:16px;height:16px;border-radius:3px;border:2px solid var(--border);cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all .2s}
.trainee-check.checked{background:var(--accent3);border-color:var(--accent3)}
.trainee-check.checked::after{content:'âœ“';font-size:9px;color:#000;font-weight:700}

/* WHO'S WORKING */
.whos-working{background:var(--surface);border:1px solid var(--accent);border-radius:12px;padding:18px;margin-bottom:20px;box-shadow:0 0 30px rgba(0,229,255,.07)}
.whos-working h2{font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:2px;color:var(--accent);margin-bottom:12px;display:flex;align-items:center;gap:8px}
.shift-pill{display:inline-flex;align-items:center;gap:6px;background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:5px 12px;font-size:12px;margin:3px;transition:all .2s}
.shift-pill:hover{border-color:var(--accent)}
.shift-pill .sp-name{font-weight:600}
.shift-pill .sp-time{color:var(--muted);font-family:'DM Mono',monospace;font-size:11px}
.schedule-drop-zone{border:2px dashed var(--border);border-radius:10px;padding:28px;text-align:center;cursor:pointer;transition:all .2s;margin-bottom:14px;position:relative}
.schedule-drop-zone:hover,.schedule-drop-zone.drag-over{border-color:var(--accent);background:rgba(0,229,255,.04)}
.schedule-drop-zone p{color:var(--muted);font-size:13px;margin-top:6px}
.schedule-drop-zone .drop-icon{font-size:32px}

/* AI Loading */
.ai-loading{display:flex;align-items:center;gap:8px;color:var(--accent);font-size:13px;padding:12px}
.spinner{width:16px;height:16px;border:2px solid rgba(0,229,255,.2);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;display:flex;align-items:center;justify-content:center;padding:16px;backdrop-filter:blur(4px)}
.modal-overlay.hidden{display:none}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:24px;width:100%;max-width:560px;max-height:85vh;overflow-y:auto}
.modal h3{font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:2px;color:var(--accent);margin-bottom:18px}
.modal-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}
.modal-footer{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}

/* DIVIDER */
.divider{border:none;border-top:1px solid var(--border);margin:18px 0}

/* iOS INSTALL BANNER */
.install-banner {
  display: none;
  background: linear-gradient(135deg, rgba(0,229,255,.15), rgba(168,255,62,.1));
  border: 1px solid rgba(0,229,255,.3);
  border-radius: 10px;
  padding: 12px 16px;
  margin-bottom: 16px;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}
.install-banner.visible { display: flex; }
.install-banner p { flex: 1; font-size: 13px; color: var(--text); min-width: 200px; }
.install-banner p strong { color: var(--accent); }


::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

@media(max-width:600px){
  .metric-input-grid,.modal-grid{grid-template-columns:1fr}
  .grid-4{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>
<!-- SYNC SETUP SCREEN -->
<div id="loginScreen" style="position:fixed;inset:0;background:var(--bg);z-index:200;display:flex;align-items:center;justify-content:center;padding:24px;">
  <div style="width:100%;max-width:400px">
    <div style="text-align:center;margin-bottom:32px">
      <div style="font-family:'Bebas Neue',sans-serif;font-size:48px;letter-spacing:4px;color:var(--accent)">ACTIVATE HQ</div>
      <div style="font-size:12px;color:var(--muted);letter-spacing:2px;text-transform:uppercase;font-family:'DM Mono',monospace;margin-top:4px">Lexington Command Center</div>
    </div>
    <div id="loginError" style="display:none;border-radius:8px;padding:10px 14px;font-size:13px;margin-bottom:14px"></div>
    <div style="margin-bottom:20px">
      <div class="input-label" style="margin-bottom:5px">Sync Key</div>
      <input type="password" id="loginPassword" placeholder="Enter your sync key (min 6 chars)" onkeydown="if(event.key==='Enter')handleLogin()">
      <div style="font-size:11px;color:var(--muted);margin-top:6px;font-family:'DM Mono',monospace">Same key on all your devices = shared data</div>
    </div>
    <button class="btn btn-primary" style="width:100%;justify-content:center;padding:13px" onclick="handleLogin()" id="loginBtn">Connect â†’</button>
    <div style="text-align:center;margin-top:14px;font-size:12px;color:var(--muted);font-family:'DM Mono',monospace">First time? Just enter any key you'll remember.<br>Use the same key on your iPhone to sync.</div>
  </div>
</div>

<div class="app">

<!-- SYNC STATUS BAR -->
<div id="syncBar" style="display:none;align-items:center;gap:8px;padding:6px 12px;background:var(--surface);border:1px solid var(--border);border-radius:8px;margin-bottom:12px;font-size:12px;font-family:'DM Mono',monospace">
  <div id="syncDot" style="width:8px;height:8px;border-radius:50%;background:var(--accent3);flex-shrink:0"></div>
  <span id="syncMsg" style="color:var(--muted);flex:1">Synced</span>
  <span id="syncUser" style="color:var(--muted)"></span>
  <button onclick="handleSignOut()" style="background:none;border:none;color:var(--accent2);font-size:11px;cursor:pointer;font-family:'DM Mono',monospace">Sign Out</button>
</div>

<!-- HEADER -->
<header>
  <div class="logo-area">
    <h1>Activate HQ</h1>
    <p><span class="pulse-dot"></span>Lexington Command Center</p>
  </div>
  <div>
    <div class="date-badge" id="dateBadge"></div>
  </div>
</header>

<!-- iOS INSTALL BANNER -->
<div class="install-banner" id="installBanner">
  <span style="font-size:24px">ğŸ“²</span>
  <p><strong>Install Activate HQ on your iPhone!</strong> Tap the Share button in Safari, then tap <strong>"Add to Home Screen"</strong> to use this as a full-screen app.</p>
  <button class="btn btn-ghost btn-sm" onclick="dismissBanner()">Dismiss</button>
</div>

<!-- TABS -->
<div class="tabs">
  <button class="tab-btn active" onclick="switchTab('home')">ğŸ  Home</button>
  <button class="tab-btn" onclick="switchTab('tasks')">âœ… Tasks</button>
  <button class="tab-btn" onclick="switchTab('convonotes')">ğŸ’¬ Conv. Notes</button>
  <button class="tab-btn" onclick="switchTab('revenue')">ğŸ“Š Revenue</button>
  <button class="tab-btn" onclick="switchTab('staff')">ğŸ‘¥ Staff</button>
  <button class="tab-btn" onclick="switchTab('handoff')">ğŸ“‹ Shift Handoff</button>
  <button class="tab-btn" onclick="switchTab('trips')">âœˆï¸ Training Trips</button>
  <button class="tab-btn" onclick="switchTab('links')">ğŸ”— Quick Links</button>
  <button class="tab-btn" onclick="switchTab('docs')">ğŸ“‚ Docs</button>
  <button class="tab-btn" onclick="switchTab('outreach')">ğŸ® Outreach</button>
  <button class="tab-btn" onclick="switchTab('notes')">ğŸ“ Notes</button>
  <button class="tab-btn" onclick="switchTab('export')">ğŸ’¾ Export</button>
</div>

<!-- ===== HOME PANEL ===== -->
<div id="panel-home" class="panel active">

  <!-- WHO'S WORKING TODAY -->
  <div class="whos-working">
    <h2>ğŸ‘· Who's Working Today <span id="todayDateLabel" style="font-size:12px;color:var(--muted);font-family:'DM Mono',monospace;font-weight:400;letter-spacing:1px"></span></h2>
    <div id="whosWorkingDisplay">
      <div style="color:var(--muted);font-size:13px">No schedule loaded yet â€” upload your ADP screenshot in the Schedule tab or below.</div>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn btn-ghost btn-sm" onclick="switchTab('schedule')">ğŸ“¸ Upload Schedule</button>
      <button class="btn btn-ghost btn-sm" onclick="switchTab('staff')">ğŸ‘¥ Manage Staff</button>
    </div>
  </div>

  <!-- QUICK STATS -->
  <div class="grid-4">
    <div class="stat-card cyan">
      <div class="stat-label">Tasks Today</div>
      <div class="stat-value cyan" id="home-tasks">0</div>
      <div class="stat-sub" id="home-tasks-sub">pending</div>
    </div>
    <div class="stat-card green">
      <div class="stat-label">On Shift Today</div>
      <div class="stat-value green" id="home-staff">0</div>
      <div class="stat-sub">staff members</div>
    </div>
    <div class="stat-card gold">
      <div class="stat-label">Open Conv. Notes</div>
      <div class="stat-value gold" id="home-cn">0</div>
      <div class="stat-sub">need follow-up</div>
    </div>
    <div class="stat-card red">
      <div class="stat-label">Outreach Due</div>
      <div class="stat-value red" id="home-out">0</div>
      <div class="stat-sub">return players</div>
    </div>
  </div>

  <!-- QUICK TODO -->
  <div class="card">
    <div class="section-title" style="font-size:15px;margin-bottom:10px">âš¡ Quick Add Task</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <input type="text" id="home-todo-input" placeholder="Add a quick task..." style="flex:1;min-width:180px" onkeydown="if(event.key==='Enter')homeAddTodo()">
      <select id="home-todo-prio" style="width:100px">
        <option value="high">ğŸ”´ High</option>
        <option value="mid" selected>ğŸŸ¡ Mid</option>
        <option value="low">ğŸŸ¢ Low</option>
      </select>
      <button class="btn btn-primary" onclick="homeAddTodo()">+ Add</button>
    </div>
    <div style="margin-top:12px" id="home-todo-preview"></div>
  </div>
</div>

<!-- ===== SCHEDULE / AI READER PANEL ===== -->
<div id="panel-schedule" class="panel">
  <div class="section-title">Schedule Reader <span>â€” drop your ADP screenshot, AI extracts the roster</span></div>

  <div class="card" style="margin-bottom:16px">
    <div class="schedule-drop-zone" id="dropZone" onclick="document.getElementById('schedFileInput').click()"
      ondragover="event.preventDefault();this.classList.add('drag-over')"
      ondragleave="this.classList.remove('drag-over')"
      ondrop="handleSchedDrop(event)">
      <div class="drop-icon">ğŸ“¸</div>
      <div style="font-size:15px;font-weight:600;margin-top:8px">Drop ADP Schedule Screenshot Here</div>
      <p>or click to browse â€” PNG, JPG supported</p>
      <input type="file" id="schedFileInput" accept="image/*" style="display:none" onchange="handleSchedFile(this)">
    </div>
    <div style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap">
      <div style="flex:1;min-width:140px">
        <div class="input-label">Schedule Week Start</div>
        <input type="date" id="sched-week-start">
      </div>
      <div style="font-size:12px;color:var(--muted);padding-bottom:10px;flex:2">
        After uploading, AI will read the image and extract staff names + shift times. Review and save.
      </div>
    </div>
  </div>

  <div id="schedPreviewArea"></div>

  <div id="savedSchedules">
    <div class="section-title" style="font-size:15px;margin-top:8px">Saved Schedules</div>
    <div id="savedSchedList"></div>
  </div>
</div>

<!-- ===== TASKS PANEL ===== -->
<div id="panel-tasks" class="panel">
  <div class="grid-4">
    <div class="stat-card cyan"><div class="stat-label">Total Tasks</div><div class="stat-value cyan" id="stat-total">0</div><div class="stat-sub">today's list</div></div>
    <div class="stat-card green"><div class="stat-label">Completed</div><div class="stat-value green" id="stat-done">0</div><div class="stat-sub">knocked out</div></div>
    <div class="stat-card red"><div class="stat-label">High Priority</div><div class="stat-value red" id="stat-high">0</div><div class="stat-sub">needs attention</div></div>
    <div class="stat-card gold"><div class="stat-label">Completion</div><div class="stat-value gold" id="stat-pct">0%</div><div class="stat-sub">keep going!</div></div>
  </div>
  <div class="card">
    <div class="progress-bar" style="margin-bottom:18px;height:8px"><div class="progress-fill" id="taskProgress" style="width:0%"></div></div>
    <div class="todo-input-row">
      <input type="text" id="todoInput" placeholder="Add a task..." onkeydown="if(event.key==='Enter')addTodo()" style="flex:1;min-width:160px">
      <select id="todoCategory" style="width:110px">
        <option value="ops">ğŸ¢ Ops</option>
        <option value="hr">ğŸ‘¤ HR/Staff</option>
        <option value="hospitality">ğŸ® Guest Exp</option>
        <option value="training">ğŸ“‹ Training</option>
        <option value="admin">âš™ï¸ Admin</option>
      </select>
      <select id="todoPriority" style="width:100px">
        <option value="high">ğŸ”´ High</option>
        <option value="mid">ğŸŸ¡ Mid</option>
        <option value="low">ğŸŸ¢ Low</option>
      </select>
      <button class="btn btn-primary" onclick="addTodo()">+ Add</button>
    </div>
    <div class="filter-row">
      <button class="filter-chip active-chip" onclick="setFilter('all',this)">All</button>
      <button class="filter-chip" onclick="setFilter('high',this)">ğŸ”´ High</button>
      <button class="filter-chip" onclick="setFilter('mid',this)">ğŸŸ¡ Mid</button>
      <button class="filter-chip" onclick="setFilter('low',this)">ğŸŸ¢ Low</button>
      <button class="filter-chip" onclick="setFilter('active',this)">Active</button>
      <button class="filter-chip" onclick="setFilter('done',this)">Done</button>
      <button class="filter-chip" onclick="clearDone()" style="margin-left:auto">ğŸ—‘ Clear Done</button>
    </div>
    <div class="todo-list" id="todoList"></div>
  </div>
</div>

<!-- ===== CONV NOTES PANEL ===== -->
<div id="panel-convonotes" class="panel">
  <div class="section-title">Conversation Notes <span>â€” meetings, coaching, HR actions</span></div>
  <div class="card" style="margin-bottom:16px">
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(175px,1fr));gap:10px;margin-bottom:12px">
      <div><div class="input-label">Person / Topic</div><input type="text" id="cn-person" placeholder="Name or subject"></div>
      <div><div class="input-label">Date</div><input type="date" id="cn-date"></div>
      <div><div class="input-label">Type</div>
        <select id="cn-type">
          <option value="meeting">ğŸ“… Meeting Recap</option>
          <option value="coaching">ğŸ¯ Coaching</option>
          <option value="verbal">ğŸ—£ Verbal Warning</option>
          <option value="written">ğŸ“„ Written Warning</option>
          <option value="boss">â¬†ï¸ Leadership</option>
          <option value="followup">ğŸ” Follow-Up</option>
          <option value="other">ğŸ’¬ Other</option>
        </select>
      </div>
      <div><div class="input-label">Status</div>
        <select id="cn-status">
          <option value="open">ğŸŸ¡ Open</option>
          <option value="resolved">âœ… Resolved</option>
          <option value="pending">â³ Pending Action</option>
        </select>
      </div>
    </div>
    <div style="margin-bottom:10px"><div class="input-label" style="margin-bottom:5px">Notes / Summary</div>
      <textarea id="cn-body" placeholder="Summarize the conversation, decisions made, next steps..." style="min-height:85px;resize:vertical;width:100%"></textarea>
    </div>
    <button class="btn btn-primary" onclick="addConvoNote()">+ Add Note</button>
  </div>
  <div class="filter-row" id="cn-filters">
    <button class="filter-chip active-chip" onclick="setCNFilter('all',this)">All</button>
    <button class="filter-chip" onclick="setCNFilter('meeting',this)">ğŸ“… Meetings</button>
    <button class="filter-chip" onclick="setCNFilter('coaching',this)">ğŸ¯ Coaching</button>
    <button class="filter-chip" onclick="setCNFilter('verbal',this)">ğŸ—£ Verbal</button>
    <button class="filter-chip" onclick="setCNFilter('written',this)">ğŸ“„ Written</button>
    <button class="filter-chip" onclick="setCNFilter('boss',this)">â¬†ï¸ Leadership</button>
    <button class="filter-chip" onclick="setCNFilter('open',this)">ğŸŸ¡ Open</button>
    <button class="filter-chip" onclick="setCNFilter('resolved',this)">âœ… Resolved</button>
  </div>
  <div id="convoNotesList"></div>
</div>

<!-- ===== REVENUE PANEL ===== -->
<div id="panel-revenue" class="panel">
  <div class="grid-4">
    <div class="stat-card cyan"><div class="stat-label">Today Revenue</div><div class="stat-value cyan" id="rev-today-display">$0</div><div class="stat-sub" id="rev-vs-goal">â€” set a goal</div></div>
    <div class="stat-card green"><div class="stat-label">Guest Count</div><div class="stat-value green" id="guests-today-display">0</div><div class="stat-sub" id="guests-avg">avg / day</div></div>
    <div class="stat-card gold"><div class="stat-label">Rev / Guest</div><div class="stat-value gold" id="rev-per-guest">$0</div><div class="stat-sub">spend per head</div></div>
    <div class="stat-card red"><div class="stat-label">Return Players</div><div class="stat-value red" id="return-count">0</div><div class="stat-sub">this week</div></div>
  </div>
  <div class="grid-2">
    <div class="card">
      <div class="section-title" style="font-size:15px">Log Today's Numbers</div>
      <div class="metric-input-grid">
        <div><div class="input-label">Revenue ($)</div><input type="number" id="inp-rev" placeholder="0.00" oninput="updateRevMetrics()"></div>
        <div><div class="input-label">Guest Count</div><input type="number" id="inp-guests" placeholder="0" oninput="updateRevMetrics()"></div>
        <div><div class="input-label">Daily Goal ($)</div><input type="number" id="inp-goal" placeholder="0.00" oninput="updateRevMetrics()"></div>
        <div><div class="input-label">Return Players</div><input type="number" id="inp-return" placeholder="0" oninput="updateRevMetrics()"></div>
      </div>
      <div class="input-label" style="margin-bottom:5px">Date</div>
      <div style="display:flex;gap:8px">
        <input type="date" id="inp-date" style="flex:1">
        <button class="btn btn-primary" onclick="logDay()">Log Day</button>
      </div>
    </div>
    <div class="card">
      <div class="section-title" style="font-size:15px">Weekly Overview</div>
      <div class="chart-bar-wrap" id="weekChart"></div>
    </div>
  </div>
</div>

<!-- ===== STAFF PANEL ===== -->
<div id="panel-staff" class="panel">
  <div class="section-title">Staff Directory <span>â€” performance & profile tracker</span></div>
  <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;align-items:center">
    <button class="btn btn-primary" onclick="openStaffModal()">+ Add Staff Member</button>
    <input type="text" id="staffSearch" placeholder="Search by name or role..." style="flex:1;min-width:180px" oninput="renderStaff()">
  </div>
  <div class="grid-3" id="staffGrid"></div>
</div>

<!-- ===== SHIFT HANDOFF PANEL ===== -->
<div id="panel-handoff" class="panel">
  <div class="section-title">Shift Handoff Log <span>â€” end-of-shift notes for the next manager</span></div>
  <div class="card" style="margin-bottom:16px">
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(175px,1fr));gap:10px;margin-bottom:12px">
      <div><div class="input-label">Date</div><input type="date" id="ho-date"></div>
      <div><div class="input-label">Shift</div>
        <select id="ho-shift">
          <option value="open">ğŸŒ… Opening</option>
          <option value="mid">â˜€ï¸ Mid</option>
          <option value="close">ğŸŒ™ Closing</option>
        </select>
      </div>
      <div><div class="input-label">Manager on Duty</div><input type="text" id="ho-mod" placeholder="Your name"></div>
      <div><div class="input-label">Revenue ($)</div><input type="number" id="ho-rev" placeholder="0.00"></div>
      <div><div class="input-label">Guest Count</div><input type="number" id="ho-guests" placeholder="0"></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
      <div>
        <div class="input-label" style="margin-bottom:5px">Guest Highlights / Issues</div>
        <textarea id="ho-guests-notes" placeholder="Notable guest experiences, complaints, WOW moments..." style="min-height:80px;resize:vertical;width:100%"></textarea>
      </div>
      <div>
        <div class="input-label" style="margin-bottom:5px">Equipment / Maintenance</div>
        <textarea id="ho-maint" placeholder="Any equipment issues, MaintainX tickets opened..." style="min-height:80px;resize:vertical;width:100%"></textarea>
      </div>
      <div>
        <div class="input-label" style="margin-bottom:5px">Staff Notes</div>
        <textarea id="ho-staff-notes" placeholder="Attendance, performance, coaching moments..." style="min-height:80px;resize:vertical;width:100%"></textarea>
      </div>
      <div>
        <div class="input-label" style="margin-bottom:5px">Action Items for Next Shift</div>
        <textarea id="ho-actions" placeholder="What needs to happen before or during the next shift..." style="min-height:80px;resize:vertical;width:100%"></textarea>
      </div>
    </div>
    <button class="btn btn-primary" onclick="saveHandoff()">ğŸ“‹ Save Handoff</button>
  </div>
  <div class="filter-row" id="ho-filters">
    <button class="filter-chip active-chip" onclick="setHOFilter('all',this)">All</button>
    <button class="filter-chip" onclick="setHOFilter('open',this)">ğŸŒ… Opening</button>
    <button class="filter-chip" onclick="setHOFilter('mid',this)">â˜€ï¸ Mid</button>
    <button class="filter-chip" onclick="setHOFilter('close',this)">ğŸŒ™ Closing</button>
  </div>
  <div id="handoffList"></div>
</div>

<!-- ===== TRAINING TRIPS PANEL ===== -->
<div id="panel-trips" class="panel">
  <div class="section-title">Training Trips <span>â€” location openings & GM training tracker</span></div>
  <div class="card" style="margin-bottom:16px">
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(175px,1fr));gap:10px;margin-bottom:12px">
      <div><div class="input-label">Location / City</div><input type="text" id="trip-loc" placeholder="e.g. Nashville, TN"></div>
      <div><div class="input-label">Trip Type</div>
        <select id="trip-type">
          <option value="opening">ğŸª New Location Opening</option>
          <option value="gm">ğŸ‘¤ GM Training</option>
          <option value="support">ğŸ¤ Support Visit</option>
        </select>
      </div>
      <div><div class="input-label">Start Date</div><input type="date" id="trip-start"></div>
      <div><div class="input-label">End Date</div><input type="date" id="trip-end"></div>
      <div style="grid-column:1/-1"><div class="input-label">Notes</div><input type="text" id="trip-notes" placeholder="Hotel, contact person, special focus areas..."></div>
    </div>
    <div style="margin-bottom:12px">
      <div class="input-label" style="margin-bottom:5px">Trainees (one per line)</div>
      <textarea id="trip-trainees" placeholder="John Smith&#10;Jane Doe&#10;..." style="min-height:80px;resize:vertical;width:100%"></textarea>
    </div>
    <button class="btn btn-primary" onclick="addTrip()">+ Add Trip</button>
  </div>
  <div class="filter-row" id="trip-filters">
    <button class="filter-chip active-chip" onclick="setTripFilter('all',this)">All</button>
    <button class="filter-chip" onclick="setTripFilter('upcoming',this)">ğŸ—“ Upcoming</button>
    <button class="filter-chip" onclick="setTripFilter('opening',this)">ğŸª Openings</button>
    <button class="filter-chip" onclick="setTripFilter('gm',this)">ğŸ‘¤ GM Training</button>
    <button class="filter-chip" onclick="setTripFilter('complete',this)">âœ… Complete</button>
  </div>
  <div id="tripsList"></div>
</div>

<!-- ===== LINKS PANEL ===== -->
<div id="panel-links" class="panel">
  <div class="section-title">Quick Links <span>â€” click to open in new tab</span></div>
  <div class="links-grid" id="linksGrid"></div>
  <hr class="divider">
  <div class="section-title" style="font-size:15px">Add Custom Link</div>
  <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end">
    <div style="flex:1;min-width:130px"><div class="input-label">Name</div><input type="text" id="link-name" placeholder="My Tool"></div>
    <div style="flex:2;min-width:190px"><div class="input-label">URL</div><input type="text" id="link-url" placeholder="https://..."></div>
    <div style="flex:1;min-width:110px"><div class="input-label">Icon (emoji)</div><input type="text" id="link-icon" placeholder="ğŸ”§"></div>
    <div style="flex:1;min-width:110px"><div class="input-label">Description</div><input type="text" id="link-desc" placeholder="What it does"></div>
    <button class="btn btn-primary" onclick="addCustomLink()">+ Add</button>
  </div>
</div>

<!-- ===== DOCS PANEL ===== -->
<div id="panel-docs" class="panel">
  <div class="section-title">Docs & References <span>â€” upload files for quick access</span></div>
  <div class="card" style="margin-bottom:18px">
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(175px,1fr));gap:10px;margin-bottom:12px">
      <div style="grid-column:1/-1"><div class="input-label" style="margin-bottom:5px">Upload File</div>
        <input type="file" id="doc-file" accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg,.txt,.csv,.ppt,.pptx">
      </div>
      <div><div class="input-label">Label / Title</div><input type="text" id="doc-name" placeholder="e.g. Opening Checklist"></div>
      <div><div class="input-label">Category</div>
        <select id="doc-cat">
          <option value="ops">ğŸ¢ Operations</option>
          <option value="training">ğŸ“‹ Training</option>
          <option value="hr">ğŸ‘¤ HR / Staff</option>
          <option value="reference">ğŸ“Œ Quick Reference</option>
          <option value="travel">âœˆï¸ Travel</option>
          <option value="other">ğŸ“ Other</option>
        </select>
      </div>
    </div>
    <button class="btn btn-primary" onclick="uploadDoc()">ğŸ“ Save Document</button>
    <span style="font-size:11px;color:var(--muted);margin-left:10px">Stored locally in your browser</span>
  </div>
  <div class="filter-row" id="doc-filters">
    <button class="filter-chip active-chip" onclick="setDocFilter('all',this)">All</button>
    <button class="filter-chip" onclick="setDocFilter('ops',this)">ğŸ¢ Ops</button>
    <button class="filter-chip" onclick="setDocFilter('training',this)">ğŸ“‹ Training</button>
    <button class="filter-chip" onclick="setDocFilter('hr',this)">ğŸ‘¤ HR</button>
    <button class="filter-chip" onclick="setDocFilter('reference',this)">ğŸ“Œ Reference</button>
    <button class="filter-chip" onclick="setDocFilter('travel',this)">âœˆï¸ Travel</button>
  </div>
  <div id="docsList"></div>
</div>

<!-- ===== OUTREACH PANEL ===== -->
<div id="panel-outreach" class="panel">
  <div class="section-title">Return Player Outreach</div>
  <div class="card" style="margin-bottom:16px">
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;margin-bottom:12px">
      <div><div class="input-label">Player Name</div><input type="text" id="out-name" placeholder="Jane Smith"></div>
      <div><div class="input-label">Last Visit</div><input type="date" id="out-date"></div>
      <div><div class="input-label">Contact</div><input type="text" id="out-contact" placeholder="email or phone"></div>
      <div><div class="input-label">Status</div>
        <select id="out-status">
          <option value="due">ğŸ“¬ Due</option>
          <option value="overdue">ğŸ”´ Overdue</option>
          <option value="done">âœ… Contacted</option>
        </select>
      </div>
    </div>
    <button class="btn btn-primary" onclick="addOutreach()">+ Add Player</button>
  </div>
  <div id="outreachList"></div>
</div>

<!-- ===== NOTES PANEL ===== -->
<div id="panel-notes" class="panel">
  <div class="section-title">Quick Notes <span>â€” auto-saved locally</span></div>
  <div class="grid-2">
    <div class="card"><div class="input-label" style="margin-bottom:7px">Shift Notes / Daily Log</div>
      <textarea class="notes-area" id="note-shift" placeholder="Shift observations, guest feedback, incidents..."></textarea>
      <div style="display:flex;justify-content:flex-end;margin-top:8px"><button class="btn btn-primary btn-sm" onclick="saveNote('shift')">Save</button></div>
    </div>
    <div class="card"><div class="input-label" style="margin-bottom:7px">Training Notes</div>
      <textarea class="notes-area" id="note-training" placeholder="Trainee observations, coaching moments..."></textarea>
      <div style="display:flex;justify-content:flex-end;margin-top:8px"><button class="btn btn-primary btn-sm" onclick="saveNote('training')">Save</button></div>
    </div>
    <div class="card"><div class="input-label" style="margin-bottom:7px">GM Opening Checklist Notes</div>
      <textarea class="notes-area" id="note-opening" placeholder="Opening walk-through notes, equipment status..."></textarea>
      <div style="display:flex;justify-content:flex-end;margin-top:8px"><button class="btn btn-primary btn-sm" onclick="saveNote('opening')">Save</button></div>
    </div>
    <div class="card"><div class="input-label" style="margin-bottom:7px">Travel / Location Visit Notes</div>
      <textarea class="notes-area" id="note-travel" placeholder="Opening week notes, location-specific observations..."></textarea>
      <div style="display:flex;justify-content:flex-end;margin-top:8px"><button class="btn btn-primary btn-sm" onclick="saveNote('travel')">Save</button></div>
    </div>
  </div>
</div>

<!-- ===== EXPORT PANEL ===== -->
<div id="panel-export" class="panel">
  <div class="section-title">Export & Backup <span>â€” download your data for Google Sheets or safekeeping</span></div>

  <!-- FULL BACKUP -->
  <div class="card" style="margin-bottom:18px;border-color:rgba(0,229,255,.3)">
    <div style="display:flex;align-items:center;gap:14px;flex-wrap:wrap">
      <div style="font-size:32px">ğŸ—„ï¸</div>
      <div style="flex:1">
        <div style="font-size:15px;font-weight:600;margin-bottom:4px">Full Backup (JSON)</div>
        <div style="font-size:13px;color:var(--muted)">Exports everything â€” tasks, staff, notes, trips, revenue, outreach, handoffs, conversation notes. Use this to restore your data on a new browser or device.</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <button class="btn btn-primary" onclick="exportFullBackup()">â¬‡ Download Backup</button>
        <label class="btn btn-ghost" style="cursor:pointer;text-align:center">
          ğŸ“‚ Restore from Backup
          <input type="file" accept=".json" style="display:none" onchange="restoreBackup(this)">
        </label>
      </div>
    </div>
  </div>

  <!-- CSV EXPORTS -->
  <div class="section-title" style="font-size:15px">Export to CSV <span>â€” open directly in Google Sheets</span></div>
  <div style="font-size:13px;color:var(--muted);margin-bottom:14px">Download any dataset as a .csv file, then drag it into Google Sheets or go to <strong style="color:var(--text)">File â†’ Import</strong> in Sheets to load it.</div>

  <div class="grid-2">
    <div class="card" style="display:flex;align-items:center;gap:12px">
      <div style="font-size:28px">âœ…</div>
      <div style="flex:1">
        <div style="font-weight:600;margin-bottom:2px">Tasks</div>
        <div id="export-tasks-count" style="font-size:12px;color:var(--muted)"></div>
      </div>
      <button class="btn btn-ghost btn-sm" onclick="exportCSV('tasks')">â¬‡ CSV</button>
    </div>

    <div class="card" style="display:flex;align-items:center;gap:12px">
      <div style="font-size:28px">ğŸ’¬</div>
      <div style="flex:1">
        <div style="font-weight:600;margin-bottom:2px">Conversation Notes</div>
        <div id="export-cn-count" style="font-size:12px;color:var(--muted)"></div>
      </div>
      <button class="btn btn-ghost btn-sm" onclick="exportCSV('convonotes')">â¬‡ CSV</button>
    </div>

    <div class="card" style="display:flex;align-items:center;gap:12px">
      <div style="font-size:28px">ğŸ‘¥</div>
      <div style="flex:1">
        <div style="font-weight:600;margin-bottom:2px">Staff Directory</div>
        <div id="export-staff-count" style="font-size:12px;color:var(--muted)"></div>
      </div>
      <button class="btn btn-ghost btn-sm" onclick="exportCSV('staff')">â¬‡ CSV</button>
    </div>

    <div class="card" style="display:flex;align-items:center;gap:12px">
      <div style="font-size:28px">ğŸ“Š</div>
      <div style="flex:1">
        <div style="font-weight:600;margin-bottom:2px">Revenue Log</div>
        <div id="export-revenue-count" style="font-size:12px;color:var(--muted)"></div>
      </div>
      <button class="btn btn-ghost btn-sm" onclick="exportCSV('revenue')">â¬‡ CSV</button>
    </div>

    <div class="card" style="display:flex;align-items:center;gap:12px">
      <div style="font-size:28px">ğŸ“‹</div>
      <div style="flex:1">
        <div style="font-weight:600;margin-bottom:2px">Shift Handoffs</div>
        <div id="export-handoff-count" style="font-size:12px;color:var(--muted)"></div>
      </div>
      <button class="btn btn-ghost btn-sm" onclick="exportCSV('handoffs')">â¬‡ CSV</button>
    </div>

    <div class="card" style="display:flex;align-items:center;gap:12px">
      <div style="font-size:28px">âœˆï¸</div>
      <div style="flex:1">
        <div style="font-weight:600;margin-bottom:2px">Training Trips</div>
        <div id="export-trips-count" style="font-size:12px;color:var(--muted)"></div>
      </div>
      <button class="btn btn-ghost btn-sm" onclick="exportCSV('trips')">â¬‡ CSV</button>
    </div>

    <div class="card" style="display:flex;align-items:center;gap:12px">
      <div style="font-size:28px">ğŸ®</div>
      <div style="flex:1">
        <div style="font-weight:600;margin-bottom:2px">Return Player Outreach</div>
        <div id="export-outreach-count" style="font-size:12px;color:var(--muted)"></div>
      </div>
      <button class="btn btn-ghost btn-sm" onclick="exportCSV('outreach')">â¬‡ CSV</button>
    </div>

    <div class="card" style="display:flex;align-items:center;gap:12px">
      <div style="font-size:28px">ğŸ“…</div>
      <div style="flex:1">
        <div style="font-weight:600;margin-bottom:2px">Schedules</div>
        <div id="export-sched-count" style="font-size:12px;color:var(--muted)"></div>
      </div>
      <button class="btn btn-ghost btn-sm" onclick="exportCSV('schedules')">â¬‡ CSV</button>
    </div>
  </div>

  <!-- HOW TO USE IN SHEETS -->
  <div class="card" style="margin-top:6px;border-color:rgba(168,255,62,.2)">
    <div style="font-size:13px;font-weight:600;color:var(--accent3);margin-bottom:8px">ğŸ“‹ How to get this into Google Sheets</div>
    <div style="font-size:13px;color:var(--muted);line-height:1.8">
      1. Click any <strong style="color:var(--text)">â¬‡ CSV</strong> button to download that dataset<br>
      2. Open <strong style="color:var(--text)">Google Sheets</strong> â†’ create a new sheet<br>
      3. Go to <strong style="color:var(--text)">File â†’ Import â†’ Upload</strong> â†’ drag your CSV file in<br>
      4. Select <strong style="color:var(--text)">"Replace spreadsheet"</strong> or <strong style="color:var(--text)">"Insert new sheet"</strong><br>
      5. Your data is now live in Sheets â€” viewable from any device!
    </div>
  </div>
</div>


<div class="modal-overlay hidden" id="staffModal">
  <div class="modal">
    <h3 id="staffModalTitle">Add Staff Member</h3>
    <div class="modal-grid">
      <div><div class="input-label">Full Name</div><input type="text" id="sm-name" placeholder="Jane Smith"></div>
      <div><div class="input-label">Role</div>
        <select id="sm-role">
          <option value="Game Facilitator">Game Facilitator</option>
          <option value="Lead Facilitator">Lead Facilitator</option>
          <option value="Shift Supervisor">Shift Supervisor</option>
          <option value="Assistant GM">Assistant GM</option>
          <option value="GM in Training">GM in Training</option>
          <option value="Maintenance">Maintenance</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div><div class="input-label">Hire Date</div><input type="date" id="sm-hire"></div>
      <div><div class="input-label">Status</div>
        <select id="sm-status">
          <option value="active">âœ… Active</option>
          <option value="training">ğŸ“‹ In Training</option>
          <option value="probation">âš ï¸ Probation</option>
          <option value="inactive">âŒ Inactive</option>
        </select>
      </div>
      <div><div class="input-label">Performance (1-5)</div>
        <select id="sm-perf">
          <option value="5">â­â­â­â­â­ Exceptional</option>
          <option value="4">â­â­â­â­ Strong</option>
          <option value="3" selected>â­â­â­ Meets Expectations</option>
          <option value="2">â­â­ Needs Improvement</option>
          <option value="1">â­ Unsatisfactory</option>
        </select>
      </div>
      <div><div class="input-label">Phone / Contact</div><input type="text" id="sm-phone" placeholder="Optional"></div>
    </div>
    <div><div class="input-label" style="margin-bottom:5px">Notes</div>
      <textarea id="sm-notes" placeholder="Certifications, coaching history, strengths, areas to develop..." style="min-height:80px;resize:vertical;width:100%"></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeStaffModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveStaffMember()">Save</button>
    </div>
  </div>
</div>

</div><!-- end .app -->

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SYNC â€” Direct REST API (no auth SDK â€” avoids LockManager bug)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SB_URL = 'https://pemmhbdggpgzykljchel.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBlbW1oYmRnZ3BnenlrbGpjaGVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNDczNjgsImV4cCI6MjA4NzYyMzM2OH0.yPgAcVlfExTWxqcIPwpcCvOa6WosfLn7ha14edu1XMA';
// Sync uses a fixed row key per "account" â€” stored as sync_id in localStorage
// No auth SDK needed â€” tables use open RLS with sync_id as the key
let syncId = localStorage.getItem('ag_sync_id') || null;
let syncTimeout = null;
let currentUser = { id: syncId }; // compatibility shim

const TABLES = {
  todos:'ag_todos', weekData:'ag_week', customLinks:'ag_links',
  outreachList:'ag_outreach', convoNotes:'ag_convonotes', staffList:'ag_staff',
  handoffs:'ag_handoffs', trips:'ag_trips', schedules:'ag_schedules'
};

function sbHeaders() {
  return { 'apikey': SB_KEY, 'Authorization': 'Bearer ' + SB_KEY, 'Content-Type': 'application/json', 'Prefer': 'resolution=merge-duplicates' };
}

async function syncToCloud(key, data) {
  if (!syncId) return;
  const table = TABLES[key];
  if (!table) return;
  setSyncStatus('syncing', 'Saving...');
  clearTimeout(syncTimeout);
  syncTimeout = setTimeout(async () => {
    try {
      const resp = await fetch(`${SB_URL}/rest/v1/${table}`, {
        method: 'POST',
        headers: { ...sbHeaders(), 'Prefer': 'resolution=merge-duplicates' },
        body: JSON.stringify({ sync_id: syncId, data: data })
      });
      if (!resp.ok) throw new Error(await resp.text());
      setSyncStatus('synced', 'Synced âœ“');
    } catch(e) {
      setSyncStatus('error', 'Sync failed â€” saved locally');
      console.error('Sync error:', e);
    }
  }, 600);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let todos      = JSON.parse(localStorage.getItem('ag_todos')     || '[]');
let weekData   = JSON.parse(localStorage.getItem('ag_week')      || '[]');
let customLinks= JSON.parse(localStorage.getItem('ag_links')     || '[]');
let outreachList=JSON.parse(localStorage.getItem('ag_outreach')  || '[]');
let convoNotes = JSON.parse(localStorage.getItem('ag_convonotes')|| '[]');
let docs       = JSON.parse(localStorage.getItem('ag_docs')      || '[]');
let staffList  = JSON.parse(localStorage.getItem('ag_staff')     || '[]');
let handoffs   = JSON.parse(localStorage.getItem('ag_handoffs')  || '[]');
let trips      = JSON.parse(localStorage.getItem('ag_trips')     || '[]');
let schedules  = JSON.parse(localStorage.getItem('ag_schedules') || '[]');
let currentFilter = 'all';
let cnFilter = 'all';
let docFilter = 'all';
let hoFilter = 'all';
let tripFilter = 'all';
let editingStaffId = null;

const defaultLinks = [
  { name:'Google Workspace', url:'https://workspace.google.com', icon:'ğŸ“', desc:'Drive / Sheets / Docs' }
];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CLOCK & TABS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateDate() {
  const now = new Date();
  document.getElementById('dateBadge').textContent =
    now.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'})
    + '  ' + now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const today = now.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
  const lbl = document.getElementById('todayDateLabel');
  if(lbl) lbl.textContent = today;
}

function initDateInputs() {
  const d = new Date().toISOString().split('T')[0];
  ['inp-date','out-date','cn-date','ho-date','trip-start','trip-end'].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.value = d;
  });
}

function switchTab(name) {
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  const panel = document.getElementById('panel-'+name);
  if(panel) panel.classList.add('active');
  const btns = document.querySelectorAll('.tab-btn');
  btns.forEach(b=>{ if(b.getAttribute('onclick')&&b.getAttribute('onclick').includes("'"+name+"'")) b.classList.add('active'); });
  updateHomeStats();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function escHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function avatarColor(name){
  const colors=['linear-gradient(135deg,#00e5ff,#a8ff3e)','linear-gradient(135deg,#ff4d6d,#ffd166)','linear-gradient(135deg,#c084fc,#00e5ff)','linear-gradient(135deg,#ffd166,#a8ff3e)','linear-gradient(135deg,#ff4d6d,#c084fc)'];
  let h=0;for(let c of (name||''))h=(h*31+c.charCodeAt(0))%colors.length;
  return colors[h];
}
function initials(name){ return (name||'?').split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2); }
function fmtDate(d){ if(!d)return'â€”'; try{return new Date(d+'T00:00').toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}catch(e){return d} }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// HOME STATS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateHomeStats(){
  const pending = todos.filter(t=>!t.done).length;
  document.getElementById('home-tasks').textContent = pending;
  document.getElementById('home-tasks-sub').textContent = pending===1?'pending task':'pending tasks';

  // Who's working today
  const todayStr = new Date().toISOString().split('T')[0];
  let todayShifts = [];
  schedules.forEach(s=>{
    if(s.shifts){
      s.shifts.forEach(sh=>{
        if(sh.date===todayStr) todayShifts.push(sh);
      });
    }
  });
  document.getElementById('home-staff').textContent = todayShifts.length;
  const wwd = document.getElementById('whosWorkingDisplay');
  if(todayShifts.length>0){
    wwd.innerHTML = todayShifts.map(sh=>`
      <span class="shift-pill">
        <span class="sp-name">${escHtml(sh.name)}</span>
        <span class="sp-time">${escHtml(sh.time||'')}</span>
      </span>`).join('');
  } else {
    wwd.innerHTML = '<div style="color:var(--muted);font-size:13px">No one scheduled today â€” or schedule not yet loaded.</div>';
  }

  const openCN = convoNotes.filter(n=>n.status==='open'||n.status==='pending').length;
  document.getElementById('home-cn').textContent = openCN;

  const dueOut = outreachList.filter(r=>r.status==='due'||r.status==='overdue').length;
  document.getElementById('home-out').textContent = dueOut;

  renderHomeTodos();
}

function homeAddTodo(){
  const text = document.getElementById('home-todo-input').value.trim();
  if(!text) return;
  todos.unshift({ id:Date.now(), text, done:false, priority:document.getElementById('home-todo-prio').value, category:'ops', created:new Date().toLocaleDateString() });
  document.getElementById('home-todo-input').value='';
  saveTodos(); renderTodos(); renderHomeTodos(); updateHomeStats();
}

function renderHomeTodos(){
  const el = document.getElementById('home-todo-preview');
  if(!el) return;
  const top = todos.filter(t=>!t.done).slice(0,5);
  if(top.length===0){ el.innerHTML='<div style="color:var(--muted);font-size:13px">All clear! No pending tasks.</div>'; return; }
  el.innerHTML = top.map(t=>`
    <div class="todo-item" style="margin-bottom:5px">
      <div class="todo-check ${t.done?'checked':''}" onclick="toggleTodo(${t.id});renderHomeTodos();updateHomeStats()"></div>
      <div class="todo-text">${escHtml(t.text)}</div>
      <span class="todo-priority prio-${t.priority}">${t.priority}</span>
    </div>`).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TASKS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveTodos(){ localStorage.setItem('ag_todos',JSON.stringify(todos)); syncToCloud('todos',todos); }
function addTodo(){
  const text=document.getElementById('todoInput').value.trim();
  if(!text)return;
  todos.unshift({id:Date.now(),text,done:false,priority:document.getElementById('todoPriority').value,category:document.getElementById('todoCategory').value,created:new Date().toLocaleDateString()});
  document.getElementById('todoInput').value='';
  saveTodos(); renderTodos(); updateHomeStats();
}
function toggleTodo(id){ const t=todos.find(t=>t.id===id); if(t){t.done=!t.done;saveTodos();renderTodos();updateHomeStats();} }
function deleteTodo(id){ todos=todos.filter(t=>t.id!==id); saveTodos();renderTodos();updateHomeStats(); }
function clearDone(){ todos=todos.filter(t=>!t.done); saveTodos();renderTodos();updateHomeStats(); }
function setFilter(f,btn){ currentFilter=f; document.querySelectorAll('#panel-tasks .filter-chip').forEach(c=>c.classList.remove('active-chip')); btn.classList.add('active-chip'); renderTodos(); }
const catLabels={ops:'ğŸ¢ Ops',hr:'ğŸ‘¤ HR',hospitality:'ğŸ® Guest',training:'ğŸ“‹ Train',admin:'âš™ï¸ Admin'};
const prioClass={high:'prio-high',mid:'prio-mid',low:'prio-low'};
function renderTodos(){
  let filtered=todos;
  if(currentFilter==='high')filtered=todos.filter(t=>t.priority==='high');
  else if(currentFilter==='mid')filtered=todos.filter(t=>t.priority==='mid');
  else if(currentFilter==='low')filtered=todos.filter(t=>t.priority==='low');
  else if(currentFilter==='active')filtered=todos.filter(t=>!t.done);
  else if(currentFilter==='done')filtered=todos.filter(t=>t.done);
  const list=document.getElementById('todoList');
  if(!list)return;
  list.innerHTML=filtered.length===0
    ?'<div style="text-align:center;padding:28px;color:var(--muted);font-size:14px">No tasks here âš¡</div>'
    :filtered.map(t=>`<div class="todo-item ${t.done?'done':''}">
      <div class="todo-check ${t.done?'checked':''}" onclick="toggleTodo(${t.id})"></div>
      <div class="todo-text">${escHtml(t.text)}</div>
      <span class="todo-priority ${prioClass[t.priority]}">${t.priority}</span>
      <span style="font-size:11px;color:var(--muted);font-family:'DM Mono',monospace">${catLabels[t.category]||t.category}</span>
      <button class="btn-danger btn" onclick="deleteTodo(${t.id})">âœ•</button>
    </div>`).join('');
  const total=todos.length,done=todos.filter(t=>t.done).length,high=todos.filter(t=>t.priority==='high'&&!t.done).length,pct=total?Math.round(done/total*100):0;
  document.getElementById('stat-total').textContent=total;
  document.getElementById('stat-done').textContent=done;
  document.getElementById('stat-high').textContent=high;
  document.getElementById('stat-pct').textContent=pct+'%';
  document.getElementById('taskProgress').style.width=pct+'%';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// REVENUE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateRevMetrics(){
  const rev=parseFloat(document.getElementById('inp-rev').value)||0;
  const guests=parseInt(document.getElementById('inp-guests').value)||0;
  const goal=parseFloat(document.getElementById('inp-goal').value)||0;
  const ret=parseInt(document.getElementById('inp-return').value)||0;
  document.getElementById('rev-today-display').textContent='$'+rev.toLocaleString('en-US',{maximumFractionDigits:0});
  document.getElementById('guests-today-display').textContent=guests.toLocaleString();
  document.getElementById('rev-per-guest').textContent=guests>0?'$'+(rev/guests).toFixed(2):'$0';
  document.getElementById('return-count').textContent=ret;
  if(goal>0){const pct=Math.round(rev/goal*100);document.getElementById('rev-vs-goal').className='stat-sub '+(pct>=100?'up':pct>=75?'':'down');document.getElementById('rev-vs-goal').textContent=pct+'% of $'+goal.toLocaleString()+' goal';}
}
function saveWeekData(){ localStorage.setItem('ag_week',JSON.stringify(weekData)); syncToCloud('weekData',weekData); }
function logDay(){
  const date=document.getElementById('inp-date').value;
  const rev=parseFloat(document.getElementById('inp-rev').value)||0;
  const guests=parseInt(document.getElementById('inp-guests').value)||0;
  if(!date){alert('Please pick a date');return;}
  const existing=weekData.findIndex(d=>d.date===date);
  if(existing>=0)weekData[existing]={date,rev,guests};
  else weekData.push({date,rev,guests});
  weekData.sort((a,b)=>a.date.localeCompare(b.date));
  if(weekData.length>14)weekData=weekData.slice(-14);
  saveWeekData();renderWeekChart();alert('Day logged âœ…');
}
function renderWeekChart(){
  const el=document.getElementById('weekChart');
  if(!el)return;
  if(weekData.length===0){el.innerHTML='<div style="color:var(--muted);font-size:13px;text-align:center;padding:20px">Log days above to see chart</div>';return;}
  const last7=weekData.slice(-7);
  const maxRev=Math.max(...last7.map(d=>d.rev),1);
  el.innerHTML=last7.map(d=>{
    const pct=Math.round(d.rev/maxRev*100);
    const label=new Date(d.date+'T00:00').toLocaleDateString('en-US',{weekday:'short',month:'numeric',day:'numeric'});
    return`<div class="chart-row"><div class="chart-label">${label}</div><div class="chart-bar-bg"><div class="chart-bar" style="width:${pct}%;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#000">${pct>20?d.guests+' guests':''}</div></div><div class="chart-val">$${d.rev.toLocaleString()}</div></div>`;
  }).join('');
  const avgG=Math.round(last7.reduce((s,d)=>s+d.guests,0)/last7.length);
  const el2=document.getElementById('guests-avg');if(el2)el2.textContent=avgG+' avg / day';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STAFF
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveStaff(){ localStorage.setItem('ag_staff',JSON.stringify(staffList)); syncToCloud('staffList',staffList); }
function openStaffModal(id){
  editingStaffId=id||null;
  const m=staffList.find(s=>s.id===id);
  document.getElementById('staffModalTitle').textContent=m?'Edit Staff Member':'Add Staff Member';
  document.getElementById('sm-name').value=m?m.name:'';
  document.getElementById('sm-role').value=m?m.role:'Game Facilitator';
  document.getElementById('sm-hire').value=m?m.hire:'';
  document.getElementById('sm-status').value=m?m.status:'active';
  document.getElementById('sm-perf').value=m?m.perf:'3';
  document.getElementById('sm-phone').value=m?m.phone:'';
  document.getElementById('sm-notes').value=m?m.notes:'';
  document.getElementById('staffModal').classList.remove('hidden');
}
function closeStaffModal(){ document.getElementById('staffModal').classList.add('hidden'); editingStaffId=null; }
function saveStaffMember(){
  const name=document.getElementById('sm-name').value.trim();
  if(!name){alert('Please enter a name');return;}
  const data={id:editingStaffId||Date.now(),name,role:document.getElementById('sm-role').value,hire:document.getElementById('sm-hire').value,status:document.getElementById('sm-status').value,perf:document.getElementById('sm-perf').value,phone:document.getElementById('sm-phone').value,notes:document.getElementById('sm-notes').value};
  if(editingStaffId){const i=staffList.findIndex(s=>s.id===editingStaffId);if(i>=0)staffList[i]=data;}
  else staffList.push(data);
  saveStaff();closeStaffModal();renderStaff();
}
function deleteStaffMember(id){ if(!confirm('Delete this staff member?'))return; staffList=staffList.filter(s=>s.id!==id); saveStaff();renderStaff(); }
const statusColors={active:'badge-green',training:'badge-cyan',probation:'badge-gold',inactive:'badge-red'};
const perfStars={5:'â­â­â­â­â­',4:'â­â­â­â­',3:'â­â­â­',2:'â­â­',1:'â­'};
function renderStaff(){
  const el=document.getElementById('staffGrid');if(!el)return;
  const q=(document.getElementById('staffSearch').value||'').toLowerCase();
  let list=staffList.filter(s=>!q||(s.name||'').toLowerCase().includes(q)||(s.role||'').toLowerCase().includes(q));
  if(list.length===0){el.innerHTML='<div style="color:var(--muted);font-size:13px;padding:20px;grid-column:1/-1">No staff members yet. Add one above.</div>';return;}
  el.innerHTML=list.map(s=>`
    <div class="staff-card" onclick="openStaffModal(${s.id})">
      <div class="staff-header">
        <div class="staff-avatar" style="background:${avatarColor(s.name)}">${initials(s.name)}</div>
        <div><div class="staff-name">${escHtml(s.name)}</div><div class="staff-role">${escHtml(s.role)}</div></div>
        <span class="badge ${statusColors[s.status]||'badge-cyan'}" style="margin-left:auto">${s.status||'active'}</span>
      </div>
      <div style="font-size:13px">${perfStars[s.perf]||'â­â­â­'}</div>
      <div class="staff-stats">
        <span class="staff-stat">ğŸ“… Hired ${fmtDate(s.hire)}</span>
        ${s.phone?`<span class="staff-stat">ğŸ“± ${escHtml(s.phone)}</span>`:''}
      </div>
      ${s.notes?`<div style="font-size:12px;color:var(--muted);margin-top:8px;line-height:1.5">${escHtml(s.notes.slice(0,100))}${s.notes.length>100?'...':''}</div>`:''}
      <div style="margin-top:10px;display:flex;gap:6px">
        <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();openStaffModal(${s.id})">âœï¸ Edit</button>
        <button class="btn btn-danger btn-sm" onclick="event.stopPropagation();deleteStaffMember(${s.id})">âœ•</button>
      </div>
    </div>`).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SHIFT HANDOFF
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveHandoffs(){ localStorage.setItem('ag_handoffs',JSON.stringify(handoffs)); syncToCloud('handoffs',handoffs); }
function saveHandoff(){
  const date=document.getElementById('ho-date').value;
  const shift=document.getElementById('ho-shift').value;
  const mod=document.getElementById('ho-mod').value.trim();
  if(!mod){alert('Please enter manager on duty');return;}
  handoffs.unshift({id:Date.now(),date,shift,mod,rev:document.getElementById('ho-rev').value,guests:document.getElementById('ho-guests').value,guestNotes:document.getElementById('ho-guests-notes').value,maint:document.getElementById('ho-maint').value,staffNotes:document.getElementById('ho-staff-notes').value,actions:document.getElementById('ho-actions').value});
  ['ho-guests-notes','ho-maint','ho-staff-notes','ho-actions'].forEach(id=>{document.getElementById(id).value='';});
  document.getElementById('ho-rev').value='';document.getElementById('ho-guests').value='';
  saveHandoffs();renderHandoffs();alert('Handoff saved âœ…');
}
function deleteHandoff(id){ handoffs=handoffs.filter(h=>h.id!==id); saveHandoffs();renderHandoffs(); }
function setHOFilter(f,btn){ hoFilter=f; document.querySelectorAll('#ho-filters .filter-chip').forEach(c=>c.classList.remove('active-chip')); btn.classList.add('active-chip'); renderHandoffs(); }
const shiftLabels={open:'ğŸŒ… Opening',mid:'â˜€ï¸ Mid',close:'ğŸŒ™ Closing'};
function renderHandoffs(){
  const el=document.getElementById('handoffList');if(!el)return;
  let list=hoFilter==='all'?handoffs:handoffs.filter(h=>h.shift===hoFilter);
  if(list.length===0){el.innerHTML='<div style="text-align:center;padding:28px;color:var(--muted);font-size:14px">No handoffs logged yet.</div>';return;}
  el.innerHTML=list.map(h=>`
    <div class="handoff-card">
      <div class="handoff-header">
        <span class="badge badge-cyan">${shiftLabels[h.shift]||h.shift}</span>
        <span style="font-size:13px;font-weight:600">${fmtDate(h.date)}</span>
        <span style="font-size:12px;color:var(--muted)">MOD: ${escHtml(h.mod)}</span>
        ${h.rev?`<span class="badge badge-green">$${parseFloat(h.rev).toLocaleString()}</span>`:''}
        ${h.guests?`<span class="badge badge-gold">${h.guests} guests</span>`:''}
        <button class="btn btn-danger btn-sm" onclick="deleteHandoff(${h.id})" style="margin-left:auto">âœ•</button>
      </div>
      ${h.guestNotes?`<div class="handoff-section"><div class="handoff-label">ğŸ‘¥ Guest Notes</div><div class="handoff-text">${escHtml(h.guestNotes)}</div></div>`:''}
      ${h.maint?`<div class="handoff-section"><div class="handoff-label">ğŸ”§ Maintenance</div><div class="handoff-text">${escHtml(h.maint)}</div></div>`:''}
      ${h.staffNotes?`<div class="handoff-section"><div class="handoff-label">ğŸ‘¤ Staff Notes</div><div class="handoff-text">${escHtml(h.staffNotes)}</div></div>`:''}
      ${h.actions?`<div class="handoff-section"><div class="handoff-label">âš¡ Action Items</div><div class="handoff-text">${escHtml(h.actions)}</div></div>`:''}
    </div>`).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TRAINING TRIPS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveTrips(){ localStorage.setItem('ag_trips',JSON.stringify(trips)); syncToCloud('trips',trips); }
function addTrip(){
  const loc=document.getElementById('trip-loc').value.trim();
  if(!loc){alert('Please enter a location');return;}
  const traineesRaw=document.getElementById('trip-trainees').value.trim();
  const trainees=traineesRaw?traineesRaw.split('\n').map(t=>t.trim()).filter(t=>t).map(t=>({name:t,done:false})):[];
  trips.unshift({id:Date.now(),loc,type:document.getElementById('trip-type').value,start:document.getElementById('trip-start').value,end:document.getElementById('trip-end').value,notes:document.getElementById('trip-notes').value,trainees,status:'upcoming'});
  document.getElementById('trip-loc').value='';document.getElementById('trip-notes').value='';document.getElementById('trip-trainees').value='';
  saveTrips();renderTrips();
}
function deleteTrip(id){ if(!confirm('Delete this trip?'))return; trips=trips.filter(t=>t.id!==id); saveTrips();renderTrips(); }
function markTripComplete(id){ const t=trips.find(t=>t.id===id); if(t){t.status='complete';saveTrips();renderTrips();} }
function toggleTrainee(tripId,tIdx){ const trip=trips.find(t=>t.id===tripId); if(trip&&trip.trainees[tIdx]){trip.trainees[tIdx].done=!trip.trainees[tIdx].done;saveTrips();renderTrips();} }
function setTripFilter(f,btn){ tripFilter=f; document.querySelectorAll('#trip-filters .filter-chip').forEach(c=>c.classList.remove('active-chip')); btn.classList.add('active-chip'); renderTrips(); }
const tripTypeLabel={opening:'ğŸª Location Opening',gm:'ğŸ‘¤ GM Training',support:'ğŸ¤ Support Visit'};
function renderTrips(){
  const el=document.getElementById('tripsList');if(!el)return;
  let list=trips;
  if(tripFilter==='upcoming')list=trips.filter(t=>t.status!=='complete');
  else if(tripFilter==='complete')list=trips.filter(t=>t.status==='complete');
  else if(['opening','gm','support'].includes(tripFilter))list=trips.filter(t=>t.type===tripFilter);
  if(list.length===0){el.innerHTML='<div style="text-align:center;padding:28px;color:var(--muted);font-size:14px">No trips logged yet.</div>';return;}
  el.innerHTML=list.map(t=>{
    const done=t.trainees.filter(tr=>tr.done).length;
    const pct=t.trainees.length?Math.round(done/t.trainees.length*100):0;
    return`<div class="trip-card">
      <div class="trip-header">
        <div class="trip-title">ğŸ“ ${escHtml(t.loc)}</div>
        <span class="badge badge-cyan">${tripTypeLabel[t.type]||t.type}</span>
        <span class="badge ${t.status==='complete'?'badge-green':'badge-gold'}">${t.status==='complete'?'âœ… Complete':'ğŸ—“ Upcoming'}</span>
        ${t.status!=='complete'?`<button class="btn btn-green btn-sm" onclick="markTripComplete(${t.id})">Mark Complete</button>`:''}
        <button class="btn btn-danger btn-sm" onclick="deleteTrip(${t.id})">âœ•</button>
      </div>
      <div style="font-size:12px;color:var(--muted);font-family:'DM Mono',monospace;margin-bottom:10px">
        ğŸ“… ${fmtDate(t.start)} â†’ ${fmtDate(t.end)}
        ${t.notes?` Â· ${escHtml(t.notes)}`:''}
      </div>
      ${t.trainees.length>0?`
        <div style="margin-bottom:6px">
          <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;font-family:'DM Mono',monospace;margin-bottom:6px">Trainees â€” ${done}/${t.trainees.length} trained (${pct}%)</div>
          <div class="progress-bar" style="margin-bottom:10px"><div class="progress-fill" style="width:${pct}%"></div></div>
          ${t.trainees.map((tr,i)=>`<div class="trainee-row">
            <div class="trainee-check ${tr.done?'checked':''}" onclick="toggleTrainee(${t.id},${i})"></div>
            <div class="trainee-name">${escHtml(tr.name)}</div>
            <span class="badge ${tr.done?'badge-green':'badge-gold'}">${tr.done?'Trained':'Pending'}</span>
          </div>`).join('')}
        </div>`:''}
    </div>`;
  }).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// AI SCHEDULE READER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleSchedDrop(e){
  e.preventDefault();
  document.getElementById('dropZone').classList.remove('drag-over');
  const file=e.dataTransfer.files[0];
  if(file&&file.type.startsWith('image/')) processSchedImage(file);
}
function handleSchedFile(input){
  const file=input.files[0];
  if(file) processSchedImage(file);
}

async function processSchedImage(file){
  const area=document.getElementById('schedPreviewArea');
  area.innerHTML=`<div class="ai-loading"><div class="spinner"></div> Reading schedule with AI â€” this may take a moment...</div>`;

  const b64=await new Promise((res,rej)=>{
    const r=new FileReader();
    r.onload=()=>res(r.result.split(',')[1]);
    r.onerror=()=>rej();
    r.readAsDataURL(file);
  });

  const weekStart=document.getElementById('sched-week-start').value;

  try {
    const resp = await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        model:'claude-sonnet-4-20250514',
        max_tokens:1500,
        messages:[{
          role:'user',
          content:[
            {type:'image',source:{type:'base64',media_type:file.type,data:b64}},
            {type:'text',text:`This is an ADP employee schedule screenshot. Extract every shift you can see.
For each shift return a JSON array of objects with: name (employee first+last name), date (YYYY-MM-DD â€” infer from the week starting ${weekStart||'the week shown'}), time (shift time range e.g. "9:00 AM - 5:00 PM"), role (job title if visible).
If a date can't be determined precisely, use the day of week label and the week start date ${weekStart||''} to calculate it.
Respond ONLY with a valid JSON array. No explanation, no markdown, no backticks. Example: [{"name":"Jane Smith","date":"2026-02-24","time":"10:00 AM - 6:00 PM","role":"Game Facilitator"}]`}
          ]
        }]
      })
    });
    const data=await resp.json();
    const raw=data.content.map(i=>i.text||'').join('');
    let shifts;
    try{ shifts=JSON.parse(raw); }
    catch(e){ throw new Error('Could not parse AI response. Try a clearer screenshot.'); }

    renderSchedPreview(shifts, weekStart, file.name);
  } catch(err){
    area.innerHTML=`<div class="card" style="border-color:var(--accent2)"><div style="color:var(--accent2);font-weight:600">âš ï¸ ${escHtml(err.message||'Error reading schedule')}</div><div style="color:var(--muted);font-size:13px;margin-top:6px">Make sure your screenshot is clear and well-lit. Try cropping it to just the schedule grid.</div></div>`;
  }
}

function renderSchedPreview(shifts, weekStart, filename){
  const area=document.getElementById('schedPreviewArea');
  if(!shifts||shifts.length===0){
    area.innerHTML='<div class="card" style="border-color:var(--gold)"><div style="color:var(--gold)">No shifts detected. Try a clearer screenshot.</div></div>';
    return;
  }
  // Group by date
  const byDate={};
  shifts.forEach(s=>{
    const d=s.date||'unknown';
    if(!byDate[d])byDate[d]=[];
    byDate[d].push(s);
  });
  const dates=Object.keys(byDate).sort();
  area.innerHTML=`
    <div class="card" style="border-color:rgba(168,255,62,.3)">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;flex-wrap:wrap">
        <span style="font-size:15px;font-weight:600;color:var(--accent3)">âœ… ${shifts.length} shifts extracted</span>
        <span style="font-size:12px;color:var(--muted)">Review below, then save</span>
        <button class="btn btn-primary" style="margin-left:auto" onclick="saveSchedule(${JSON.stringify(shifts).replace(/'/g,"&#39;")}, '${weekStart||''}', '${escHtml(filename)}')">ğŸ’¾ Save Schedule</button>
      </div>
      ${dates.map(d=>`
        <div style="margin-bottom:12px">
          <div style="font-size:12px;font-family:'DM Mono',monospace;color:var(--accent);margin-bottom:6px;text-transform:uppercase;letter-spacing:1px">${fmtDate(d)}</div>
          <div style="display:flex;flex-wrap:wrap;gap:6px">
            ${byDate[d].map(s=>`<span class="shift-pill"><span class="sp-name">${escHtml(s.name)}</span><span class="sp-time">${escHtml(s.time||'')}</span></span>`).join('')}
          </div>
        </div>`).join('')}
    </div>`;
}

function saveSchedule(shifts, weekStart, filename){
  schedules.unshift({id:Date.now(),weekStart,filename,shifts,saved:new Date().toLocaleDateString()});
  if(schedules.length>10)schedules=schedules.slice(0,10);
  localStorage.setItem('ag_schedules',JSON.stringify(schedules));
  syncToCloud('schedules', schedules);
  document.getElementById('schedPreviewArea').innerHTML='<div class="card" style="border-color:rgba(168,255,62,.3);color:var(--accent3)">âœ… Schedule saved! It will now show in "Who\'s Working Today" on the Home tab.</div>';
  renderSavedSchedules();
  updateHomeStats();
}

function deleteSchedule(id){
  schedules=schedules.filter(s=>s.id!==id);
  localStorage.setItem('ag_schedules',JSON.stringify(schedules));
  renderSavedSchedules();updateHomeStats();
}

function renderSavedSchedules(){
  const el=document.getElementById('savedSchedList');if(!el)return;
  if(schedules.length===0){el.innerHTML='<div style="color:var(--muted);font-size:13px">No schedules saved yet.</div>';return;}
  el.innerHTML=schedules.map(s=>`
    <div class="handoff-card" style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
      <span style="font-size:22px">ğŸ“…</span>
      <div style="flex:1">
        <div style="font-weight:600;font-size:14px">Week of ${fmtDate(s.weekStart)||'â€”'}</div>
        <div style="font-size:11px;color:var(--muted);font-family:'DM Mono',monospace">${s.shifts.length} shifts Â· saved ${s.saved} Â· ${escHtml(s.filename||'')}</div>
      </div>
      <button class="btn btn-danger btn-sm" onclick="deleteSchedule(${s.id})">âœ•</button>
    </div>`).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LINKS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveLinks(){ localStorage.setItem('ag_links',JSON.stringify(customLinks)); syncToCloud('customLinks',customLinks); }
function addCustomLink(){
  const name=document.getElementById('link-name').value.trim();
  const url=document.getElementById('link-url').value.trim();
  const icon=document.getElementById('link-icon').value.trim()||'ğŸ”—';
  const desc=document.getElementById('link-desc').value.trim();
  if(!name||!url)return;
  customLinks.push({name,url,icon,desc});
  ['link-name','link-url','link-icon','link-desc'].forEach(id=>document.getElementById(id).value='');
  saveLinks();renderLinks();
}
function removeCustomLink(i){ customLinks.splice(i,1); saveLinks();renderLinks(); }
function renderLinks(){
  const grid=document.getElementById('linksGrid');if(!grid)return;
  const all=[...defaultLinks,...customLinks];
  grid.innerHTML=all.map((l,i)=>{
    const isC=i>=defaultLinks.length;
    return`<a href="${l.url}" target="_blank" class="link-card">
      <div class="link-icon">${l.icon}</div>
      <div class="link-name">${l.name}</div>
      <div class="link-desc">${l.desc||''}</div>
      ${isC?`<button onclick="event.preventDefault();event.stopPropagation();removeCustomLink(${i-defaultLinks.length})" style="margin-top:6px;font-size:10px;background:rgba(255,77,109,.15);border:none;color:var(--accent2);border-radius:4px;padding:2px 6px;cursor:pointer">remove</button>`:''}
    </a>`;
  }).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DOCS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveDocs(){ localStorage.setItem('ag_docs',JSON.stringify(docs)); }
const docCatLabel={ops:'ğŸ¢ Operations',training:'ğŸ“‹ Training',hr:'ğŸ‘¤ HR / Staff',reference:'ğŸ“Œ Reference',travel:'âœˆï¸ Travel',other:'ğŸ“ Other'};
function fileIcon(fn){ const ext=(fn||'').split('.').pop().toLowerCase(); return{pdf:'ğŸ“•',doc:'ğŸ“˜',docx:'ğŸ“˜',xls:'ğŸ“—',xlsx:'ğŸ“—',csv:'ğŸ“—',ppt:'ğŸ“™',pptx:'ğŸ“™',png:'ğŸ–¼',jpg:'ğŸ–¼',jpeg:'ğŸ–¼',txt:'ğŸ“„'}[ext]||'ğŸ“'; }
function uploadDoc(){
  const fi=document.getElementById('doc-file');
  const name=document.getElementById('doc-name').value.trim();
  const cat=document.getElementById('doc-cat').value;
  const file=fi.files[0];
  if(!file){alert('Please choose a file');return;}
  const r=new FileReader();
  r.onload=e=>{
    docs.unshift({id:Date.now(),label:name||file.name,filename:file.name,cat,size:(file.size/1024).toFixed(1)+' KB',date:new Date().toLocaleDateString(),dataUrl:e.target.result});
    if(docs.length>50)docs=docs.slice(0,50);
    saveDocs();renderDocs();
    document.getElementById('doc-name').value='';fi.value='';
  };
  r.readAsDataURL(file);
}
function deleteDoc(id){ docs=docs.filter(d=>d.id!==id); saveDocs();renderDocs(); }
function setDocFilter(f,btn){ docFilter=f; document.querySelectorAll('#doc-filters .filter-chip').forEach(c=>c.classList.remove('active-chip')); btn.classList.add('active-chip'); renderDocs(); }
function renderDocs(){
  const el=document.getElementById('docsList');if(!el)return;
  const list=docFilter==='all'?docs:docs.filter(d=>d.cat===docFilter);
  if(list.length===0){el.innerHTML='<div style="text-align:center;padding:28px;color:var(--muted);font-size:14px">No documents uploaded yet.</div>';return;}
  el.innerHTML=list.map(d=>`<div class="doc-card">
    <div class="doc-icon">${fileIcon(d.filename)}</div>
    <div class="doc-info"><div class="doc-name">${escHtml(d.label)}</div><div class="doc-meta">${d.filename} Â· ${d.size} Â· ${docCatLabel[d.cat]||d.cat} Â· ${d.date}</div></div>
    <a href="${d.dataUrl}" download="${d.filename}" class="btn btn-ghost btn-sm" style="text-decoration:none">â¬‡ Download</a>
    <button class="btn btn-danger btn-sm" onclick="deleteDoc(${d.id})">âœ•</button>
  </div>`).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// OUTREACH
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveOutreach(){ localStorage.setItem('ag_outreach',JSON.stringify(outreachList)); syncToCloud('outreachList',outreachList); }
function addOutreach(){
  const name=document.getElementById('out-name').value.trim();
  if(!name)return;
  outreachList.unshift({id:Date.now(),name,date:document.getElementById('out-date').value,contact:document.getElementById('out-contact').value.trim(),status:document.getElementById('out-status').value});
  document.getElementById('out-name').value='';document.getElementById('out-contact').value='';
  saveOutreach();renderOutreach();updateHomeStats();
}
function updateOutreachStatus(id,val){ const r=outreachList.find(r=>r.id===id); if(r){r.status=val;saveOutreach();renderOutreach();updateHomeStats();} }
function deleteOutreach(id){ outreachList=outreachList.filter(r=>r.id!==id); saveOutreach();renderOutreach();updateHomeStats(); }
const statusBadge={overdue:'<span class="badge badge-red">Overdue</span>',due:'<span class="badge badge-gold">Due</span>',done:'<span class="badge badge-green">Contacted</span>'};
function renderOutreach(){
  const el=document.getElementById('outreachList');if(!el)return;
  if(outreachList.length===0){el.innerHTML='<div style="text-align:center;padding:28px;color:var(--muted);font-size:14px">No players tracked yet.</div>';return;}
  el.innerHTML=outreachList.map(r=>`<div class="outreach-card">
    <div class="avatar">${initials(r.name)}</div>
    <div class="outreach-info"><div class="outreach-name">${escHtml(r.name)}</div><div class="outreach-meta">Last visit: ${r.date||'â€”'} Â· ${escHtml(r.contact||'No contact')}</div></div>
    ${statusBadge[r.status]||''}
    <select onchange="updateOutreachStatus(${r.id},this.value)" style="width:130px;font-size:12px;padding:5px 8px">
      <option value="due" ${r.status==='due'?'selected':''}>ğŸ“¬ Due</option>
      <option value="overdue" ${r.status==='overdue'?'selected':''}>ğŸ”´ Overdue</option>
      <option value="done" ${r.status==='done'?'selected':''}>âœ… Contacted</option>
    </select>
    <button class="btn btn-danger btn-sm" onclick="deleteOutreach(${r.id})">âœ•</button>
  </div>`).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CONV NOTES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveConvoNotes(){ localStorage.setItem('ag_convonotes',JSON.stringify(convoNotes)); syncToCloud('convoNotes',convoNotes); }
function addConvoNote(){
  const person=document.getElementById('cn-person').value.trim();
  if(!person){alert('Please enter a person or topic');return;}
  convoNotes.unshift({id:Date.now(),person,date:document.getElementById('cn-date').value,type:document.getElementById('cn-type').value,status:document.getElementById('cn-status').value,body:document.getElementById('cn-body').value.trim()});
  document.getElementById('cn-person').value='';document.getElementById('cn-body').value='';
  saveConvoNotes();renderConvoNotes();updateHomeStats();
}
function deleteConvoNote(id){ convoNotes=convoNotes.filter(n=>n.id!==id); saveConvoNotes();renderConvoNotes();updateHomeStats(); }
function updateCNStatus(id,val){ const n=convoNotes.find(n=>n.id===id); if(n){n.status=val;saveConvoNotes();renderConvoNotes();updateHomeStats();} }
function setCNFilter(f,btn){ cnFilter=f; document.querySelectorAll('#cn-filters .filter-chip').forEach(c=>c.classList.remove('active-chip')); btn.classList.add('active-chip'); renderConvoNotes(); }
const cnTypeLabel={meeting:'ğŸ“… Meeting',coaching:'ğŸ¯ Coaching',verbal:'ğŸ—£ Verbal',written:'ğŸ“„ Written',boss:'â¬†ï¸ Leadership',followup:'ğŸ” Follow-Up',other:'ğŸ’¬ Other'};
const cnStatusBadge={open:'<span class="badge badge-gold">Open</span>',resolved:'<span class="badge badge-green">Resolved</span>',pending:'<span class="badge badge-red">Pending Action</span>'};
function renderConvoNotes(){
  let filtered=convoNotes;
  if(['meeting','coaching','verbal','written','boss','followup','other'].includes(cnFilter))filtered=convoNotes.filter(n=>n.type===cnFilter);
  else if(cnFilter==='open')filtered=convoNotes.filter(n=>n.status==='open');
  else if(cnFilter==='resolved')filtered=convoNotes.filter(n=>n.status==='resolved');
  const el=document.getElementById('convoNotesList');if(!el)return;
  if(filtered.length===0){el.innerHTML='<div style="text-align:center;padding:28px;color:var(--muted);font-size:14px">No notes yet.</div>';return;}
  el.innerHTML=filtered.map(n=>`<div class="cn-card">
    <div class="cn-card-header">
      <div class="cn-person">${escHtml(n.person)}</div>
      <span class="badge badge-cyan">${cnTypeLabel[n.type]||n.type}</span>
      ${cnStatusBadge[n.status]||''}
      <select onchange="updateCNStatus(${n.id},this.value)" style="width:150px;font-size:12px;padding:4px 8px">
        <option value="open" ${n.status==='open'?'selected':''}>ğŸŸ¡ Open</option>
        <option value="resolved" ${n.status==='resolved'?'selected':''}>âœ… Resolved</option>
        <option value="pending" ${n.status==='pending'?'selected':''}>â³ Pending</option>
      </select>
      <button class="btn btn-danger btn-sm" onclick="deleteConvoNote(${n.id})">âœ•</button>
    </div>
    ${n.body?`<div class="cn-body-text">${escHtml(n.body)}</div>`:''}
    <div class="cn-meta">ğŸ“… ${fmtDate(n.date)}</div>
  </div>`).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// NOTES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveNote(key){
  const val=document.getElementById('note-'+key).value;
  localStorage.setItem('ag_note_'+key,val);
  const btn=event.currentTarget;btn.textContent='Saved âœ“';btn.style.background='var(--accent3)';
  setTimeout(()=>{btn.textContent='Save';btn.style.background='';},1500);
}
function loadNotes(){
  ['shift','training','opening','travel'].forEach(k=>{
    const saved=localStorage.getItem('ag_note_'+k);
    const el=document.getElementById('note-'+k);
    if(saved&&el)el.value=saved;
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// EXPORT & BACKUP
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function downloadFile(content, filename, mime){
  const blob = new Blob([content], {type: mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}

function toCSV(rows){
  if(!rows||rows.length===0) return '';
  const headers = Object.keys(rows[0]);
  const escape = v => {
    const s = String(v==null?'':v).replace(/"/g,'""');
    return (s.includes(',') || s.includes('"') || s.includes('\n')) ? `"${s}"` : s;
  };
  return [headers.join(','), ...rows.map(r=>headers.map(h=>escape(r[h])).join(','))].join('\n');
}

function exportCSV(type){
  const stamp = new Date().toISOString().split('T')[0];
  let rows=[], filename='';
  if(type==='tasks'){
    rows = todos.map(t=>({Text:t.text, Priority:t.priority, Category:t.category, Done:t.done?'Yes':'No', Created:t.created}));
    filename=`activate-tasks-${stamp}.csv`;
  } else if(type==='convonotes'){
    rows = convoNotes.map(n=>({Person:n.person, Date:n.date, Type:n.type, Status:n.status, Notes:n.body}));
    filename=`activate-convonotes-${stamp}.csv`;
  } else if(type==='staff'){
    rows = staffList.map(s=>({Name:s.name, Role:s.role, HireDate:s.hire, Status:s.status, Performance:s.perf, Phone:s.phone, Notes:s.notes}));
    filename=`activate-staff-${stamp}.csv`;
  } else if(type==='revenue'){
    rows = weekData.map(d=>({Date:d.date, Revenue:d.rev, Guests:d.guests}));
    filename=`activate-revenue-${stamp}.csv`;
  } else if(type==='handoffs'){
    rows = handoffs.map(h=>({Date:h.date, Shift:h.shift, MOD:h.mod, Revenue:h.rev, Guests:h.guests, GuestNotes:h.guestNotes, Maintenance:h.maint, StaffNotes:h.staffNotes, ActionItems:h.actions}));
    filename=`activate-handoffs-${stamp}.csv`;
  } else if(type==='trips'){
    rows = trips.flatMap(t=> t.trainees.length>0
      ? t.trainees.map(tr=>({Location:t.loc, Type:t.type, Start:t.start, End:t.end, Status:t.status, Trainee:tr.name, TraineeDone:tr.done?'Yes':'No', Notes:t.notes}))
      : [{Location:t.loc, Type:t.type, Start:t.start, End:t.end, Status:t.status, Trainee:'', TraineeDone:'', Notes:t.notes}]
    );
    filename=`activate-trips-${stamp}.csv`;
  } else if(type==='outreach'){
    rows = outreachList.map(r=>({Name:r.name, LastVisit:r.date, Contact:r.contact, Status:r.status}));
    filename=`activate-outreach-${stamp}.csv`;
  } else if(type==='schedules'){
    rows = schedules.flatMap(s=>(s.shifts||[]).map(sh=>({WeekStart:s.weekStart, Name:sh.name, Date:sh.date, Time:sh.time, Role:sh.role||''})));
    filename=`activate-schedules-${stamp}.csv`;
  }
  if(!rows||rows.length===0){ alert('No data to export yet for this category.'); return; }
  downloadFile(toCSV(rows), filename, 'text/csv');
}

function exportFullBackup(){
  const backup = {
    exported: new Date().toISOString(),
    version: '3.0',
    todos, weekData, customLinks, outreachList,
    convoNotes, staffList, handoffs, trips, schedules,
    notes: {
      shift: localStorage.getItem('ag_note_shift')||'',
      training: localStorage.getItem('ag_note_training')||'',
      opening: localStorage.getItem('ag_note_opening')||'',
      travel: localStorage.getItem('ag_note_travel')||''
    }
  };
  // Exclude docs (too large for JSON download â€” they contain base64 file data)
  const stamp = new Date().toISOString().split('T')[0];
  downloadFile(JSON.stringify(backup, null, 2), `activate-hq-backup-${stamp}.json`, 'application/json');
}

function restoreBackup(input){
  const file = input.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      if(!data.version) throw new Error('Invalid backup file');
      if(!confirm(`Restore backup from ${data.exported}?\n\nThis will REPLACE all current data. Make sure you've downloaded a fresh backup first.`)) return;
      if(data.todos) { todos=data.todos; localStorage.setItem('ag_todos',JSON.stringify(todos)); }
      if(data.weekData) { weekData=data.weekData; localStorage.setItem('ag_week',JSON.stringify(weekData)); }
      if(data.customLinks) { customLinks=data.customLinks; localStorage.setItem('ag_links',JSON.stringify(customLinks)); }
      if(data.outreachList) { outreachList=data.outreachList; localStorage.setItem('ag_outreach',JSON.stringify(outreachList)); }
      if(data.convoNotes) { convoNotes=data.convoNotes; localStorage.setItem('ag_convonotes',JSON.stringify(convoNotes)); }
      if(data.staffList) { staffList=data.staffList; localStorage.setItem('ag_staff',JSON.stringify(staffList)); }
      if(data.handoffs) { handoffs=data.handoffs; localStorage.setItem('ag_handoffs',JSON.stringify(handoffs)); }
      if(data.trips) { trips=data.trips; localStorage.setItem('ag_trips',JSON.stringify(trips)); }
      if(data.schedules) { schedules=data.schedules; localStorage.setItem('ag_schedules',JSON.stringify(schedules)); }
      if(data.notes){
        ['shift','training','opening','travel'].forEach(k=>{
          if(data.notes[k]!=null) localStorage.setItem('ag_note_'+k, data.notes[k]);
        });
      }
      // Re-render everything
      renderTodos(); renderWeekChart(); renderLinks(); renderOutreach();
      loadNotes(); renderConvoNotes(); renderDocs(); renderStaff();
      renderHandoffs(); renderTrips(); renderSavedSchedules();
      updateHomeStats(); updateExportCounts();
      alert('âœ… Backup restored successfully!');
    } catch(err) {
      alert('âŒ Could not restore: ' + err.message);
    }
  };
  reader.readAsText(file);
}

function updateExportCounts(){
  const counts = {
    'export-tasks-count': `${todos.length} tasks`,
    'export-cn-count': `${convoNotes.length} entries`,
    'export-staff-count': `${staffList.length} members`,
    'export-revenue-count': `${weekData.length} days logged`,
    'export-handoff-count': `${handoffs.length} handoffs`,
    'export-trips-count': `${trips.length} trips`,
    'export-outreach-count': `${outreachList.length} players`,
    'export-sched-count': `${schedules.length} schedules saved`,
  };
  Object.entries(counts).forEach(([id,text])=>{ const el=document.getElementById(id); if(el)el.textContent=text; });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INIT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
updateDate();
setInterval(updateDate,1000);
initDateInputs();
renderTodos();
renderWeekChart();
renderLinks();
renderOutreach();
loadNotes();
renderConvoNotes();
renderDocs();
renderStaff();
renderHandoffs();
renderTrips();
renderSavedSchedules();
updateHomeStats();
updateExportCounts();

// â”€â”€ AUTH â€” Simple sync key (no auth SDK) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function handleLogin() {
  const password = document.getElementById('loginPassword').value.trim();
  if (password.length < 6) { showLoginError('Sync key must be at least 6 characters.'); return; }
  setLoginLoading(true);
  // Hash the password into a deterministic UUID-like sync_id
  const encoder = new TextEncoder();
  const data = encoder.encode('activate-hq:' + password);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  const hex = hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
  const id = `${hex.slice(0,8)}-${hex.slice(8,12)}-4${hex.slice(13,16)}-${hex.slice(16,20)}-${hex.slice(20,32)}`;
  syncId = id;
  currentUser = { id };
  localStorage.setItem('ag_sync_id', id);
  setLoginLoading(false);
  await activateApp();
}

async function handleSignOut() {
  syncId = null;
  currentUser = { id: null };
  localStorage.removeItem('ag_sync_id');
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('syncBar').style.display = 'none';
}

function setLoginLoading(loading) {
  const btn = document.getElementById('loginBtn');
  btn.textContent = loading ? 'Connecting...' : 'Connect â†’';
  btn.disabled = loading;
}

function showLoginError(msg, isSuccess = false) {
  const el = document.getElementById('loginError');
  el.textContent = msg;
  el.style.display = 'block';
  el.style.background = isSuccess ? 'rgba(168,255,62,.1)' : 'rgba(255,77,109,.15)';
  el.style.borderColor = isSuccess ? 'rgba(168,255,62,.3)' : 'rgba(255,77,109,.3)';
  el.style.color = isSuccess ? 'var(--accent3)' : 'var(--accent2)';
}

async function activateApp() {
  document.getElementById('loginScreen').style.display = 'none';
  const syncBar = document.getElementById('syncBar');
  syncBar.style.display = 'flex';
  document.getElementById('syncUser').textContent = 'synced';
  await loadAllFromSupabase();
}

function setSyncStatus(status, msg) {
  const dot = document.getElementById('syncDot');
  const msgEl = document.getElementById('syncMsg');
  if (!dot || !msgEl) return;
  const colors = { synced:'var(--accent3)', syncing:'var(--gold)', error:'var(--accent2)', offline:'var(--muted)' };
  dot.style.background = colors[status] || 'var(--muted)';
  if (status === 'syncing') dot.style.animation = 'pulse 1s infinite';
  else dot.style.animation = '';
  msgEl.textContent = msg || 'Synced';
}

// â”€â”€ LOAD ALL DATA FROM SUPABASE (direct REST) â”€â”€â”€â”€â”€â”€â”€â”€
async function loadAllFromSupabase() {
  if (!syncId) return;
  setSyncStatus('syncing', 'Loading your data...');
  try {
    const results = await Promise.all(
      Object.entries(TABLES).map(([key, table]) =>
        fetch(`${SB_URL}/rest/v1/${table}?sync_id=eq.${syncId}&select=data`, { headers: sbHeaders() })
          .then(r => r.json())
          .then(rows => ({ key, row: rows[0] || null }))
      )
    );
    results.forEach(({ key, row }) => {
      if (!row || !row.data) return;
      const d = row.data;
      if (key === 'todos')        { todos = d;        localStorage.setItem('ag_todos', JSON.stringify(d)); }
      if (key === 'weekData')     { weekData = d;     localStorage.setItem('ag_week', JSON.stringify(d)); }
      if (key === 'customLinks')  { customLinks = d;  localStorage.setItem('ag_links', JSON.stringify(d)); }
      if (key === 'outreachList') { outreachList = d; localStorage.setItem('ag_outreach', JSON.stringify(d)); }
      if (key === 'convoNotes')   { convoNotes = d;   localStorage.setItem('ag_convonotes', JSON.stringify(d)); }
      if (key === 'staffList')    { staffList = d;    localStorage.setItem('ag_staff', JSON.stringify(d)); }
      if (key === 'handoffs')     { handoffs = d;     localStorage.setItem('ag_handoffs', JSON.stringify(d)); }
      if (key === 'trips')        { trips = d;        localStorage.setItem('ag_trips', JSON.stringify(d)); }
      if (key === 'schedules')    { schedules = d;    localStorage.setItem('ag_schedules', JSON.stringify(d)); }
    });
    renderTodos(); renderWeekChart(); renderLinks(); renderOutreach();
    loadNotes(); renderConvoNotes(); renderDocs(); renderStaff();
    renderHandoffs(); renderTrips(); renderSavedSchedules();
    updateHomeStats(); updateExportCounts();
    setSyncStatus('synced', 'Synced âœ“');
  } catch(e) {
    setSyncStatus('error', 'Sync error â€” using local data');
    console.error('Load error:', e);
  }
}

// â”€â”€ SAVE A SINGLE KEY TO SUPABASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


// â”€â”€ PATCH SAVE FUNCTIONS TO ALSO SYNC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ SAVE FUNCTIONS now call syncToCloud directly (see definitions above) â”€â”€

// â”€â”€ AUTO-LOGIN + REFRESH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function refreshAllData() {
  if (!syncId) return;
  loadAllFromSupabase();
}
document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') refreshAllData(); });
window.addEventListener('focus', refreshAllData);
window.addEventListener('pageshow', refreshAllData);
setInterval(() => { if (document.visibilityState === 'visible') refreshAllData(); }, 30000);

// Auto-login if sync key saved
if (syncId) {
  activateApp();
} else {
  document.getElementById('loginScreen').style.display = 'flex';
}

// â”€â”€ PWA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(() => {});
  });
}
function isIOS() { return /iphone|ipad|ipod/i.test(navigator.userAgent); }
function isInStandaloneMode() { return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone; }
function dismissBanner() { document.getElementById('installBanner').classList.remove('visible'); localStorage.setItem('ag_banner_dismissed','1'); }
if (isIOS() && !isInStandaloneMode() && !localStorage.getItem('ag_banner_dismissed')) {
  document.getElementById('installBanner').classList.add('visible');
}
if (window.location.hash) {
  const target = window.location.hash.replace('#','');
  setTimeout(() => {
    const panel = document.getElementById('panel-'+target);
    if (panel) {
      document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      panel.classList.add('active');
      document.querySelectorAll('.tab-btn').forEach(b=>{ if(b.getAttribute('onclick')&&b.getAttribute('onclick').includes("'"+target+"'")) b.classList.add('active'); });
    }
  }, 100);
}


</script>
</body>
</html>
