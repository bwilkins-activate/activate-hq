<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Activate HQ &#8212; Lexington Command Center</title>
<link rel="manifest" href="manifest.json">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Activate HQ">
<meta name="theme-color" content="#00e5ff">
<!-- Apple touch icon fallback (inline SVG-based) -->
<link rel="apple-touch-icon" href="icon-192.png">

<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;1,400&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0c10;
  --surface: #12151c;
  --surface2: #1a1f2b;
  --border: #252b3a;
  --accent: #00e5ff;
  --accent2: #ff4d6d;
  --accent3: #a8ff3e;
  --text: #e8eaf0;
  --muted: #6b7394;
  --gold: #ffd166;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  min-height: 100vh;
  overflow-x: hidden;
}
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image:
    linear-gradient(rgba(0,229,255,0.025) 1px, transparent 1px),
    linear-gradient(90deg, rgba(0,229,255,0.025) 1px, transparent 1px);
  background-size: 40px 40px;
  pointer-events: none;
  z-index: 0;
}
.app { position: relative; z-index: 1; max-width: 1280px; margin: 0 auto; padding: 0 16px 60px; }

/* HEADER */
header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 20px 0 16px;
  border-bottom: 1px solid var(--border);
  margin-bottom: 20px;
  flex-wrap: wrap; gap: 12px;
}
.logo-area h1 {
  font-family: 'Bebas Neue', sans-serif;
  font-size: clamp(24px,4vw,38px);
  letter-spacing: 3px; color: var(--accent); line-height: 1;
}
.logo-area p { font-size: 11px; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; margin-top: 3px; font-family: 'DM Mono', monospace; }
.pulse-dot { width:8px;height:8px;border-radius:50%;background:var(--accent3);box-shadow:0 0 8px var(--accent3);animation:pulse 2s infinite;display:inline-block;margin-right:6px; }
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.date-badge { font-family:'DM Mono',monospace;font-size:12px;color:var(--muted);background:var(--surface);border:1px solid var(--border);padding:6px 14px;border-radius:6px; }

/* TABS */
.tabs {
  display: flex; gap: 3px; margin-bottom: 20px;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 10px; padding: 4px; overflow-x: auto; flex-wrap: nowrap;
}
.tab-btn {
  flex-shrink: 0; padding: 9px 13px; border: none; background: transparent;
  color: var(--muted); font-family: 'DM Sans', sans-serif; font-size: 12px;
  font-weight: 500; cursor: pointer; border-radius: 7px; transition: all .2s;
  white-space: nowrap;
}
.tab-btn:hover { color: var(--text); background: var(--surface2); }
.tab-btn.active { background: var(--accent); color: #000; font-weight: 700; box-shadow: 0 0 16px rgba(0,229,255,.3); }

/* PANELS */
.panel { display: none; animation: fadeIn .3s ease; }
.panel.active { display: block; }
@keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:none}}

/* SECTION TITLE */
.section-title {
  font-family: 'Bebas Neue', sans-serif; font-size: 18px;
  letter-spacing: 2px; color: var(--accent); margin-bottom: 14px;
  display: flex; align-items: center; gap: 8px;
}
.section-title span { color: var(--muted); font-size: 12px; font-family: 'DM Sans', sans-serif; letter-spacing: 0; font-weight: 400; }

/* GRIDS */
.grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px,1fr)); gap: 14px; margin-bottom: 18px; }
.grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap: 14px; margin-bottom: 18px; }
.grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(170px,1fr)); gap: 12px; margin-bottom: 18px; }

/* CARD */
.card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 18px; transition: border-color .2s; }
.card:hover { border-color: rgba(0,229,255,.2); }

/* STAT CARDS */
.stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 16px; position: relative; overflow: hidden; transition: transform .2s, border-color .2s; }
.stat-card:hover { transform: translateY(-2px); border-color: rgba(0,229,255,.35); }
.stat-card::after { content:'';position:absolute;bottom:0;left:0;right:0;height:3px; }
.stat-card.cyan::after{background:var(--accent)} .stat-card.red::after{background:var(--accent2)}
.stat-card.green::after{background:var(--accent3)} .stat-card.gold::after{background:var(--gold)}
.stat-card.purple::after{background:#c084fc}
.stat-label { font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;font-family:'DM Mono',monospace;margin-bottom:6px; }
.stat-value { font-family:'Bebas Neue',sans-serif;font-size:36px;letter-spacing:1px;line-height:1; }
.stat-value.cyan{color:var(--accent)} .stat-value.red{color:var(--accent2)}
.stat-value.green{color:var(--accent3)} .stat-value.gold{color:var(--gold)} .stat-value.purple{color:#c084fc}
.stat-sub{font-size:12px;color:var(--muted);margin-top:5px}
.stat-sub.up{color:var(--accent3)} .stat-sub.down{color:var(--accent2)}

/* INPUTS */
input[type="text"],input[type="number"],input[type="date"],input[type="time"],select,textarea {
  background:var(--surface2);border:1px solid var(--border);border-radius:8px;
  color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;
  padding:9px 12px;width:100%;outline:none;transition:border-color .2s;
}
input:focus,select:focus,textarea:focus{border-color:var(--accent)}
input::placeholder,textarea::placeholder{color:var(--muted)}
input[type="file"]{background:var(--surface2);border:1px dashed var(--border);border-radius:8px;color:var(--muted);font-size:13px;padding:10px 12px;width:100%;cursor:pointer;}
input[type="file"]:hover{border-color:var(--accent)}

.input-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;font-family:'DM Mono',monospace;margin-bottom:5px}

/* BUTTONS */
.btn{border:none;border-radius:8px;padding:9px 16px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:var(--accent);color:#000}
.btn-primary:hover{box-shadow:0 0 18px rgba(0,229,255,.4);transform:translateY(-1px)}
.btn-danger{background:transparent;border:1px solid var(--accent2);color:var(--accent2);padding:5px 10px;font-size:12px;border-radius:6px}
.btn-danger:hover{background:var(--accent2);color:#fff}
.btn-ghost{background:transparent;border:1px solid var(--border);color:var(--muted)}
.btn-ghost:hover{border-color:var(--accent);color:var(--accent)}
.btn-green{background:var(--accent3);color:#000}
.btn-sm{padding:5px 11px;font-size:12px}

/* BADGES */
.badge{padding:3px 8px;border-radius:4px;font-size:10px;font-family:'DM Mono',monospace;font-weight:600;text-transform:uppercase;letter-spacing:1px}
.badge-red{background:rgba(255,77,109,.15);color:var(--accent2);border:1px solid rgba(255,77,109,.3)}
.badge-gold{background:rgba(255,209,102,.15);color:var(--gold);border:1px solid rgba(255,209,102,.3)}
.badge-green{background:rgba(168,255,62,.1);color:var(--accent3);border:1px solid rgba(168,255,62,.25)}
.badge-cyan{background:rgba(0,229,255,.1);color:var(--accent);border:1px solid rgba(0,229,255,.25)}
.badge-purple{background:rgba(192,132,252,.15);color:#c084fc;border:1px solid rgba(192,132,252,.3)}

/* FILTER ROW */
.filter-row{display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap}
.filter-chip{padding:5px 12px;border-radius:20px;font-size:12px;font-weight:500;cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--muted);transition:all .15s}
.filter-chip.active-chip{border-color:var(--accent);color:var(--accent);background:rgba(0,229,255,.08)}

/* PROGRESS */
.progress-bar{height:6px;background:var(--surface2);border-radius:3px;overflow:hidden;margin-top:8px}
.progress-fill{height:100%;background:var(--accent3);border-radius:3px;transition:width .4s ease}

/* TODO */
.todo-input-row{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap}
.todo-list{display:flex;flex-direction:column;gap:6px}
.todo-item{display:flex;align-items:center;gap:10px;padding:11px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;transition:all .2s}
.todo-item:hover{border-color:rgba(0,229,255,.2)}
.todo-item.done{opacity:.4}
.todo-item.done .todo-text{text-decoration:line-through;color:var(--muted)}
.todo-check{width:18px;height:18px;border-radius:4px;border:2px solid var(--border);cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all .2s;background:transparent}
.todo-check.checked{background:var(--accent3);border-color:var(--accent3)}
.todo-check.checked::after{content:'&#10003;';font-size:11px;color:#000;font-weight:700}
.todo-text{flex:1;font-size:14px}
.todo-priority{font-size:10px;font-family:'DM Mono',monospace;padding:2px 7px;border-radius:4px;text-transform:uppercase;letter-spacing:1px}
.prio-high{background:rgba(255,77,109,.15);color:var(--accent2);border:1px solid rgba(255,77,109,.3)}
.prio-mid{background:rgba(255,209,102,.15);color:var(--gold);border:1px solid rgba(255,209,102,.3)}
.prio-low{background:rgba(168,255,62,.1);color:var(--accent3);border:1px solid rgba(168,255,62,.25)}

/* LINKS */
.links-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
.link-card{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:16px 14px;text-align:center;cursor:pointer;transition:all .2s;text-decoration:none;display:block}
.link-card:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,229,255,.1)}
.link-icon{font-size:26px;margin-bottom:8px}
.link-name{font-size:12px;font-weight:600;color:var(--text);letter-spacing:.3px}
.link-desc{font-size:10px;color:var(--muted);margin-top:2px}

/* REVENUE CHART */
.chart-row{display:flex;align-items:center;gap:10px;margin-bottom:8px;font-size:13px}
.chart-label{width:70px;color:var(--muted);font-family:'DM Mono',monospace;font-size:11px}
.chart-bar-bg{flex:1;height:22px;background:var(--surface2);border-radius:4px;overflow:hidden}
.chart-bar{height:100%;border-radius:4px;display:flex;align-items:center;padding-left:8px;font-size:11px;font-weight:600;transition:width .6s ease}
.chart-val{width:60px;text-align:right;font-family:'DM Mono',monospace;font-size:12px;color:var(--muted)}
.metric-input-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}

/* OUTREACH */
.outreach-card{display:flex;align-items:center;gap:12px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:13px;margin-bottom:8px}
.avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:#000;flex-shrink:0}
.outreach-info{flex:1}
.outreach-name{font-size:14px;font-weight:600}
.outreach-meta{font-size:11px;color:var(--muted);margin-top:2px;font-family:'DM Mono',monospace}

/* CONVO NOTES */
.cn-card{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:15px;margin-bottom:10px;transition:border-color .2s}
.cn-card:hover{border-color:rgba(0,229,255,.25)}
.cn-card-header{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:8px}
.cn-person{font-size:15px;font-weight:600;flex:1}
.cn-body-text{font-size:13px;color:var(--muted);line-height:1.6;white-space:pre-wrap}
.cn-meta{font-size:11px;color:var(--muted);font-family:'DM Mono',monospace;margin-top:6px}

/* DOCS */
.doc-card{display:flex;align-items:center;gap:14px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:13px 16px;margin-bottom:8px;transition:border-color .2s}
.doc-card:hover{border-color:rgba(0,229,255,.3)}
.doc-icon{font-size:28px;flex-shrink:0}
.doc-info{flex:1}
.doc-name{font-size:14px;font-weight:600}
.doc-meta{font-size:11px;color:var(--muted);font-family:'DM Mono',monospace;margin-top:3px}

/* NOTES */
.notes-area{width:100%;min-height:130px;resize:vertical}

/* SHIFT HANDOFF */
.handoff-card{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:15px;margin-bottom:10px}
.handoff-header{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px}
.handoff-section{margin-bottom:10px}
.handoff-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;font-family:'DM Mono',monospace;margin-bottom:4px}
.handoff-text{font-size:13px;line-height:1.6;white-space:pre-wrap}

/* TRAINING TRIP */
.trip-card{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:15px;margin-bottom:10px;transition:border-color .2s}
.trip-card:hover{border-color:rgba(0,229,255,.25)}
.trip-header{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px}
.trip-title{font-size:15px;font-weight:600;flex:1}
.trainee-row{display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px solid var(--border)}
.trainee-row:last-child{border-bottom:none}
.trainee-name{flex:1;font-size:13px}
.trainee-check{width:16px;height:16px;border-radius:3px;border:2px solid var(--border);cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all .2s}
.trainee-check.checked{background:var(--accent3);border-color:var(--accent3)}
.trainee-check.checked::after{content:'&#10003;';font-size:9px;color:#000;font-weight:700}

/* WHO'S WORKING */
.whos-working{background:var(--surface);border:1px solid var(--accent);border-radius:12px;padding:18px;margin-bottom:20px;box-shadow:0 0 30px rgba(0,229,255,.07)}
.whos-working h2{font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:2px;color:var(--accent);margin-bottom:12px;display:flex;align-items:center;gap:8px}
.shift-pill{display:inline-flex;align-items:center;gap:6px;background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:5px 12px;font-size:12px;margin:3px;transition:all .2s}
.shift-pill:hover{border-color:var(--accent)}
.shift-pill .sp-name{font-weight:600}
.shift-pill .sp-time{color:var(--muted);font-family:'DM Mono',monospace;font-size:11px}
.schedule-drop-zone{border:2px dashed var(--border);border-radius:10px;padding:28px;text-align:center;cursor:pointer;transition:all .2s;margin-bottom:14px;position:relative}
.schedule-drop-zone:hover,.schedule-drop-zone.drag-over{border-color:var(--accent);background:rgba(0,229,255,.04)}
.schedule-drop-zone p{color:var(--muted);font-size:13px;margin-top:6px}
.schedule-drop-zone .drop-icon{font-size:32px}

/* AI Loading */
.ai-loading{display:flex;align-items:center;gap:8px;color:var(--accent);font-size:13px;padding:12px}
.spinner{width:16px;height:16px;border:2px solid rgba(0,229,255,.2);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;display:flex;align-items:center;justify-content:center;padding:16px;backdrop-filter:blur(4px)}
.modal-overlay.hidden{display:none}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:24px;width:100%;max-width:560px;max-height:85vh;overflow-y:auto}
.modal h3{font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:2px;color:var(--accent);margin-bottom:18px}
.modal-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}
.modal-footer{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}

/* DIVIDER */
.divider{border:none;border-top:1px solid var(--border);margin:18px 0}

/* iOS INSTALL BANNER */
.install-banner {
  display: none;
  background: linear-gradient(135deg, rgba(0,229,255,.15), rgba(168,255,62,.1));
  border: 1px solid rgba(0,229,255,.3);
  border-radius: 10px;
  padding: 12px 16px;
  margin-bottom: 16px;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}
.install-banner.visible { display: flex; }
.install-banner p { flex: 1; font-size: 13px; color: var(--text); min-width: 200px; }
.install-banner p strong { color: var(--accent); }


::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

@media(max-width:600px){
  .metric-input-grid,.modal-grid{grid-template-columns:1fr}
  .grid-4{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>
<!-- SYNC SETUP SCREEN -->
<div id="loginScreen" style="position:fixed;inset:0;background:var(--bg);z-index:200;display:flex;align-items:center;justify-content:center;padding:24px;">
  <div style="width:100%;max-width:400px">
    <div style="text-align:center;margin-bottom:32px">
      <div style="font-family:'Bebas Neue',sans-serif;font-size:48px;letter-spacing:4px;color:var(--accent)">ACTIVATE HQ</div>
      <div style="font-size:12px;color:var(--muted);letter-spacing:2px;text-transform:uppercase;font-family:'DM Mono',monospace;margin-top:4px">Lexington Command Center</div>
    </div>
    <div id="loginError" style="display:none;border-radius:8px;padding:10px 14px;font-size:13px;margin-bottom:14px"></div>
    <div style="margin-bottom:20px">
      <div class="input-label" style="margin-bottom:5px">Sync Key</div>
      <input type="password" id="loginPassword" placeholder="Enter your sync key (min 6 chars)" onkeydown="if(event.key==='Enter')handleLogin()">
      <div style="font-size:11px;color:var(--muted);margin-top:6px;font-family:'DM Mono',monospace">Same key on all your devices = shared data</div>
    </div>
    <button class="btn btn-primary" style="width:100%;justify-content:center;padding:13px" onclick="handleLogin()" id="loginBtn">Connect &#8594;</button>
    <div style="text-align:center;margin-top:14px;font-size:12px;color:var(--muted);font-family:'DM Mono',monospace">First time? Just enter any key you'll remember.<br>Use the same key on your iPhone to sync.</div>
  </div>
</div>

<div class="app">

<!-- SYNC STATUS BAR -->
<div id="syncBar" style="display:none;align-items:center;gap:8px;padding:6px 12px;background:var(--surface);border:1px solid var(--border);border-radius:8px;margin-bottom:12px;font-size:12px;font-family:'DM Mono',monospace">
  <div id="syncDot" style="width:8px;height:8px;border-radius:50%;background:var(--accent3);flex-shrink:0"></div>
  <span id="syncMsg" style="color:var(--muted);flex:1">Synced</span>
  <span id="syncUser" style="color:var(--muted)"></span>
  <button onclick="handleSignOut()" style="background:none;border:none;color:var(--accent2);font-size:11px;cursor:pointer;font-family:'DM Mono',monospace">Sign Out</button>
</div>

<!-- HEADER -->
<header>
  <div class="logo-area">
    <h1>Activate HQ</h1>
    <p><span class="pulse-dot"></span>Lexington Command Center</p>
  </div>
  <div>
    <div class="date-badge" id="dateBadge"></div>
  </div>
</header>

<!-- iOS INSTALL BANNER -->
<div class="install-banner" id="installBanner">
  <span style="font-size:24px">&#128242;</span>
  <p><strong>Install Activate HQ on your iPhone!</strong> Tap the Share button in Safari, then tap <strong>"Add to Home Screen"</strong> to use this as a full-screen app.</p>
  <button class="btn btn-ghost btn-sm" onclick="dismissBanner()">Dismiss</button>
</div>

<!-- TABS -->
<div class="tabs">
  <button class="tab-btn active" onclick="switchTab('home')">&#127968; Home</button>
  <button class="tab-btn" onclick="switchTab('tasks')">&#9989; Tasks</button>
  <button class="tab-btn" onclick="switchTab('time')">&#9201; Time</button>
  <button class="tab-btn" onclick="switchTab('convonotes')">&#128172; Conv. Notes</button>
  <button class="tab-btn" onclick="switchTab('handoff')">&#128203; Shift Handoff</button>
  <button class="tab-btn" onclick="switchTab('trips')">&#9992;&#65039; Training Trips</button>
  <button class="tab-btn" onclick="switchTab('links')">&#128279; Quick Links</button>
  <button class="tab-btn" onclick="switchTab('docs')">&#128194; Docs</button>
  <button class="tab-btn" onclick="switchTab('outreach')">&#127918; Outreach</button>
  <button class="tab-btn" onclick="switchTab('notes')">&#128221; Notes</button>
  <button class="tab-btn" onclick="switchTab('export')">&#128190; Export</button>
</div>

<!-- ===== HOME PANEL ===== -->
<div id="panel-home" class="panel active">

  <!-- WHO'S WORKING TODAY -->
  <div class="whos-working">
    <h2>&#128119; On Shift Now <span id="todayDateLabel" style="font-size:12px;color:var(--muted);font-family:'DM Mono',monospace;font-weight:400;letter-spacing:1px"></span></h2>
    <div id="whosWorkingDisplay">
      <div style="color:var(--muted);font-size:13px">No schedule loaded yet &#8212; upload your ADP screenshot in the Schedule tab or below.</div>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn btn-ghost btn-sm" onclick="switchTab('schedule')">&#128248; Upload Schedule</button>
    </div>
  </div>

  <!-- QUICK STATS -->
  <div class="grid-4">
    <div class="stat-card cyan">
      <div class="stat-label">Tasks Today</div>
      <div class="stat-value cyan" id="home-tasks">0</div>
      <div class="stat-sub" id="home-tasks-sub">pending</div>
    </div>
    <div class="stat-card gold">
      <div class="stat-label">Open Conv. Notes</div>
      <div class="stat-value gold" id="home-cn">0</div>
      <div class="stat-sub">need follow-up</div>
    </div>
    <div class="stat-card red">
      <div class="stat-label">Outreach Due</div>
      <div class="stat-value red" id="home-out">0</div>
      <div class="stat-sub">return players</div>
    </div>
  </div>

  <!-- QUICK TODO -->
  <div class="card">
    <div class="section-title" style="font-size:15px;margin-bottom:10px">&#9889; Quick Add Task</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <input type="text" id="home-todo-input" placeholder="Add a quick task..." style="flex:1;min-width:180px" onkeydown="if(event.key==='Enter')homeAddTodo()">
      <select id="home-todo-prio" style="width:100px">
        <option value="high">&#128308; High</option>
        <option value="mid" selected>&#128993; Mid</option>
        <option value="low">&#128994; Low</option>
      </select>
      <button class="btn btn-primary" onclick="homeAddTodo()">+ Add</button>
    </div>
    <div style="margin-top:12px" id="home-todo-preview"></div>
  </div>
</div>

<!-- ===== SCHEDULE / AI READER PANEL ===== -->
<div id="panel-schedule" class="panel">
  <div class="section-title">Schedule Reader <span>&#8212; drop your ADP screenshot, AI extracts the roster</span></div>

  <div class="card" style="margin-bottom:16px">
    <div style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;margin-bottom:14px">
      <div style="flex:2;min-width:200px">
        <div class="input-label">Anthropic API Key</div>
        <input type="password" id="sched-api-key" placeholder="sk-ant-..." style="font-family:'DM Mono',monospace;font-size:12px"
          oninput="localStorage.setItem('ag_anthropic_key',this.value)"
          value="">
      </div>
      <div style="flex:1;min-width:140px">
        <div class="input-label">Schedule Week Start</div>
        <input type="date" id="sched-week-start">
      </div>
    </div>
    <div class="schedule-drop-zone" id="dropZone" onclick="document.getElementById('schedFileInput').click()"
      ondragover="event.preventDefault();this.classList.add('drag-over')"
      ondragleave="this.classList.remove('drag-over')"
      ondrop="handleSchedDrop(event)">
      <div class="drop-icon">&#128248;</div>
      <div style="font-size:15px;font-weight:600;margin-top:8px">Drop Schedule Screenshot Here</div>
      <p>or click to browse &#8212; PNG, JPG supported</p>
      <input type="file" id="schedFileInput" accept="image/*" style="display:none" onchange="handleSchedFile(this)">
    </div>
    <div style="font-size:12px;color:var(--muted);margin-top:8px">
      AI reads the screenshot and extracts every employee + shift time. Review before saving.
    </div>
  </div>

  <div id="schedPreviewArea"></div>

  <div id="savedSchedules">
    <div class="section-title" style="font-size:15px;margin-top:8px">Saved Schedules</div>
    <div id="savedSchedList"></div>
  </div>
</div>

<!-- ===== TASKS PANEL ===== -->
<div id="panel-tasks" class="panel">
  <div class="grid-4">
    <div class="stat-card cyan"><div class="stat-label">Total Tasks</div><div class="stat-value cyan" id="stat-total">0</div><div class="stat-sub">today's list</div></div>
    <div class="stat-card green"><div class="stat-label">Completed</div><div class="stat-value green" id="stat-done">0</div><div class="stat-sub">knocked out</div></div>
    <div class="stat-card red"><div class="stat-label">High Priority</div><div class="stat-value red" id="stat-high">0</div><div class="stat-sub">needs attention</div></div>
    <div class="stat-card gold"><div class="stat-label">Completion</div><div class="stat-value gold" id="stat-pct">0%</div><div class="stat-sub">keep going!</div></div>
  </div>
  <div class="card">
    <div class="progress-bar" style="margin-bottom:18px;height:8px"><div class="progress-fill" id="taskProgress" style="width:0%"></div></div>
    <div class="todo-input-row">
      <input type="text" id="todoInput" placeholder="Add a task..." onkeydown="if(event.key==='Enter')addTodo()" style="flex:1;min-width:160px">
      <select id="todoCategory" style="width:110px">
        <option value="ops">&#127970; Ops</option>
        <option value="hr">&#128100; HR/Staff</option>
        <option value="hospitality">&#127918; Guest Exp</option>
        <option value="training">&#128203; Training</option>
        <option value="admin">&#9881;&#65039; Admin</option>
      </select>
      <select id="todoPriority" style="width:100px">
        <option value="high">&#128308; High</option>
        <option value="mid">&#128993; Mid</option>
        <option value="low">&#128994; Low</option>
      </select>
      <button class="btn btn-primary" onclick="addTodo()">+ Add</button>
    </div>
    <div class="filter-row">
      <button class="filter-chip active-chip" onclick="setFilter('all',this)">All</button>
      <button class="filter-chip" onclick="setFilter('high',this)">&#128308; High</button>
      <button class="filter-chip" onclick="setFilter('mid',this)">&#128993; Mid</button>
      <button class="filter-chip" onclick="setFilter('low',this)">&#128994; Low</button>
      <button class="filter-chip" onclick="setFilter('active',this)">Active</button>
      <button class="filter-chip" onclick="setFilter('done',this)">Done</button>
      <button class="filter-chip" onclick="clearDone()" style="margin-left:auto">&#128465; Clear Done</button>
    </div>
    <div class="todo-list" id="todoList"></div>
  </div>
</div>

<!-- ===== TIME MANAGEMENT PANEL ===== -->
<div id="panel-time" class="panel">
  <div class="section-title">Time Management <span>&#8212; log your time, build your routine</span></div>

  <!-- CURRENT ACTIVITY CARD -->
  <div class="card" style="margin-bottom:16px;border-color:rgba(0,229,255,.25);background:linear-gradient(135deg,rgba(0,229,255,.04),rgba(168,255,62,.02))">
    <div id="tm-idle" style="text-align:center;padding:12px 0;color:var(--muted);font-size:14px">
      No active task &#8212; tap a task below to start tracking
    </div>
    <div id="tm-active" style="display:none">
      <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap">
        <div id="tm-active-icon" style="font-size:38px"></div>
        <div style="flex:1;min-width:0">
          <div id="tm-active-label" style="font-family:'Bebas Neue',sans-serif;font-size:26px;letter-spacing:2px"></div>
          <div id="tm-active-started" style="font-size:12px;color:var(--muted);font-family:'DM Mono',monospace;margin-top:2px"></div>
        </div>
        <div style="text-align:right;flex-shrink:0">
          <div id="tm-active-timer" style="font-family:'Bebas Neue',sans-serif;font-size:34px;letter-spacing:2px;color:var(--accent3)">0:00</div>
          <button class="btn btn-danger btn-sm" onclick="stopTimeTask()" style="margin-top:6px;width:100%">&#9209; Stop / Break</button>
        </div>
      </div>
    </div>
  </div>

  <!-- TASK BUTTONS -->
  <div class="card" style="margin-bottom:16px">
    <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;font-family:'DM Mono',monospace;margin-bottom:12px">Tap to log current task</div>
    <div id="tm-task-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:8px"></div>
  </div>

  <!-- CHARTS -->
  <div class="grid-2" style="margin-bottom:16px">
    <!-- TODAY -->
    <div class="card">
      <div class="section-title" style="font-size:14px;margin-bottom:14px">&#128202; Today's Breakdown</div>
      <div style="display:flex;gap:16px;align-items:center;flex-wrap:wrap">
        <div id="tm-pie-today"></div>
        <div id="tm-legend-today" style="flex:1;min-width:130px"></div>
      </div>
      <div id="tm-today-total" style="font-size:11px;color:var(--muted);font-family:'DM Mono',monospace;margin-top:10px"></div>
    </div>
    <!-- WEEKLY -->
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px">
        <div class="section-title" style="font-size:14px;margin-bottom:0">&#128197; Weekly Breakdown</div>
        <div style="display:flex;gap:4px;flex-shrink:0">
          <button class="filter-chip active-chip" id="tm-btn-this" onclick="setTMWeekView('this',this)">This Week</button>
          <button class="filter-chip" id="tm-btn-last" onclick="setTMWeekView('last',this)">Last Week</button>
        </div>
      </div>
      <div style="display:flex;gap:16px;align-items:center;flex-wrap:wrap">
        <div id="tm-pie-week"></div>
        <div id="tm-legend-week" style="flex:1;min-width:130px"></div>
      </div>
      <div id="tm-week-total" style="font-size:11px;color:var(--muted);font-family:'DM Mono',monospace;margin-top:10px"></div>
    </div>
  </div>

  <!-- TODAY'S LOG -->
  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px">
      <div class="section-title" style="font-size:14px;margin-bottom:0">&#128336; Today's Log</div>
      <button class="filter-chip" onclick="clearTodayTMLog()" style="color:var(--accent2);border-color:rgba(255,77,109,.4)">&#128465; Clear Today</button>
    </div>
    <div id="tm-log-list"></div>
  </div>
</div>

<!-- ===== CONV NOTES PANEL ===== -->
<div id="panel-convonotes" class="panel">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px">
    <div class="section-title" style="margin-bottom:0">Employee Documentation <span>&#8212; formal records & HR notes</span></div>
    <button class="btn btn-primary" onclick="openCNModal()">+ New Documentation</button>
  </div>
  <div class="filter-row" id="cn-filters">
    <button class="filter-chip active-chip" onclick="setCNFilter('all',this)">All</button>
    <button class="filter-chip" onclick="setCNFilter('verbal',this)">&#128483; Verbal</button>
    <button class="filter-chip" onclick="setCNFilter('first_written',this)">&#128196; 1st Written</button>
    <button class="filter-chip" onclick="setCNFilter('second_written',this)">&#128203; 2nd Written</button>
    <button class="filter-chip" onclick="setCNFilter('final_written',this)">&#128680; Final</button>
    <button class="filter-chip" onclick="setCNFilter('pip',this)">&#128200; PIP</button>
    <button class="filter-chip" onclick="setCNFilter('general',this)">&#128206; General</button>
    <button class="filter-chip" onclick="setCNFilter('praise',this)">&#11088; Praise</button>
    <button class="filter-chip" onclick="setCNFilter('open',this)">&#128993; Open</button>
    <button class="filter-chip" onclick="setCNFilter('resolved',this)">&#9989; Resolved</button>
  </div>
  <div id="cn-list"></div>
</div>

<!-- ===== SHIFT HANDOFF PANEL ===== -->
<div id="panel-handoff" class="panel">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px">
    <div class="section-title" style="margin-bottom:0">Shift Handoff <span>&#8212; live from Google Forms &#183; last 5 submissions</span></div>
    <div style="display:flex;align-items:center;gap:10px">
      <span id="ho-last-update" style="font-size:11px;color:var(--muted);font-family:'DM Mono',monospace"></span>
      <button class="btn btn-ghost btn-sm" onclick="fetchGFormHandoffs(true)">&#128260; Refresh</button>
    </div>
  </div>
  <div id="gform-handoff-list">
    <div style="text-align:center;padding:48px;color:var(--muted);font-size:14px">Loading responses...</div>
  </div>
</div>

<!-- ===== TRAINING TRIPS PANEL ===== -->
<div id="panel-trips" class="panel">
  <div class="section-title">Training Trips <span>&#8212; location openings & GM training tracker</span></div>
  <div class="card" style="margin-bottom:16px">
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(175px,1fr));gap:10px;margin-bottom:12px">
      <div><div class="input-label">Location / City</div><input type="text" id="trip-loc" placeholder="e.g. Nashville, TN"></div>
      <div><div class="input-label">Trip Type</div>
        <select id="trip-type">
          <option value="opening">&#127978; New Location Opening</option>
          <option value="gm">&#128100; GM Training</option>
          <option value="support">&#129309; Support Visit</option>
        </select>
      </div>
      <div><div class="input-label">Start Date</div><input type="date" id="trip-start"></div>
      <div><div class="input-label">End Date</div><input type="date" id="trip-end"></div>
      <div style="grid-column:1/-1"><div class="input-label">Notes</div><input type="text" id="trip-notes" placeholder="Hotel, contact person, special focus areas..."></div>
    </div>
    <div style="margin-bottom:12px">
      <div class="input-label" style="margin-bottom:5px">Trainees (one per line)</div>
      <textarea id="trip-trainees" placeholder="John Smith&#10;Jane Doe&#10;..." style="min-height:80px;resize:vertical;width:100%"></textarea>
    </div>
    <button class="btn btn-primary" onclick="addTrip()">+ Add Trip</button>
  </div>
  <div class="filter-row" id="trip-filters">
    <button class="filter-chip active-chip" onclick="setTripFilter('all',this)">All</button>
    <button class="filter-chip" onclick="setTripFilter('upcoming',this)">&#128467; Upcoming</button>
    <button class="filter-chip" onclick="setTripFilter('opening',this)">&#127978; Openings</button>
    <button class="filter-chip" onclick="setTripFilter('gm',this)">&#128100; GM Training</button>
    <button class="filter-chip" onclick="setTripFilter('complete',this)">&#9989; Complete</button>
  </div>
  <div id="tripsList"></div>
</div>

<!-- ===== LINKS PANEL ===== -->
<div id="panel-links" class="panel">
  <div class="section-title">Quick Links <span>&#8212; click to open in new tab</span></div>
  <div class="links-grid" id="linksGrid"></div>
  <hr class="divider">
  <div class="section-title" style="font-size:15px">Add Custom Link</div>
  <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end">
    <div style="flex:1;min-width:130px"><div class="input-label">Name</div><input type="text" id="link-name" placeholder="My Tool"></div>
    <div style="flex:2;min-width:190px"><div class="input-label">URL</div><input type="text" id="link-url" placeholder="https://..."></div>
    <div style="flex:1;min-width:110px"><div class="input-label">Icon (emoji)</div><input type="text" id="link-icon" placeholder="&#128295;"></div>
    <div style="flex:1;min-width:110px"><div class="input-label">Description</div><input type="text" id="link-desc" placeholder="What it does"></div>
    <button class="btn btn-primary" onclick="addCustomLink()">+ Add</button>
  </div>
</div>

<!-- ===== DOCS PANEL ===== -->
<div id="panel-docs" class="panel">
  <div class="section-title">Docs & References <span>&#8212; upload files for quick access</span></div>
  <div class="card" style="margin-bottom:18px">
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(175px,1fr));gap:10px;margin-bottom:12px">
      <div style="grid-column:1/-1"><div class="input-label" style="margin-bottom:5px">Upload File</div>
        <input type="file" id="doc-file" accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg,.txt,.csv,.ppt,.pptx">
      </div>
      <div><div class="input-label">Label / Title</div><input type="text" id="doc-name" placeholder="e.g. Opening Checklist"></div>
      <div><div class="input-label">Category</div>
        <select id="doc-cat">
          <option value="ops">&#127970; Operations</option>
          <option value="training">&#128203; Training</option>
          <option value="hr">&#128100; HR / Staff</option>
          <option value="reference">&#128204; Quick Reference</option>
          <option value="travel">&#9992;&#65039; Travel</option>
          <option value="other">&#128193; Other</option>
        </select>
      </div>
    </div>
    <button class="btn btn-primary" onclick="uploadDoc()">&#128206; Save Document</button>
    <span style="font-size:11px;color:var(--muted);margin-left:10px">Stored locally in your browser</span>
  </div>
  <div class="filter-row" id="doc-filters">
    <button class="filter-chip active-chip" onclick="setDocFilter('all',this)">All</button>
    <button class="filter-chip" onclick="setDocFilter('ops',this)">&#127970; Ops</button>
    <button class="filter-chip" onclick="setDocFilter('training',this)">&#128203; Training</button>
    <button class="filter-chip" onclick="setDocFilter('hr',this)">&#128100; HR</button>
    <button class="filter-chip" onclick="setDocFilter('reference',this)">&#128204; Reference</button>
    <button class="filter-chip" onclick="setDocFilter('travel',this)">&#9992;&#65039; Travel</button>
  </div>
  <div id="docsList"></div>
</div>

<!-- ===== OUTREACH PANEL ===== -->
<div id="panel-outreach" class="panel">
  <div class="section-title">Return Player Outreach</div>
  <div class="card" style="margin-bottom:16px">
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;margin-bottom:12px">
      <div><div class="input-label">Player Name</div><input type="text" id="out-name" placeholder="Jane Smith"></div>
      <div><div class="input-label">Last Visit</div><input type="date" id="out-date"></div>
      <div><div class="input-label">Contact</div><input type="text" id="out-contact" placeholder="email or phone"></div>
      <div><div class="input-label">Status</div>
        <select id="out-status">
          <option value="due">&#128236; Due</option>
          <option value="overdue">&#128308; Overdue</option>
          <option value="done">&#9989; Contacted</option>
        </select>
      </div>
    </div>
    <button class="btn btn-primary" onclick="addOutreach()">+ Add Player</button>
  </div>
  <div id="outreachList"></div>
</div>

<!-- ===== NOTES PANEL ===== -->
<div id="panel-notes" class="panel">
  <div class="section-title">Quick Notes <span>&#8212; auto-saved locally</span></div>
  <div class="grid-2">
    <div class="card"><div class="input-label" style="margin-bottom:7px">Shift Notes / Daily Log</div>
      <textarea class="notes-area" id="note-shift" placeholder="Shift observations, guest feedback, incidents..."></textarea>
      <div style="display:flex;justify-content:flex-end;margin-top:8px"><button class="btn btn-primary btn-sm" onclick="saveNote('shift')">Save</button></div>
    </div>
    <div class="card"><div class="input-label" style="margin-bottom:7px">Training Notes</div>
      <textarea class="notes-area" id="note-training" placeholder="Trainee observations, coaching moments..."></textarea>
      <div style="display:flex;justify-content:flex-end;margin-top:8px"><button class="btn btn-primary btn-sm" onclick="saveNote('training')">Save</button></div>
    </div>
    <div class="card"><div class="input-label" style="margin-bottom:7px">GM Opening Checklist Notes</div>
      <textarea class="notes-area" id="note-opening" placeholder="Opening walk-through notes, equipment status..."></textarea>
      <div style="display:flex;justify-content:flex-end;margin-top:8px"><button class="btn btn-primary btn-sm" onclick="saveNote('opening')">Save</button></div>
    </div>
    <div class="card"><div class="input-label" style="margin-bottom:7px">Travel / Location Visit Notes</div>
      <textarea class="notes-area" id="note-travel" placeholder="Opening week notes, location-specific observations..."></textarea>
      <div style="display:flex;justify-content:flex-end;margin-top:8px"><button class="btn btn-primary btn-sm" onclick="saveNote('travel')">Save</button></div>
    </div>
  </div>
</div>

<!-- ===== EXPORT PANEL ===== -->
<div id="panel-export" class="panel">
  <div class="section-title">Export & Backup <span>&#8212; download your data for Google Sheets or safekeeping</span></div>

  <!-- FULL BACKUP -->
  <div class="card" style="margin-bottom:18px;border-color:rgba(0,229,255,.3)">
    <div style="display:flex;align-items:center;gap:14px;flex-wrap:wrap">
      <div style="font-size:32px">&#128452;&#65039;</div>
      <div style="flex:1">
        <div style="font-size:15px;font-weight:600;margin-bottom:4px">Full Backup (JSON)</div>
        <div style="font-size:13px;color:var(--muted)">Exports everything &#8212; tasks, notes, trips, outreach, handoffs, conversation notes, time logs. Use this to restore your data on a new browser or device.</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <button class="btn btn-primary" onclick="exportFullBackup()">&#11015; Download Backup</button>
        <label class="btn btn-ghost" style="cursor:pointer;text-align:center">
          &#128194; Restore from Backup
          <input type="file" accept=".json" style="display:none" onchange="restoreBackup(this)">
        </label>
      </div>
    </div>
  </div>

  <!-- CSV EXPORTS -->
  <div class="section-title" style="font-size:15px">Export to CSV <span>&#8212; open directly in Google Sheets</span></div>
  <div style="font-size:13px;color:var(--muted);margin-bottom:14px">Download any dataset as a .csv file, then drag it into Google Sheets or go to <strong style="color:var(--text)">File &#8594; Import</strong> in Sheets to load it.</div>

  <div class="grid-2">
    <div class="card" style="display:flex;align-items:center;gap:12px">
      <div style="font-size:28px">&#9989;</div>
      <div style="flex:1">
        <div style="font-weight:600;margin-bottom:2px">Tasks</div>
        <div id="export-tasks-count" style="font-size:12px;color:var(--muted)"></div>
      </div>
      <button class="btn btn-ghost btn-sm" onclick="exportCSV('tasks')">&#11015; CSV</button>
    </div>

    <div class="card" style="display:flex;align-items:center;gap:12px">
      <div style="font-size:28px">&#128172;</div>
      <div style="flex:1">
        <div style="font-weight:600;margin-bottom:2px">Conversation Notes</div>
        <div id="export-cn-count" style="font-size:12px;color:var(--muted)"></div>
      </div>
      <button class="btn btn-ghost btn-sm" onclick="exportCSV('convonotes')">&#11015; CSV</button>
    </div>

    <div class="card" style="display:flex;align-items:center;gap:12px">
      <div style="font-size:28px">&#128203;</div>
      <div style="flex:1">
        <div style="font-weight:600;margin-bottom:2px">Shift Handoffs</div>
        <div id="export-handoff-count" style="font-size:12px;color:var(--muted)"></div>
      </div>
      <button class="btn btn-ghost btn-sm" onclick="exportCSV('handoffs')">&#11015; CSV</button>
    </div>

    <div class="card" style="display:flex;align-items:center;gap:12px">
      <div style="font-size:28px">&#9992;&#65039;</div>
      <div style="flex:1">
        <div style="font-weight:600;margin-bottom:2px">Training Trips</div>
        <div id="export-trips-count" style="font-size:12px;color:var(--muted)"></div>
      </div>
      <button class="btn btn-ghost btn-sm" onclick="exportCSV('trips')">&#11015; CSV</button>
    </div>

    <div class="card" style="display:flex;align-items:center;gap:12px">
      <div style="font-size:28px">&#127918;</div>
      <div style="flex:1">
        <div style="font-weight:600;margin-bottom:2px">Return Player Outreach</div>
        <div id="export-outreach-count" style="font-size:12px;color:var(--muted)"></div>
      </div>
      <button class="btn btn-ghost btn-sm" onclick="exportCSV('outreach')">&#11015; CSV</button>
    </div>

    <div class="card" style="display:flex;align-items:center;gap:12px">
      <div style="font-size:28px">&#128197;</div>
      <div style="flex:1">
        <div style="font-weight:600;margin-bottom:2px">Schedules</div>
        <div id="export-sched-count" style="font-size:12px;color:var(--muted)"></div>
      </div>
      <button class="btn btn-ghost btn-sm" onclick="exportCSV('schedules')">&#11015; CSV</button>
    </div>
  </div>

  <!-- HOW TO USE IN SHEETS -->
  <div class="card" style="margin-top:6px;border-color:rgba(168,255,62,.2)">
    <div style="font-size:13px;font-weight:600;color:var(--accent3);margin-bottom:8px">&#128203; How to get this into Google Sheets</div>
    <div style="font-size:13px;color:var(--muted);line-height:1.8">
      1. Click any <strong style="color:var(--text)">&#11015; CSV</strong> button to download that dataset<br>
      2. Open <strong style="color:var(--text)">Google Sheets</strong> &#8594; create a new sheet<br>
      3. Go to <strong style="color:var(--text)">File &#8594; Import &#8594; Upload</strong> &#8594; drag your CSV file in<br>
      4. Select <strong style="color:var(--text)">"Replace spreadsheet"</strong> or <strong style="color:var(--text)">"Insert new sheet"</strong><br>
      5. Your data is now live in Sheets &#8212; viewable from any device!
    </div>
  </div>
</div>


<!-- CN DOCUMENTATION MODAL -->
<div class="modal-overlay hidden" id="cnModal">
  <div class="modal" style="max-width:700px;max-height:92vh;overflow-y:auto">
    <!-- Step 1: Choose type -->
    <div id="cn-step1">
      <h3>New Employee Documentation</h3>
      <p style="color:var(--muted);font-size:13px;margin-bottom:18px">What type of documentation do you need to create?</p>
      <div id="cn-type-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:10px;margin-bottom:18px"></div>
      <div style="display:flex;justify-content:flex-end">
        <button class="btn btn-ghost" onclick="closeCNModal()">Cancel</button>
      </div>
    </div>
    <!-- Step 2: Fill form -->
    <div id="cn-step2" style="display:none">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:18px">
        <button onclick="cnGoBack()" class="btn btn-ghost btn-sm">&#8592; Back</button>
        <h3 id="cn-modal-title" style="margin:0;flex:1;font-size:20px"></h3>
      </div>
      <p id="cn-modal-desc" style="color:var(--muted);font-size:12px;margin-bottom:16px;font-family:'DM Mono',monospace"></p>
      <div id="cn-form-fields"></div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeCNModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveCNRecord()">&#128190; Save Record</button>
      </div>
    </div>
  </div>
</div>

</div><!-- end .app -->

<script>
// \u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}
// SYNC \u{2014} Direct REST API (no auth SDK \u{2014} avoids LockManager bug)
// \u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}
const SB_URL = 'https://pemmhbdggpgzykljchel.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBlbW1oYmRnZ3BnenlrbGpjaGVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNDczNjgsImV4cCI6MjA4NzYyMzM2OH0.yPgAcVlfExTWxqcIPwpcCvOa6WosfLn7ha14edu1XMA';
// Sync uses a fixed row key per "account" \u{2014} stored as sync_id in localStorage
// No auth SDK needed \u{2014} tables use open RLS with sync_id as the key
let syncId = localStorage.getItem('ag_sync_id') || null;
let syncTimeout = null;
let currentUser = { id: syncId }; // compatibility shim

const TABLES = {
  todos:'ag_todos', customLinks:'ag_links',
  outreachList:'ag_outreach', convoNotes:'ag_convonotes',
  handoffs:'ag_handoffs', trips:'ag_trips', schedules:'ag_schedules',
  timeLog:'ag_timelog'
};

function sbHeaders() {
  return { 'apikey': SB_KEY, 'Authorization': 'Bearer ' + SB_KEY, 'Content-Type': 'application/json', 'Prefer': 'resolution=merge-duplicates' };
}

async function syncToCloud(key, data) {
  if (!syncId) return;
  const table = TABLES[key];
  if (!table) return;
  setSyncStatus('syncing', 'Saving...');
  clearTimeout(syncTimeout);
  syncTimeout = setTimeout(async () => {
    try {
      const resp = await fetch(`${SB_URL}/rest/v1/${table}`, {
        method: 'POST',
        headers: { ...sbHeaders(), 'Prefer': 'resolution=merge-duplicates' },
        body: JSON.stringify({ sync_id: syncId, data: data })
      });
      if (!resp.ok) throw new Error(await resp.text());
      setSyncStatus('synced', 'Synced \u{2713}');
    } catch(e) {
      setSyncStatus('error', 'Sync failed \u{2014} saved locally');
      console.error('Sync error:', e);
    }
  }, 600);
}

// \u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}
// STATE
// \u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}
let todos      = JSON.parse(localStorage.getItem('ag_todos')     || '[]');
let customLinks= JSON.parse(localStorage.getItem('ag_links')     || '[]');
let outreachList=JSON.parse(localStorage.getItem('ag_outreach')  || '[]');
let convoNotes = JSON.parse(localStorage.getItem('ag_convonotes')|| '[]');
let docs       = JSON.parse(localStorage.getItem('ag_docs')      || '[]');
let handoffs   = JSON.parse(localStorage.getItem('ag_handoffs')  || '[]');
let trips      = JSON.parse(localStorage.getItem('ag_trips')     || '[]');
let schedules  = JSON.parse(localStorage.getItem('ag_schedules') || '[]');
let timeLog    = JSON.parse(localStorage.getItem('ag_timelog')   || '[]');
let activeTimeEntry = JSON.parse(localStorage.getItem('ag_active_time') || 'null');
let currentFilter = 'all';
let cnFilter = 'all';
let docFilter = 'all';
let tripFilter = 'all';

const defaultLinks = [
  { name:'Google Workspace', url:'https://workspace.google.com', icon:'\u{1F4C1}', desc:'Drive / Sheets / Docs' }
];

// \u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}
// CLOCK & TABS
// \u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}
function updateDate() {
  const now = new Date();
  document.getElementById('dateBadge').textContent =
    now.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'})
    + '  ' + now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const today = now.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
  const lbl = document.getElementById('todayDateLabel');
  if(lbl) lbl.textContent = today + ' \u00B7 ' + now.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
  if(now.getSeconds()===0) updateHomeStats();
}

function initDateInputs() {
  const d = new Date().toISOString().split('T')[0];
  ['inp-date','out-date','cn-date','ho-date','trip-start','trip-end'].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.value = d;
  });
}

function switchTab(name) {
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  const panel = document.getElementById('panel-'+name);
  if(panel) panel.classList.add('active');
  const btns = document.querySelectorAll('.tab-btn');
  btns.forEach(b=>{ if(b.getAttribute('onclick')&&b.getAttribute('onclick').includes("'"+name+"'")) b.classList.add('active'); });
  updateHomeStats();
}

// \u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}
// HELPERS
// \u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}
function escHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function avatarColor(name){
  const colors=['linear-gradient(135deg,#00e5ff,#a8ff3e)','linear-gradient(135deg,#ff4d6d,#ffd166)','linear-gradient(135deg,#c084fc,#00e5ff)','linear-gradient(135deg,#ffd166,#a8ff3e)','linear-gradient(135deg,#ff4d6d,#c084fc)'];
  let h=0;for(let c of (name||''))h=(h*31+c.charCodeAt(0))%colors.length;
  return colors[h];
}
function initials(name){ return (name||'?').split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2); }
function fmtDate(d){ if(!d)return'\u{2014}'; try{return new Date(d+'T00:00').toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}catch(e){return d} }

// \u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}
// HOME STATS
// \u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}
function updateHomeStats(){
  const pending = todos.filter(t=>!t.done).length;
  document.getElementById('home-tasks').textContent = pending;
  document.getElementById('home-tasks-sub').textContent = pending===1?'pending task':'pending tasks';

  // Who's working today / right now
  const now = new Date();
  const todayStr = now.toISOString().split('T')[0];
  const nowMin = now.getHours() * 60 + now.getMinutes();

  function parseShiftMins(timeStr) {
    if (!timeStr) return null;
    const m = timeStr.match(/(\d{1,2}:\d{2})\s*(AM|PM)\s*[-\u2013]\s*(\d{1,2}:\d{2})\s*(AM|PM)/i);
    if (!m) return null;
    const toMin = (t, p) => {
      let [h, mn] = t.split(':').map(Number);
      if (p.toUpperCase() === 'PM' && h !== 12) h += 12;
      if (p.toUpperCase() === 'AM' && h === 12) h = 0;
      return h * 60 + mn;
    };
    return { start: toMin(m[1], m[2]), end: toMin(m[3], m[4]) };
  }

  let todayShifts = [];
  schedules.forEach(s => {
    if (s.shifts) s.shifts.forEach(sh => { if (sh.date === todayStr) todayShifts.push(sh); });
  });

  const onNow    = todayShifts.filter(sh => { const t = parseShiftMins(sh.time); return t ? nowMin >= t.start && nowMin < t.end : true; });
  const upcoming = todayShifts.filter(sh => { const t = parseShiftMins(sh.time); return t && nowMin < t.start; });
  const done     = todayShifts.filter(sh => { const t = parseShiftMins(sh.time); return t && nowMin >= t.end; });

  const wwd = document.getElementById('whosWorkingDisplay');
  if (todayShifts.length > 0) {
    let html = '';
    if (onNow.length > 0) {
      html += `<div style="font-size:11px;color:var(--accent3);font-family:'DM Mono',monospace;letter-spacing:1px;text-transform:uppercase;margin-bottom:6px">\u{1F7E2} On Shift Now</div>`;
      html += onNow.map(sh => `<span class="shift-pill" style="border-color:var(--accent3)"><span class="sp-name">${escHtml(sh.name)}</span><span class="sp-time">${escHtml(sh.time||'')}</span></span>`).join('');
    }
    if (upcoming.length > 0) {
      html += `<div style="font-size:11px;color:var(--muted);font-family:'DM Mono',monospace;letter-spacing:1px;text-transform:uppercase;margin:${onNow.length?'10px':0} 0 6px">\u{23F0} Coming In</div>`;
      html += upcoming.map(sh => `<span class="shift-pill"><span class="sp-name">${escHtml(sh.name)}</span><span class="sp-time">${escHtml(sh.time||'')}</span></span>`).join('');
    }
    if (done.length > 0) {
      html += `<div style="font-size:11px;color:var(--muted);font-family:'DM Mono',monospace;letter-spacing:1px;text-transform:uppercase;margin:${(onNow.length||upcoming.length)?'10px':0} 0 6px;opacity:.6">\u{2713} Done Today</div>`;
      html += done.map(sh => `<span class="shift-pill" style="opacity:.5"><span class="sp-name">${escHtml(sh.name)}</span><span class="sp-time">${escHtml(sh.time||'')}</span></span>`).join('');
    }
    wwd.innerHTML = html;
  } else {
    wwd.innerHTML = '<div style="color:var(--muted);font-size:13px">No one scheduled today \u{2014} or schedule not yet loaded.</div>';
  }

  const openCN = convoNotes.filter(n=>n.status==='open'||n.status==='pending').length;
  document.getElementById('home-cn').textContent = openCN;

  const dueOut = outreachList.filter(r=>r.status==='due'||r.status==='overdue').length;
  document.getElementById('home-out').textContent = dueOut;

  renderHomeTodos();
}

function homeAddTodo(){
  const text = document.getElementById('home-todo-input').value.trim();
  if(!text) return;
  todos.unshift({ id:Date.now(), text, done:false, priority:document.getElementById('home-todo-prio').value, category:'ops', created:new Date().toLocaleDateString() });
  document.getElementById('home-todo-input').value='';
  saveTodos(); renderTodos(); renderHomeTodos(); updateHomeStats();
}

function renderHomeTodos(){
  const el = document.getElementById('home-todo-preview');
  if(!el) return;
  const top = todos.filter(t=>!t.done).slice(0,5);
  if(top.length===0){ el.innerHTML='<div style="color:var(--muted);font-size:13px">All clear! No pending tasks.</div>'; return; }
  el.innerHTML = top.map(t=>`
    <div class="todo-item" style="margin-bottom:5px">
      <div class="todo-check ${t.done?'checked':''}" onclick="toggleTodo(${t.id});renderHomeTodos();updateHomeStats()"></div>
      <div class="todo-text">${escHtml(t.text)}</div>
      <span class="todo-priority prio-${t.priority}">${t.priority}</span>
    </div>`).join('');
}

// \u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}
// TASKS
// \u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}
function saveTodos(){ localStorage.setItem('ag_todos',JSON.stringify(todos)); syncToCloud('todos',todos); }
function addTodo(){
  const text=document.getElementById('todoInput').value.trim();
  if(!text)return;
  todos.unshift({id:Date.now(),text,done:false,priority:document.getElementById('todoPriority').value,category:document.getElementById('todoCategory').value,created:new Date().toLocaleDateString()});
  document.getElementById('todoInput').value='';
  saveTodos(); renderTodos(); updateHomeStats();
}
function toggleTodo(id){ const t=todos.find(t=>t.id===id); if(t){t.done=!t.done;saveTodos();renderTodos();updateHomeStats();} }
function deleteTodo(id){ todos=todos.filter(t=>t.id!==id); saveTodos();renderTodos();updateHomeStats(); }
function clearDone(){ todos=todos.filter(t=>!t.done); saveTodos();renderTodos();updateHomeStats(); }
function setFilter(f,btn){ currentFilter=f; document.querySelectorAll('#panel-tasks .filter-chip').forEach(c=>c.classList.remove('active-chip')); btn.classList.add('active-chip'); renderTodos(); }
const catLabels={ops:'\u{1F3E2} Ops',hr:'\u{1F464} HR',hospitality:'\u{1F3AE} Guest',training:'\u{1F4CB} Train',admin:'\u{2699}\u{FE0F} Admin'};
const prioClass={high:'prio-high',mid:'prio-mid',low:'prio-low'};
function renderTodos(){
  let filtered=todos;
  if(currentFilter==='high')filtered=todos.filter(t=>t.priority==='high');
  else if(currentFilter==='mid')filtered=todos.filter(t=>t.priority==='mid');
  else if(currentFilter==='low')filtered=todos.filter(t=>t.priority==='low');
  else if(currentFilter==='active')filtered=todos.filter(t=>!t.done);
  else if(currentFilter==='done')filtered=todos.filter(t=>t.done);
  const list=document.getElementById('todoList');
  if(!list)return;
  list.innerHTML=filtered.length===0
    ?'<div style="text-align:center;padding:28px;color:var(--muted);font-size:14px">No tasks here \u{26A1}</div>'
    :filtered.map(t=>`<div class="todo-item ${t.done?'done':''}">
      <div class="todo-check ${t.done?'checked':''}" onclick="toggleTodo(${t.id})"></div>
      <div class="todo-text">${escHtml(t.text)}</div>
      <span class="todo-priority ${prioClass[t.priority]}">${t.priority}</span>
      <span style="font-size:11px;color:var(--muted);font-family:'DM Mono',monospace">${catLabels[t.category]||t.category}</span>
      <button class="btn-danger btn" onclick="deleteTodo(${t.id})">\u{2715}</button>
    </div>`).join('');
  const total=todos.length,done=todos.filter(t=>t.done).length,high=todos.filter(t=>t.priority==='high'&&!t.done).length,pct=total?Math.round(done/total*100):0;
  document.getElementById('stat-total').textContent=total;
  document.getElementById('stat-done').textContent=done;
  document.getElementById('stat-high').textContent=high;
  document.getElementById('stat-pct').textContent=pct+'%';
  document.getElementById('taskProgress').style.width=pct+'%';
}

// \u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}
// SHIFT HANDOFF \u{2014} Google Forms live feed
// \u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}
const GF_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1ys6YnSCOCBv4rvLfrABiPz5ClYrAW9E-sOIQMpjUP58/export?format=csv';
let gfPollInterval = null;

function parseCSVRobust(text) {
  const rows = [];
  let row = [], field = '', inQ = false;
  for (let i = 0; i < text.length; i++) {
    const ch = text[i];
    if (inQ) {
      if (ch === '"') { if (text[i+1]==='"') { field+='"'; i++; } else inQ=false; }
      else { field += ch; }
    } else {
      if      (ch === '"')  { inQ = true; }
      else if (ch === ',')  { row.push(field); field = ''; }
      else if (ch === '\r') { /* skip */ }
      else if (ch === '\n') { row.push(field); field=''; rows.push(row); row=[]; }
      else { field += ch; }
    }
  }
  if (field || row.length) { row.push(field); if (row.some(v=>v)) rows.push(row); }
  return rows;
}

async function fetchGFormHandoffs(manual=false) {
  const listEl = document.getElementById('gform-handoff-list');
  const updEl  = document.getElementById('ho-last-update');
  if (!listEl) return;
  if (manual) listEl.innerHTML = '<div style="text-align:center;padding:48px;color:var(--muted)">Refreshing\u{2026}</div>';
  try {
    const resp = await fetch(GF_SHEET_URL + '&nocache=' + Date.now(), { cache:'no-store' });
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    const rows = parseCSVRobust(await resp.text());
    const data = rows.slice(1).filter(r => r.length > 2);
    data.sort((a, b) => new Date(a[0]) - new Date(b[0]));
    renderGFormHandoffs(data.slice(-5).reverse());
    if (updEl) updEl.textContent = 'Updated ' + new Date().toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
  } catch(e) {
    listEl.innerHTML = `<div style="text-align:center;padding:48px;color:var(--accent2)">
      Could not load responses \u{2014} check your connection or sheet permissions.<br>
      <small style="color:var(--muted)">${e.message}</small></div>`;
    console.error('GForm fetch error:', e);
  }
}

function gfShiftBadge(shift) {
  const s = (shift||'').toLowerCase();
  if (s.includes('open'))  return { cls:'badge-cyan', icon:'\u{1F305}' };
  if (s.includes('close')) return { cls:'badge-red',  icon:'\u{1F319}' };
  if (s.includes('mid'))   return { cls:'badge-gold', icon:'\u{2600}\u{FE0F}' };
  return                          { cls:'badge-cyan', icon:'\u{1F4CB}' };
}

function renderGFormHandoffs(rows) {
  const el = document.getElementById('gform-handoff-list');
  if (!el) return;
  if (!rows || rows.length === 0) {
    el.innerHTML = '<div style="text-align:center;padding:48px;color:var(--muted)">No responses found.</div>';
    return;
  }
  el.innerHTML = rows.map(r => {
    const ts       = r[0]  || '';
    const shift    = r[1]  || '';
    const name     = r[2]  || '';
    const notes    = r[7]  || '';
    const nextNote = r[15] || '';
    const badge    = gfShiftBadge(shift);
    const dateStr  = ts ? new Date(ts).toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',hour:'numeric',minute:'2-digit'}) : '';
    return `
    <div class="handoff-card" style="margin-bottom:12px">
      <div class="handoff-header">
        <span class="badge ${badge.cls}">${badge.icon} ${escHtml(shift)}</span>
        <span style="font-size:14px;font-weight:600;color:var(--text)">${escHtml(name)}</span>
        <span style="font-size:11px;color:var(--muted);font-family:'DM Mono',monospace;margin-left:auto">${escHtml(dateStr)}</span>
      </div>
      ${notes    ? `<div class="handoff-section"><div class="handoff-label">\u{1F4CB} Shift Notes</div><div class="handoff-text">${escHtml(notes)}</div></div>` : ''}
      ${nextNote ? `<div class="handoff-section"><div class="handoff-label">\u{26A1} Notes for Next Shift</div><div class="handoff-text">${escHtml(nextNote)}</div></div>` : ''}
    </div>`;
  }).join('');
}

function startGFPoll() {
  fetchGFormHandoffs();
  clearInterval(gfPollInterval);
  gfPollInterval = setInterval(fetchGFormHandoffs, 60000);
}

// stub so restore/load code doesn't error
function renderHandoffs() { /* replaced by Google Forms feed */ }

// \u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}
// TRAINING TRIPS
// \u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}
function saveTrips(){ localStorage.setItem('ag_trips',JSON.stringify(trips)); syncToCloud('trips',trips); }
function addTrip(){
  const loc=document.getElementById('trip-loc').value.trim();
  if(!loc){alert('Please enter a location');return;}
  const traineesRaw=document.getElementById('trip-trainees').value.trim();
  const trainees=traineesRaw?traineesRaw.split('\n').map(t=>t.trim()).filter(t=>t).map(t=>({name:t,done:false})):[];
  trips.unshift({id:Date.now(),loc,type:document.getElementById('trip-type').value,start:document.getElementById('trip-start').value,end:document.getElementById('trip-end').value,notes:document.getElementById('trip-notes').value,trainees,status:'upcoming'});
  document.getElementById('trip-loc').value='';document.getElementById('trip-notes').value='';document.getElementById('trip-trainees').value='';
  saveTrips();renderTrips();
}
function deleteTrip(id){ if(!confirm('Delete this trip?'))return; trips=trips.filter(t=>t.id!==id); saveTrips();renderTrips(); }
function markTripComplete(id){ const t=trips.find(t=>t.id===id); if(t){t.status='complete';saveTrips();renderTrips();} }
function toggleTrainee(tripId,tIdx){ const trip=trips.find(t=>t.id===tripId); if(trip&&trip.trainees[tIdx]){trip.trainees[tIdx].done=!trip.trainees[tIdx].done;saveTrips();renderTrips();} }
function setTripFilter(f,btn){ tripFilter=f; document.querySelectorAll('#trip-filters .filter-chip').forEach(c=>c.classList.remove('active-chip')); btn.classList.add('active-chip'); renderTrips(); }
const tripTypeLabel={opening:'\u{1F3EA} Location Opening',gm:'\u{1F464} GM Training',support:'\u{1F91D} Support Visit'};
function renderTrips(){
  const el=document.getElementById('tripsList');if(!el)return;
  let list=trips;
  if(tripFilter==='upcoming')list=trips.filter(t=>t.status!=='complete');
  else if(tripFilter==='complete')list=trips.filter(t=>t.status==='complete');
  else if(['opening','gm','support'].includes(tripFilter))list=trips.filter(t=>t.type===tripFilter);
  if(list.length===0){el.innerHTML='<div style="text-align:center;padding:28px;color:var(--muted);font-size:14px">No trips logged yet.</div>';return;}
  el.innerHTML=list.map(t=>{
    const done=t.trainees.filter(tr=>tr.done).length;
    const pct=t.trainees.length?Math.round(done/t.trainees.length*100):0;
    return`<div class="trip-card">
      <div class="trip-header">
        <div class="trip-title">\u{1F4CD} ${escHtml(t.loc)}</div>
        <span class="badge badge-cyan">${tripTypeLabel[t.type]||t.type}</span>
        <span class="badge ${t.status==='complete'?'badge-green':'badge-gold'}">${t.status==='complete'?'\u{2705} Complete':'\u{1F5D3} Upcoming'}</span>
        ${t.status!=='complete'?`<button class="btn btn-green btn-sm" onclick="markTripComplete(${t.id})">Mark Complete</button>`:''}
        <button class="btn btn-danger btn-sm" onclick="deleteTrip(${t.id})">\u{2715}</button>
      </div>
      <div style="font-size:12px;color:var(--muted);font-family:'DM Mono',monospace;margin-bottom:10px">
        \u{1F4C5} ${fmtDate(t.start)} \u{2192} ${fmtDate(t.end)}
        ${t.notes?` \u{B7} ${escHtml(t.notes)}`:''}
      </div>
      ${t.trainees.length>0?`
        <div style="margin-bottom:6px">
          <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;font-family:'DM Mono',monospace;margin-bottom:6px">Trainees \u{2014} ${done}/${t.trainees.length} trained (${pct}%)</div>
          <div class="progress-bar" style="margin-bottom:10px"><div class="progress-fill" style="width:${pct}%"></div></div>
          ${t.trainees.map((tr,i)=>`<div class="trainee-row">
            <div class="trainee-check ${tr.done?'checked':''}" onclick="toggleTrainee(${t.id},${i})"></div>
            <div class="trainee-name">${escHtml(tr.name)}</div>
            <span class="badge ${tr.done?'badge-green':'badge-gold'}">${tr.done?'Trained':'Pending'}</span>
          </div>`).join('')}
        </div>`:''}
    </div>`;
  }).join('');
}

// \u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}
// AI SCHEDULE READER
// \u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}
function handleSchedDrop(e){
  e.preventDefault();
  document.getElementById('dropZone').classList.remove('drag-over');
  const file=e.dataTransfer.files[0];
  if(file&&file.type.startsWith('image/')) processSchedImage(file);
}
function handleSchedFile(input){
  const file=input.files[0];
  if(file) processSchedImage(file);
}

async function processSchedImage(file){
  const area=document.getElementById('schedPreviewArea');
  area.innerHTML=`<div class="ai-loading"><div class="spinner"></div> Reading schedule with AI \u{2014} this may take a moment...</div>`;

  const apiKey = (document.getElementById('sched-api-key').value || localStorage.getItem('ag_anthropic_key') || '').trim();
  if (!apiKey) {
    area.innerHTML=`<div class="card" style="border-color:var(--gold)"><div style="color:var(--gold);font-weight:600">\u{1F511} API Key Required</div><div style="color:var(--muted);font-size:13px;margin-top:6px">Enter your Anthropic API key above to use the AI schedule reader. Get one at <a href="https://console.anthropic.com" target="_blank" style="color:var(--accent)">console.anthropic.com</a>.</div></div>`;
    return;
  }

  const b64=await new Promise((res,rej)=>{
    const r=new FileReader();
    r.onload=()=>res(r.result.split(',')[1]);
    r.onerror=()=>rej();
    r.readAsDataURL(file);
  });

  const weekStart=document.getElementById('sched-week-start').value;

  try {
    const resp = await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body:JSON.stringify({
        model:'claude-opus-4-6',
        max_tokens:2000,
        messages:[{
          role:'user',
          content:[
            {type:'image',source:{type:'base64',media_type:file.type,data:b64}},
            {type:'text',text:`This is an employee schedule screenshot. Extract every shift you can see.
For each shift return a JSON array of objects with: name (employee first+last name), date (YYYY-MM-DD \u{2014} infer from the week starting ${weekStart||'the week shown'}), time (shift time range e.g. "9:00 AM - 5:00 PM"), role (job title if visible).
If a date can't be determined precisely, use the day of week label and the week start date ${weekStart||''} to calculate it.
Respond ONLY with a valid JSON array. No explanation, no markdown, no backticks. Example: [{"name":"Jane Smith","date":"2026-02-24","time":"10:00 AM - 6:00 PM","role":"Game Facilitator"}]`}
          ]
        }]
      })
    });
    if (!resp.ok) {
      const errData = await resp.json().catch(()=>({}));
      throw new Error(errData.error?.message || `API error ${resp.status}`);
    }
    const data=await resp.json();
    const raw=data.content.map(i=>i.text||'').join('');
    let shifts;
    try{ shifts=JSON.parse(raw); }
    catch(e){ throw new Error('Could not parse AI response. Try a clearer screenshot.'); }

    renderSchedPreview(shifts, weekStart, file.name);
  } catch(err){
    area.innerHTML=`<div class="card" style="border-color:var(--accent2)"><div style="color:var(--accent2);font-weight:600">\u{26A0}\u{FE0F} ${escHtml(err.message||'Error reading schedule')}</div><div style="color:var(--muted);font-size:13px;margin-top:6px">Make sure your screenshot is clear and the API key is correct.</div></div>`;
  }
}

function renderSchedPreview(shifts, weekStart, filename){
  const area=document.getElementById('schedPreviewArea');
  if(!shifts||shifts.length===0){
    area.innerHTML='<div class="card" style="border-color:var(--gold)"><div style="color:var(--gold)">No shifts detected. Try a clearer screenshot.</div></div>';
    return;
  }
  // Group by date
  const byDate={};
  shifts.forEach(s=>{
    const d=s.date||'unknown';
    if(!byDate[d])byDate[d]=[];
    byDate[d].push(s);
  });
  const dates=Object.keys(byDate).sort();
  area.innerHTML=`
    <div class="card" style="border-color:rgba(168,255,62,.3)">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;flex-wrap:wrap">
        <span style="font-size:15px;font-weight:600;color:var(--accent3)">\u{2705} ${shifts.length} shifts extracted</span>
        <span style="font-size:12px;color:var(--muted)">Review below, then save</span>
        <button class="btn btn-primary" style="margin-left:auto" onclick="saveSchedule(${JSON.stringify(shifts).replace(/'/g,"&#39;")}, '${weekStart||''}', '${escHtml(filename)}')">\u{1F4BE} Save Schedule</button>
      </div>
      ${dates.map(d=>`
        <div style="margin-bottom:12px">
          <div style="font-size:12px;font-family:'DM Mono',monospace;color:var(--accent);margin-bottom:6px;text-transform:uppercase;letter-spacing:1px">${fmtDate(d)}</div>
          <div style="display:flex;flex-wrap:wrap;gap:6px">
            ${byDate[d].map(s=>`<span class="shift-pill"><span class="sp-name">${escHtml(s.name)}</span><span class="sp-time">${escHtml(s.time||'')}</span></span>`).join('')}
          </div>
        </div>`).join('')}
    </div>`;
}

function saveSchedule(shifts, weekStart, filename){
  schedules.unshift({id:Date.now(),weekStart,filename,shifts,saved:new Date().toLocaleDateString()});
  if(schedules.length>10)schedules=schedules.slice(0,10);
  localStorage.setItem('ag_schedules',JSON.stringify(schedules));
  syncToCloud('schedules', schedules);
  document.getElementById('schedPreviewArea').innerHTML='<div class="card" style="border-color:rgba(168,255,62,.3);color:var(--accent3)">\u{2705} Schedule saved! It will now show in "Who\'s Working Today" on the Home tab.</div>';
  renderSavedSchedules();
  updateHomeStats();
}

function deleteSchedule(id){
  schedules=schedules.filter(s=>s.id!==id);
  localStorage.setItem('ag_schedules',JSON.stringify(schedules));
  renderSavedSchedules();updateHomeStats();
}

function renderSavedSchedules(){
  const el=document.getElementById('savedSchedList');if(!el)return;
  if(schedules.length===0){el.innerHTML='<div style="color:var(--muted);font-size:13px">No schedules saved yet.</div>';return;}
  el.innerHTML=schedules.map(s=>`
    <div class="handoff-card" style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
      <span style="font-size:22px">\u{1F4C5}</span>
      <div style="flex:1">
        <div style="font-weight:600;font-size:14px">Week of ${fmtDate(s.weekStart)||'\u{2014}'}</div>
        <div style="font-size:11px;color:var(--muted);font-family:'DM Mono',monospace">${s.shifts.length} shifts \u{B7} saved ${s.saved} \u{B7} ${escHtml(s.filename||'')}</div>
      </div>
      <button class="btn btn-danger btn-sm" onclick="deleteSchedule(${s.id})">\u{2715}</button>
    </div>`).join('');
}

// \u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}
// LINKS
// \u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}
function saveLinks(){ localStorage.setItem('ag_links',JSON.stringify(customLinks)); syncToCloud('customLinks',customLinks); }
function addCustomLink(){
  const name=document.getElementById('link-name').value.trim();
  const url=document.getElementById('link-url').value.trim();
  const icon=document.getElementById('link-icon').value.trim()||'\u{1F517}';
  const desc=document.getElementById('link-desc').value.trim();
  if(!name||!url)return;
  customLinks.push({name,url,icon,desc});
  ['link-name','link-url','link-icon','link-desc'].forEach(id=>document.getElementById(id).value='');
  saveLinks();renderLinks();
}
function removeCustomLink(i){ customLinks.splice(i,1); saveLinks();renderLinks(); }
function renderLinks(){
  const grid=document.getElementById('linksGrid');if(!grid)return;
  const all=[...defaultLinks,...customLinks];
  grid.innerHTML=all.map((l,i)=>{
    const isC=i>=defaultLinks.length;
    return`<a href="${l.url}" target="_blank" class="link-card">
      <div class="link-icon">${l.icon}</div>
      <div class="link-name">${l.name}</div>
      <div class="link-desc">${l.desc||''}</div>
      ${isC?`<button onclick="event.preventDefault();event.stopPropagation();removeCustomLink(${i-defaultLinks.length})" style="margin-top:6px;font-size:10px;background:rgba(255,77,109,.15);border:none;color:var(--accent2);border-radius:4px;padding:2px 6px;cursor:pointer">remove</button>`:''}
    </a>`;
  }).join('');
}

// \u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}
// DOCS
// \u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}
function saveDocs(){ localStorage.setItem('ag_docs',JSON.stringify(docs)); }
const docCatLabel={ops:'\u{1F3E2} Operations',training:'\u{1F4CB} Training',hr:'\u{1F464} HR / Staff',reference:'\u{1F4CC} Reference',travel:'\u{2708}\u{FE0F} Travel',other:'\u{1F4C1} Other'};
function fileIcon(fn){ const ext=(fn||'').split('.').pop().toLowerCase(); return{pdf:'\u{1F4D5}',doc:'\u{1F4D8}',docx:'\u{1F4D8}',xls:'\u{1F4D7}',xlsx:'\u{1F4D7}',csv:'\u{1F4D7}',ppt:'\u{1F4D9}',pptx:'\u{1F4D9}',png:'\u{1F5BC}',jpg:'\u{1F5BC}',jpeg:'\u{1F5BC}',txt:'\u{1F4C4}'}[ext]||'\u{1F4C1}'; }
function uploadDoc(){
  const fi=document.getElementById('doc-file');
  const name=document.getElementById('doc-name').value.trim();
  const cat=document.getElementById('doc-cat').value;
  const file=fi.files[0];
  if(!file){alert('Please choose a file');return;}
  const r=new FileReader();
  r.onload=e=>{
    docs.unshift({id:Date.now(),label:name||file.name,filename:file.name,cat,size:(file.size/1024).toFixed(1)+' KB',date:new Date().toLocaleDateString(),dataUrl:e.target.result});
    if(docs.length>50)docs=docs.slice(0,50);
    saveDocs();renderDocs();
    document.getElementById('doc-name').value='';fi.value='';
  };
  r.readAsDataURL(file);
}
function deleteDoc(id){ docs=docs.filter(d=>d.id!==id); saveDocs();renderDocs(); }
function setDocFilter(f,btn){ docFilter=f; document.querySelectorAll('#doc-filters .filter-chip').forEach(c=>c.classList.remove('active-chip')); btn.classList.add('active-chip'); renderDocs(); }
function renderDocs(){
  const el=document.getElementById('docsList');if(!el)return;
  const list=docFilter==='all'?docs:docs.filter(d=>d.cat===docFilter);
  if(list.length===0){el.innerHTML='<div style="text-align:center;padding:28px;color:var(--muted);font-size:14px">No documents uploaded yet.</div>';return;}
  el.innerHTML=list.map(d=>`<div class="doc-card">
    <div class="doc-icon">${fileIcon(d.filename)}</div>
    <div class="doc-info"><div class="doc-name">${escHtml(d.label)}</div><div class="doc-meta">${d.filename} \u{B7} ${d.size} \u{B7} ${docCatLabel[d.cat]||d.cat} \u{B7} ${d.date}</div></div>
    <a href="${d.dataUrl}" download="${d.filename}" class="btn btn-ghost btn-sm" style="text-decoration:none">\u{2B07} Download</a>
    <button class="btn btn-danger btn-sm" onclick="deleteDoc(${d.id})">\u{2715}</button>
  </div>`).join('');
}

// \u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}
// OUTREACH
// \u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}
function saveOutreach(){ localStorage.setItem('ag_outreach',JSON.stringify(outreachList)); syncToCloud('outreachList',outreachList); }
function addOutreach(){
  const name=document.getElementById('out-name').value.trim();
  if(!name)return;
  outreachList.unshift({id:Date.now(),name,date:document.getElementById('out-date').value,contact:document.getElementById('out-contact').value.trim(),status:document.getElementById('out-status').value});
  document.getElementById('out-name').value='';document.getElementById('out-contact').value='';
  saveOutreach();renderOutreach();updateHomeStats();
}
function updateOutreachStatus(id,val){ const r=outreachList.find(r=>r.id===id); if(r){r.status=val;saveOutreach();renderOutreach();updateHomeStats();} }
function deleteOutreach(id){ outreachList=outreachList.filter(r=>r.id!==id); saveOutreach();renderOutreach();updateHomeStats(); }
const statusBadge={overdue:'<span class="badge badge-red">Overdue</span>',due:'<span class="badge badge-gold">Due</span>',done:'<span class="badge badge-green">Contacted</span>'};
function renderOutreach(){
  const el=document.getElementById('outreachList');if(!el)return;
  if(outreachList.length===0){el.innerHTML='<div style="text-align:center;padding:28px;color:var(--muted);font-size:14px">No players tracked yet.</div>';return;}
  el.innerHTML=outreachList.map(r=>`<div class="outreach-card">
    <div class="avatar">${initials(r.name)}</div>
    <div class="outreach-info"><div class="outreach-name">${escHtml(r.name)}</div><div class="outreach-meta">Last visit: ${r.date||'\u{2014}'} \u{B7} ${escHtml(r.contact||'No contact')}</div></div>
    ${statusBadge[r.status]||''}
    <select onchange="updateOutreachStatus(${r.id},this.value)" style="width:130px;font-size:12px;padding:5px 8px">
      <option value="due" ${r.status==='due'?'selected':''}>\u{1F4EC} Due</option>
      <option value="overdue" ${r.status==='overdue'?'selected':''}>\u{1F534} Overdue</option>
      <option value="done" ${r.status==='done'?'selected':''}>\u{2705} Contacted</option>
    </select>
    <button class="btn btn-danger btn-sm" onclick="deleteOutreach(${r.id})">\u{2715}</button>
  </div>`).join('');
}

// \u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}
// CONV NOTES \u{2014} Employee Documentation System
// \u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}
const CN_FORMS = {
  verbal: {
    label:'Verbal Warning', icon:'\u{1F5E3}\u{FE0F}', color:'#ffd166', badgeClass:'badge-gold',
    desc:'Minor infraction or first-time issue. Internal record only \u{2014} no employee signature required.',
    fields:[
      {id:'employee',label:'Employee Name',type:'text',required:true},
      {id:'role',label:'Role / Position',type:'text'},
      {id:'incident_date',label:'Date of Incident',type:'date',required:true},
      {id:'conversation_date',label:'Date of Conversation',type:'date',required:true},
      {id:'manager',label:'Your Name (Manager on Duty)',type:'text',required:true},
      {id:'policy_violated',label:'Policy / Rule Violated',type:'text'},
      {id:'description',label:'Description of Incident / Behavior',type:'textarea',required:true},
      {id:'expected_behavior',label:'Expected Behavior Going Forward',type:'textarea'},
      {id:'prior_issues',label:'Prior Issues on Record?',type:'select',options:['No prior issues','Yes \u{2014} see notes below']},
      {id:'notes',label:'Additional Notes',type:'textarea'},
    ]
  },
  first_written: {
    label:'First Written Warning', icon:'\u{1F4C4}', color:'#ff9a3c', badgeClass:'badge-gold',
    desc:'Issue persists after verbal warning, or a more serious single incident occurred.',
    fields:[
      {id:'employee',label:'Employee Name',type:'text',required:true},
      {id:'role',label:'Role / Position',type:'text'},
      {id:'incident_date',label:'Date of Incident',type:'date',required:true},
      {id:'warning_date',label:'Date Warning Issued',type:'date',required:true},
      {id:'manager',label:'Your Name (Manager)',type:'text',required:true},
      {id:'prior_verbal',label:'Prior Verbal Warning on File?',type:'select',options:['No','Yes']},
      {id:'prior_verbal_date',label:'Verbal Warning Date (if applicable)',type:'date'},
      {id:'policy_violated',label:'Policy / Rule Violated',type:'text'},
      {id:'description',label:'Description of Issue / Violation',type:'textarea',required:true},
      {id:'corrective_action',label:'Required Corrective Action',type:'textarea',required:true},
      {id:'deadline',label:'Improvement Deadline',type:'date'},
      {id:'consequences',label:'Consequences if Not Corrected',type:'text'},
      {id:'witness',label:'Witness Present?',type:'select',options:['No','Yes']},
      {id:'witness_name',label:'Witness Name (if applicable)',type:'text'},
      {id:'employee_acknowledged',label:'Employee Signed / Acknowledged?',type:'select',options:['Yes','No \u{2014} refused to sign']},
      {id:'notes',label:'Additional Notes',type:'textarea'},
    ]
  },
  second_written: {
    label:'Second Written Warning', icon:'\u{1F4CB}', color:'#ff6b35', badgeClass:'badge-red',
    desc:'Problem continues after first written warning. Requires documented correction deadline.',
    fields:[
      {id:'employee',label:'Employee Name',type:'text',required:true},
      {id:'role',label:'Role / Position',type:'text'},
      {id:'incident_date',label:'Date of Current Incident',type:'date',required:true},
      {id:'warning_date',label:'Date Warning Issued',type:'date',required:true},
      {id:'manager',label:'Your Name (Manager)',type:'text',required:true},
      {id:'prior_verbal_date',label:'Prior Verbal Warning Date',type:'date'},
      {id:'prior_first_written_date',label:'Prior First Written Warning Date',type:'date'},
      {id:'description',label:'Description of Current Issue',type:'textarea',required:true},
      {id:'pattern',label:'Description of Continued Pattern / History',type:'textarea'},
      {id:'corrective_action',label:'Required Corrective Action',type:'textarea'},
      {id:'deadline',label:'Correction Deadline',type:'date'},
      {id:'next_consequence',label:'Next Stage of Consequences',type:'text'},
      {id:'witness',label:'Witness Present?',type:'select',options:['No','Yes']},
      {id:'witness_name',label:'Witness Name (if applicable)',type:'text'},
      {id:'hr_involved',label:'HR Notified?',type:'select',options:['No','Yes']},
      {id:'employee_acknowledged',label:'Employee Signed / Acknowledged?',type:'select',options:['Yes','No \u{2014} refused to sign']},
      {id:'notes',label:'Additional Notes',type:'textarea'},
    ]
  },
  final_written: {
    label:'Final Written Warning', icon:'\u{1F6A8}', color:'#ff4d6d', badgeClass:'badge-red',
    desc:'Final opportunity for correction. Explicitly states termination risk if issue continues.',
    fields:[
      {id:'employee',label:'Employee Name',type:'text',required:true},
      {id:'role',label:'Role / Position',type:'text'},
      {id:'date',label:'Date',type:'date',required:true},
      {id:'manager',label:'Your Name (Manager)',type:'text',required:true},
      {id:'prior_verbal_date',label:'Prior Verbal Warning Date',type:'date'},
      {id:'prior_first_written_date',label:'First Written Warning Date',type:'date'},
      {id:'prior_second_written_date',label:'Second Written Warning Date',type:'date'},
      {id:'description',label:'Description of Current Violation',type:'textarea',required:true},
      {id:'corrective_action',label:'Required Corrective Actions',type:'textarea'},
      {id:'deadline',label:'Final Deadline',type:'date'},
      {id:'termination_notice',label:'Termination Risk Stated to Employee?',type:'select',options:['Yes \u{2014} verbally communicated','Yes \u{2014} written on form']},
      {id:'witness',label:'Witness Present?',type:'select',options:['No','Yes']},
      {id:'witness_name',label:'Witness Name (if applicable)',type:'text'},
      {id:'hr_involved',label:'HR Notified?',type:'select',options:['No','Yes']},
      {id:'employee_acknowledged',label:'Employee Signed / Acknowledged?',type:'select',options:['Yes','No \u{2014} refused to sign']},
      {id:'notes',label:'Additional Notes',type:'textarea'},
    ]
  },
  pip: {
    label:'Performance Improvement Plan', icon:'\u{1F4C8}', color:'#c084fc', badgeClass:'badge-purple',
    desc:'For performance or productivity issues. Structured plan with measurable goals and scheduled check-ins.',
    fields:[
      {id:'employee',label:'Employee Name',type:'text',required:true},
      {id:'role',label:'Role / Position',type:'text'},
      {id:'start_date',label:'PIP Start Date',type:'date',required:true},
      {id:'review_date',label:'Review / End Date',type:'date',required:true},
      {id:'manager',label:'Your Name (Manager)',type:'text',required:true},
      {id:'performance_concerns',label:'Performance Concerns',type:'textarea',required:true},
      {id:'goals',label:'Specific Goals / Measurable Objectives',type:'textarea',required:true},
      {id:'support',label:'Support / Resources Being Provided',type:'textarea'},
      {id:'checkin_schedule',label:'Check-in Schedule',type:'select',options:['Weekly','Bi-weekly','Monthly','As needed']},
      {id:'success_criteria',label:'Success Criteria',type:'textarea'},
      {id:'consequences',label:'Consequences if Goals Not Met',type:'text'},
      {id:'employee_acknowledged',label:'Employee Signed / Acknowledged?',type:'select',options:['Yes','No \u{2014} refused to sign']},
      {id:'notes',label:'Additional Notes',type:'textarea'},
    ]
  },
  general: {
    label:'General Disciplinary Action', icon:'\u{1F4CE}', color:'#ff4d6d', badgeClass:'badge-red',
    desc:'Flexible form for overlapping violations or situations that span multiple discipline stages.',
    fields:[
      {id:'employee',label:'Employee Name',type:'text',required:true},
      {id:'role',label:'Role / Position',type:'text'},
      {id:'date',label:'Date',type:'date',required:true},
      {id:'manager',label:'Your Name (Manager)',type:'text',required:true},
      {id:'action_type',label:'Type of Action',type:'select',options:['Verbal Warning','First Written Warning','Second Written Warning','Final Written Warning','Suspension','Termination Recommendation']},
      {id:'description',label:'Description of Violations / Issues',type:'textarea',required:true},
      {id:'prior_history',label:'Prior Disciplinary History',type:'textarea'},
      {id:'corrective_action',label:'Corrective Action Required',type:'textarea'},
      {id:'deadline',label:'Deadline',type:'date'},
      {id:'consequences',label:'Consequences if Not Corrected',type:'text'},
      {id:'witness',label:'Witness Present?',type:'select',options:['No','Yes']},
      {id:'witness_name',label:'Witness Name (if applicable)',type:'text'},
      {id:'hr_involved',label:'HR Notified?',type:'select',options:['No','Yes']},
      {id:'employee_acknowledged',label:'Employee Signed / Acknowledged?',type:'select',options:['Yes','No \u{2014} refused to sign']},
      {id:'notes',label:'Additional Notes',type:'textarea'},
    ]
  },
  praise: {
    label:'Praise / Recognition', icon:'\u{2B50}', color:'#a8ff3e', badgeClass:'badge-green',
    desc:'Document positive performance, teamwork, leadership, or initiative. Build the positive record too.',
    fields:[
      {id:'employee',label:'Employee Name',type:'text',required:true},
      {id:'role',label:'Role / Position',type:'text'},
      {id:'date',label:'Date',type:'date',required:true},
      {id:'manager',label:'Your Name (Manager)',type:'text',required:true},
      {id:'reason',label:'Reason for Recognition',type:'select',options:['Outstanding Performance','Teamwork','Leadership','Initiative','Guest Experience','Going Above & Beyond','Other']},
      {id:'description',label:'Description of Achievement',type:'textarea',required:true},
      {id:'impact',label:'Impact on Team / Guests',type:'textarea'},
      {id:'share_with',label:'Share With',type:'select',options:['Internal record only','Share with employee','Share with department','Company-wide']},
      {id:'notes',label:'Additional Notes',type:'textarea'},
    ]
  },
};

let cnEditingId = null;
function saveConvoNotes(){ localStorage.setItem('ag_convonotes',JSON.stringify(convoNotes)); syncToCloud('convoNotes',convoNotes); }

function openCNModal(editId){
  cnEditingId = editId || null;
  document.getElementById('cnModal').classList.remove('hidden');
  if(editId){
    const rec = convoNotes.find(n=>n.id===editId);
    if(rec && rec.formType){ cnSelectType(rec.formType, rec); return; }
  }
  document.getElementById('cn-step1').style.display='block';
  document.getElementById('cn-step2').style.display='none';
  renderCNTypeCards();
}
function closeCNModal(){ document.getElementById('cnModal').classList.add('hidden'); cnEditingId=null; }

function renderCNTypeCards(){
  const grid=document.getElementById('cn-type-grid'); if(!grid) return;
  grid.innerHTML=Object.entries(CN_FORMS).map(([key,f])=>`
    <div onclick="cnSelectType('${key}')" style="border:2px solid var(--border);border-radius:10px;padding:14px;cursor:pointer;transition:all .2s;background:var(--surface2)"
      onmouseover="this.style.borderColor='${f.color}';this.style.background='${f.color}18'"
      onmouseout="this.style.borderColor='var(--border)';this.style.background='var(--surface2)'">
      <div style="font-size:22px;margin-bottom:6px">${f.icon}</div>
      <div style="font-size:13px;font-weight:700;color:${f.color};margin-bottom:5px">${f.label}</div>
      <div style="font-size:11px;color:var(--muted);line-height:1.5">${f.desc}</div>
    </div>`).join('');
}

function cnSelectType(type, existingRec){
  const form=CN_FORMS[type]; if(!form) return;
  cnFilter_selectedType=type;
  document.getElementById('cn-step1').style.display='none';
  document.getElementById('cn-step2').style.display='block';
  const title=document.getElementById('cn-modal-title');
  title.textContent=form.icon+' '+form.label; title.style.color=form.color;
  document.getElementById('cn-modal-desc').textContent=form.desc;
  const fd=(existingRec && existingRec.formData) ? existingRec.formData : {};
  const today=new Date().toISOString().split('T')[0];
  document.getElementById('cn-form-fields').innerHTML=
    form.fields.map(f=>{
      const val=fd[f.id]||''; const fid='cnf-'+f.id;
      let inp='';
      if(f.type==='textarea') inp=`<textarea id="${fid}" style="min-height:72px;resize:vertical;width:100%">${escHtml(val)}</textarea>`;
      else if(f.type==='select') inp=`<select id="${fid}">${f.options.map(o=>`<option value="${escHtml(o)}"${val===o?' selected':''}>${escHtml(o)}</option>`).join('')}</select>`;
      else if(f.type==='date') inp=`<input type="date" id="${fid}" value="${escHtml(val||today)}">`;
      else inp=`<input type="text" id="${fid}" value="${escHtml(val)}">`;
      return `<div style="margin-bottom:10px"><div class="input-label" style="margin-bottom:4px">${f.label}${f.required?'<span style="color:var(--accent2);margin-left:3px">*</span>':''}</div>${inp}</div>`;
    }).join('')+
    `<div style="margin-bottom:10px"><div class="input-label" style="margin-bottom:4px">Status</div>
    <select id="cnf-status">
      <option value="open"${(existingRec&&existingRec.status==='open')||!existingRec?' selected':''}>\u{1F7E1} Open</option>
      <option value="pending"${existingRec&&existingRec.status==='pending'?' selected':''}>\u{23F3} Pending Action</option>
      <option value="resolved"${existingRec&&existingRec.status==='resolved'?' selected':''}>\u{2705} Resolved</option>
    </select></div>`;
}

let cnFilter_selectedType = null;
function cnGoBack(){
  document.getElementById('cn-step1').style.display='block';
  document.getElementById('cn-step2').style.display='none';
  cnFilter_selectedType=null;
}

function saveCNRecord(){
  const type=cnFilter_selectedType; const form=CN_FORMS[type]; if(!form) return;
  for(const f of form.fields){
    if(f.required){
      const el=document.getElementById('cnf-'+f.id);
      if(el&&!el.value.trim()){el.style.borderColor='var(--accent2)';el.scrollIntoView({behavior:'smooth',block:'center'});el.focus();return;}
    }
  }
  const fd={};
  form.fields.forEach(f=>{ const el=document.getElementById('cnf-'+f.id); if(el) fd[f.id]=el.value; });
  const status=document.getElementById('cnf-status')?.value||'open';
  const employee=fd.employee||'\u{2014}';
  const date=fd.incident_date||fd.warning_date||fd.date||fd.start_date||new Date().toISOString().split('T')[0];
  if(cnEditingId){
    const i=convoNotes.findIndex(n=>n.id===cnEditingId);
    if(i>=0) convoNotes[i]={...convoNotes[i],employee,formType:type,status,date,formData:fd,updated:new Date().toLocaleDateString()};
  } else {
    convoNotes.unshift({id:Date.now(),employee,formType:type,status,date,formData:fd,created:new Date().toLocaleDateString()});
  }
  saveConvoNotes(); closeCNModal(); renderCNList(); updateHomeStats();
}

function deleteCNRecord(id){ if(!confirm('Delete this record? This cannot be undone.')) return; convoNotes=convoNotes.filter(n=>n.id!==id); saveConvoNotes();renderCNList();updateHomeStats(); }
function updateCNStatus(id,val){ const n=convoNotes.find(n=>n.id===id); if(n){n.status=val;saveConvoNotes();renderCNList();updateHomeStats();} }
function setCNFilter(f,btn){ cnFilter=f; document.querySelectorAll('#cn-filters .filter-chip').forEach(c=>c.classList.remove('active-chip')); btn.classList.add('active-chip'); renderCNList(); }

const cnStatusBadge={open:'<span class="badge badge-gold">Open</span>',resolved:'<span class="badge badge-green">Resolved</span>',pending:'<span class="badge badge-red">Pending Action</span>'};

function renderCNKeyFields(type,fd){
  const keys={verbal:['policy_violated','prior_issues'],first_written:['policy_violated','deadline','employee_acknowledged'],second_written:['deadline','next_consequence','employee_acknowledged'],final_written:['deadline','termination_notice','employee_acknowledged','hr_involved'],pip:['review_date','checkin_schedule','employee_acknowledged'],general:['action_type','deadline','hr_involved','employee_acknowledged'],praise:['reason','share_with']};
  const form=CN_FORMS[type]; const fieldKeys=keys[type]||[];
  const chips=fieldKeys.filter(k=>fd[k]&&fd[k]!=='No'&&fd[k]!=='No prior issues').map(k=>{
    const def=form?.fields.find(f=>f.id===k);
    return `<span style="font-size:11px;background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:2px 8px;font-family:'DM Mono',monospace;color:var(--muted)">${def?def.label:k}: <span style="color:var(--text)">${escHtml(fd[k])}</span></span>`;
  });
  return chips.length?`<div style="display:flex;gap:5px;flex-wrap:wrap;margin-top:8px">${chips.join('')}</div>`:'';
}

function renderCNList(){
  const el=document.getElementById('cn-list'); if(!el) return;
  const formTypes=Object.keys(CN_FORMS);
  let list=convoNotes;
  if(formTypes.includes(cnFilter)) list=convoNotes.filter(n=>n.formType===cnFilter||n.type===cnFilter);
  else if(cnFilter==='open') list=convoNotes.filter(n=>n.status==='open');
  else if(cnFilter==='resolved') list=convoNotes.filter(n=>n.status==='resolved');
  if(list.length===0){el.innerHTML='<div style="text-align:center;padding:36px;color:var(--muted);font-size:14px">No records yet \u{2014} click <strong style="color:var(--text)">+ New Documentation</strong> to start.</div>';return;}
  el.innerHTML=list.map(n=>{
    const isNew=!!n.formType;
    const form=isNew?CN_FORMS[n.formType]:null;
    const label=form?form.label:(n.type||'Note');
    const icon=form?form.icon:'\u{1F4AC}';
    const color=form?form.color:'var(--muted)';
    const badgeClass=form?form.badgeClass:'badge-cyan';
    const employee=n.employee||n.person||'\u{2014}';
    const description=isNew?(n.formData?.description||n.formData?.performance_concerns||''):(n.body||'');
    const manager=n.formData?.manager||'';
    const date=n.date||n.created||'';
    return `<div style="background:var(--surface2);border:1px solid var(--border);border-left:4px solid ${color};border-radius:10px;padding:16px;margin-bottom:10px;transition:border-color .2s" onmouseover="this.style.borderColor='${color}'" onmouseout="this.style.borderColor='var(--border)'">
      <div style="display:flex;align-items:flex-start;gap:10px;flex-wrap:wrap;margin-bottom:${description?'8px':'0'}">
        <div style="font-size:22px;flex-shrink:0">${icon}</div>
        <div style="flex:1;min-width:0">
          <div style="font-size:16px;font-weight:700">${escHtml(employee)}</div>
          <div style="font-size:11px;color:var(--muted);font-family:'DM Mono',monospace;margin-top:2px">${manager?'MOD: '+escHtml(manager)+' \u{B7} ':''}${fmtDate(date)}</div>
        </div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center;flex-shrink:0">
          <span class="badge ${badgeClass}">${label}</span>
          ${cnStatusBadge[n.status]||''}
          <select onchange="updateCNStatus(${n.id},this.value)" style="font-size:11px;padding:3px 6px">
            <option value="open" ${n.status==='open'?'selected':''}>\u{1F7E1} Open</option>
            <option value="pending" ${n.status==='pending'?'selected':''}>\u{23F3} Pending</option>
            <option value="resolved" ${n.status==='resolved'?'selected':''}>\u{2705} Resolved</option>
          </select>
          <button class="btn btn-ghost btn-sm" onclick="openCNModal(${n.id})">\u{270F}\u{FE0F} Edit</button>
          <button class="btn btn-danger btn-sm" onclick="deleteCNRecord(${n.id})">\u{2715}</button>
        </div>
      </div>
      ${description?`<div style="font-size:13px;color:var(--muted);line-height:1.55">${escHtml(description.slice(0,220))}${description.length>220?'\u{2026}':''}</div>`:''}
      ${isNew&&n.formData?renderCNKeyFields(n.formType,n.formData):''}
    </div>`;
  }).join('');
}
// Backward-compat shim so existing call-sites still work
function renderConvoNotes(){ renderCNList(); }

// \u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}
// NOTES
// \u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}
function saveNote(key){
  const val=document.getElementById('note-'+key).value;
  localStorage.setItem('ag_note_'+key,val);
  const btn=event.currentTarget;btn.textContent='Saved \u{2713}';btn.style.background='var(--accent3)';
  setTimeout(()=>{btn.textContent='Save';btn.style.background='';},1500);
}
function loadNotes(){
  ['shift','training','opening','travel'].forEach(k=>{
    const saved=localStorage.getItem('ag_note_'+k);
    const el=document.getElementById('note-'+k);
    if(saved&&el)el.value=saved;
  });
}

// \u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}
// EXPORT & BACKUP
// \u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}
function downloadFile(content, filename, mime){
  const blob = new Blob([content], {type: mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}

function toCSV(rows){
  if(!rows||rows.length===0) return '';
  const headers = Object.keys(rows[0]);
  const escape = v => {
    const s = String(v==null?'':v).replace(/"/g,'""');
    return (s.includes(',') || s.includes('"') || s.includes('\n')) ? `"${s}"` : s;
  };
  return [headers.join(','), ...rows.map(r=>headers.map(h=>escape(r[h])).join(','))].join('\n');
}

function exportCSV(type){
  const stamp = new Date().toISOString().split('T')[0];
  let rows=[], filename='';
  if(type==='tasks'){
    rows = todos.map(t=>({Text:t.text, Priority:t.priority, Category:t.category, Done:t.done?'Yes':'No', Created:t.created}));
    filename=`activate-tasks-${stamp}.csv`;
  } else if(type==='convonotes'){
    rows = convoNotes.map(n=>({Person:n.person, Date:n.date, Type:n.type, Status:n.status, Notes:n.body}));
    filename=`activate-convonotes-${stamp}.csv`;
  } else if(type==='handoffs'){
    rows = handoffs.map(h=>({Date:h.date, Shift:h.shift, MOD:h.mod, Revenue:h.rev, Guests:h.guests, GuestNotes:h.guestNotes, Maintenance:h.maint, ActionItems:h.actions}));
    filename=`activate-handoffs-${stamp}.csv`;
  } else if(type==='trips'){
    rows = trips.flatMap(t=> t.trainees.length>0
      ? t.trainees.map(tr=>({Location:t.loc, Type:t.type, Start:t.start, End:t.end, Status:t.status, Trainee:tr.name, TraineeDone:tr.done?'Yes':'No', Notes:t.notes}))
      : [{Location:t.loc, Type:t.type, Start:t.start, End:t.end, Status:t.status, Trainee:'', TraineeDone:'', Notes:t.notes}]
    );
    filename=`activate-trips-${stamp}.csv`;
  } else if(type==='outreach'){
    rows = outreachList.map(r=>({Name:r.name, LastVisit:r.date, Contact:r.contact, Status:r.status}));
    filename=`activate-outreach-${stamp}.csv`;
  } else if(type==='schedules'){
    rows = schedules.flatMap(s=>(s.shifts||[]).map(sh=>({WeekStart:s.weekStart, Name:sh.name, Date:sh.date, Time:sh.time, Role:sh.role||''})));
    filename=`activate-schedules-${stamp}.csv`;
  }
  if(!rows||rows.length===0){ alert('No data to export yet for this category.'); return; }
  downloadFile(toCSV(rows), filename, 'text/csv');
}

function exportFullBackup(){
  const backup = {
    exported: new Date().toISOString(),
    version: '3.2',
    todos, customLinks, outreachList,
    convoNotes, handoffs, trips, schedules, timeLog,
    notes: {
      shift: localStorage.getItem('ag_note_shift')||'',
      training: localStorage.getItem('ag_note_training')||'',
      opening: localStorage.getItem('ag_note_opening')||'',
      travel: localStorage.getItem('ag_note_travel')||''
    }
  };
  // Exclude docs (too large for JSON download \u{2014} they contain base64 file data)
  const stamp = new Date().toISOString().split('T')[0];
  downloadFile(JSON.stringify(backup, null, 2), `activate-hq-backup-${stamp}.json`, 'application/json');
}

function restoreBackup(input){
  const file = input.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      if(!data.version) throw new Error('Invalid backup file');
      if(!confirm(`Restore backup from ${data.exported}?\n\nThis will REPLACE all current data. Make sure you've downloaded a fresh backup first.`)) return;
      if(data.todos) { todos=data.todos; localStorage.setItem('ag_todos',JSON.stringify(todos)); }
      if(data.customLinks) { customLinks=data.customLinks; localStorage.setItem('ag_links',JSON.stringify(customLinks)); }
      if(data.outreachList) { outreachList=data.outreachList; localStorage.setItem('ag_outreach',JSON.stringify(outreachList)); }
      if(data.convoNotes) { convoNotes=data.convoNotes; localStorage.setItem('ag_convonotes',JSON.stringify(convoNotes)); }
      if(data.handoffs) { handoffs=data.handoffs; localStorage.setItem('ag_handoffs',JSON.stringify(handoffs)); }
      if(data.trips) { trips=data.trips; localStorage.setItem('ag_trips',JSON.stringify(trips)); }
      if(data.schedules) { schedules=data.schedules; localStorage.setItem('ag_schedules',JSON.stringify(schedules)); }
      if(data.timeLog)   { timeLog=data.timeLog;     localStorage.setItem('ag_timelog',JSON.stringify(timeLog)); }
      if(data.notes){
        ['shift','training','opening','travel'].forEach(k=>{
          if(data.notes[k]!=null) localStorage.setItem('ag_note_'+k, data.notes[k]);
        });
      }
      // Re-render everything
      renderTodos(); renderLinks(); renderOutreach();
      loadNotes(); renderConvoNotes(); renderDocs();
      renderHandoffs(); renderTrips(); renderSavedSchedules(); renderTMPanel();
      updateHomeStats(); updateExportCounts();
      alert('\u{2705} Backup restored successfully!');
    } catch(err) {
      alert('\u{274C} Could not restore: ' + err.message);
    }
  };
  reader.readAsText(file);
}

function updateExportCounts(){
  const counts = {
    'export-tasks-count': `${todos.length} tasks`,
    'export-cn-count': `${convoNotes.length} entries`,
    'export-handoff-count': `${handoffs.length} handoffs`,
    'export-trips-count': `${trips.length} trips`,
    'export-outreach-count': `${outreachList.length} players`,
    'export-sched-count': `${schedules.length} schedules saved`,
  };
  Object.entries(counts).forEach(([id,text])=>{ const el=document.getElementById(id); if(el)el.textContent=text; });
}

// \u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}
// TIME MANAGEMENT
// \u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}
const TM_TASKS = [
  { id:'cleaning',     label:'Cleaning',       icon:'\u{1F9F9}', color:'#00e5ff' },
  { id:'maintenance',  label:'Maintenance',    icon:'\u{1F527}', color:'#ff4d6d' },
  { id:'training',     label:'Training',       icon:'\u{1F4CB}', color:'#c084fc' },
  { id:'marketing',    label:'Marketing',      icon:'\u{1F4E2}', color:'#ff9a3c' },
  { id:'outreach',     label:'Outreach',       icon:'\u{1F3AE}', color:'#ffd166' },
  { id:'scheduling',   label:'Scheduling',     icon:'\u{1F4C5}', color:'#4fc3f7' },
  { id:'team_meeting', label:'Team Meeting',   icon:'\u{1F465}', color:'#a8ff3e' },
  { id:'meeting',      label:'Meeting',        icon:'\u{1F91D}', color:'#26c6da' },
  { id:'floor',        label:'Time on Floor',  icon:'\u{1F3C3}', color:'#ff80ab' },
  { id:'admin',        label:'General Admin',  icon:'\u{2699}\u{FE0F}', color:'#8892a4' },
];
let tmWeekView = 'this';
let tmTimerInterval = null;

function saveTimeLog(){ localStorage.setItem('ag_timelog',JSON.stringify(timeLog)); syncToCloud('timeLog',timeLog); }
function saveActiveTime(){ if(activeTimeEntry) localStorage.setItem('ag_active_time',JSON.stringify(activeTimeEntry)); else localStorage.removeItem('ag_active_time'); }

function tmGetWeekKey(date){
  const d = new Date(date);
  const day = d.getDay();
  d.setDate(d.getDate() - day);
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dy=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${dy}`;
}
function tmTodayStr(){ return new Date().toISOString().split('T')[0]; }
function tmThisWeek(){ return tmGetWeekKey(new Date()); }
function tmLastWeek(){ const d=new Date(); d.setDate(d.getDate()-7); return tmGetWeekKey(d); }

function tmFmtDuration(ms){
  if(ms<60000) return `${Math.floor(ms/1000)}s`;
  const h=Math.floor(ms/3600000), m=Math.floor((ms%3600000)/60000);
  return h>0 ? `${h}h ${m}m` : `${m}m`;
}
function tmFmtTime(ts){ return new Date(ts).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true}); }

function startTimeTask(taskId){
  const task = TM_TASKS.find(t=>t.id===taskId);
  if(!task) return;
  const now = Date.now();
  // End current task if running and long enough to be worth logging
  if(activeTimeEntry){
    const dur = now - activeTimeEntry.startTime;
    if(dur > 10000){
      timeLog.unshift({ id:activeTimeEntry.startTime, type:activeTimeEntry.type, startTime:activeTimeEntry.startTime, endTime:now, duration:dur, date:activeTimeEntry.date, dayOfWeek:activeTimeEntry.dayOfWeek, hour:activeTimeEntry.hour, week:activeTimeEntry.week });
    }
  }
  const d = new Date();
  activeTimeEntry = { type:taskId, startTime:now, date:d.toISOString().split('T')[0], dayOfWeek:d.getDay(), hour:d.getHours(), week:tmGetWeekKey(d) };
  saveTimeLog();
  saveActiveTime();
  renderTMPanel();
  startTMTimer();
}

function stopTimeTask(){
  if(!activeTimeEntry) return;
  const now = Date.now();
  const dur = now - activeTimeEntry.startTime;
  if(dur > 10000){
    timeLog.unshift({ id:activeTimeEntry.startTime, type:activeTimeEntry.type, startTime:activeTimeEntry.startTime, endTime:now, duration:dur, date:activeTimeEntry.date, dayOfWeek:activeTimeEntry.dayOfWeek, hour:activeTimeEntry.hour, week:activeTimeEntry.week });
  }
  activeTimeEntry = null;
  clearInterval(tmTimerInterval);
  saveTimeLog();
  saveActiveTime();
  renderTMPanel();
}

function startTMTimer(){
  clearInterval(tmTimerInterval);
  tmTimerInterval = setInterval(()=>{
    if(!activeTimeEntry){ clearInterval(tmTimerInterval); return; }
    const el = document.getElementById('tm-active-timer');
    if(!el) return;
    const ms = Date.now() - activeTimeEntry.startTime;
    const h=Math.floor(ms/3600000), m=Math.floor((ms%3600000)/60000), s=Math.floor((ms%60000)/1000);
    el.textContent = h>0 ? `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}` : `${m}:${String(s).padStart(2,'0')}`;
    if(s===0) renderTMCharts(); // refresh charts every minute
  }, 1000);
}

function tmBuildPie(slices, size=160){
  const total = slices.reduce((s,sl)=>s+sl.value,0);
  if(!total) return `<div style="width:${size}px;height:${size}px;border-radius:50%;background:var(--surface2);display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:11px;font-family:'DM Mono',monospace;flex-shrink:0">No data</div>`;
  const cx=size/2, cy=size/2, r=size/2-2;
  let angle=-Math.PI/2;
  const paths=slices.filter(sl=>sl.value>0).map(sl=>{
    const a=(sl.value/total)*Math.PI*2;
    const x1=cx+r*Math.cos(angle), y1=cy+r*Math.sin(angle);
    angle+=a;
    const x2=cx+r*Math.cos(angle), y2=cy+r*Math.sin(angle);
    return `<path d="M${cx},${cy} L${x1.toFixed(1)},${y1.toFixed(1)} A${r},${r} 0 ${a>Math.PI?1:0},1 ${x2.toFixed(1)},${y2.toFixed(1)} Z" fill="${sl.color}"/>`;
  });
  return `<svg viewBox="0 0 ${size} ${size}" width="${size}" height="${size}" style="display:block;flex-shrink:0">${paths.join('')}</svg>`;
}

function tmBuildLegend(slices, total){
  if(!total) return `<div style="color:var(--muted);font-size:13px">No data logged yet</div>`;
  return slices.filter(sl=>sl.value>0).sort((a,b)=>b.value-a.value).map(sl=>{
    const pct=Math.round(sl.value/total*100);
    return `<div style="display:flex;align-items:center;gap:7px;margin-bottom:5px">
      <div style="width:10px;height:10px;border-radius:2px;background:${sl.color};flex-shrink:0"></div>
      <div style="flex:1;font-size:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${sl.label}</div>
      <div style="font-family:'DM Mono',monospace;font-size:11px;color:var(--muted);white-space:nowrap">${tmFmtDuration(sl.value)} \u{B7} ${pct}%</div>
    </div>`;
  }).join('');
}

function tmSlicesForDate(dateStr){
  const entries=[...timeLog.filter(e=>e.date===dateStr)];
  if(activeTimeEntry&&activeTimeEntry.date===dateStr) entries.push({...activeTimeEntry,duration:Date.now()-activeTimeEntry.startTime});
  return TM_TASKS.map(t=>({ label:t.label, value:entries.filter(e=>e.type===t.id).reduce((s,e)=>s+e.duration,0), color:t.color }));
}
function tmSlicesForWeek(weekKey){
  const entries=[...timeLog.filter(e=>e.week===weekKey)];
  if(activeTimeEntry&&activeTimeEntry.week===weekKey) entries.push({...activeTimeEntry,duration:Date.now()-activeTimeEntry.startTime});
  return TM_TASKS.map(t=>({ label:t.label, value:entries.filter(e=>e.type===t.id).reduce((s,e)=>s+e.duration,0), color:t.color }));
}

function setTMWeekView(view, btn){
  tmWeekView=view;
  document.querySelectorAll('#panel-time .filter-chip').forEach(c=>c.classList.remove('active-chip'));
  btn.classList.add('active-chip');
  renderTMCharts();
}

function renderTMActiveCard(){
  const idle=document.getElementById('tm-idle'), active=document.getElementById('tm-active');
  if(!idle||!active) return;
  if(!activeTimeEntry){ idle.style.display='block'; active.style.display='none'; return; }
  idle.style.display='none'; active.style.display='block';
  const task=TM_TASKS.find(t=>t.id===activeTimeEntry.type)||{icon:'\u{23F1}',label:activeTimeEntry.type,color:'var(--accent)'};
  document.getElementById('tm-active-icon').textContent=task.icon;
  const lbl=document.getElementById('tm-active-label');
  lbl.textContent=task.label; lbl.style.color=task.color;
  document.getElementById('tm-active-started').textContent='Started at '+tmFmtTime(activeTimeEntry.startTime);
}

function renderTMTaskButtons(){
  const grid=document.getElementById('tm-task-grid'); if(!grid) return;
  const activeId=activeTimeEntry?activeTimeEntry.type:null;
  grid.innerHTML=TM_TASKS.map(t=>`
    <button onclick="startTimeTask('${t.id}')" style="border:2px solid ${activeId===t.id?t.color:'var(--border)'};background:${activeId===t.id?t.color+'22':'var(--surface2)'};border-radius:10px;padding:12px 8px;cursor:pointer;text-align:center;transition:all .2s;font-family:'DM Sans',sans-serif;${activeId===t.id?`box-shadow:0 0 14px ${t.color}44;`:''}" onmouseover="this.style.borderColor='${t.color}'" onmouseout="this.style.borderColor='${activeId===t.id?t.color:'var(--border)'}'">
      <div style="font-size:22px;margin-bottom:5px">${t.icon}</div>
      <div style="font-size:12px;font-weight:600;line-height:1.2;color:${activeId===t.id?t.color:'var(--text)'}">${t.label}</div>
    </button>`).join('');
}

function renderTMCharts(){
  const today=tmTodayStr();
  const todaySlices=tmSlicesForDate(today);
  const todayTotal=todaySlices.reduce((s,sl)=>s+sl.value,0);
  const p1=document.getElementById('tm-pie-today'), l1=document.getElementById('tm-legend-today'), t1=document.getElementById('tm-today-total');
  if(p1) p1.innerHTML=tmBuildPie(todaySlices);
  if(l1) l1.innerHTML=tmBuildLegend(todaySlices,todayTotal);
  if(t1) t1.textContent=todayTotal?`Total tracked today: ${tmFmtDuration(todayTotal)}`:'';

  const weekKey=tmWeekView==='last'?tmLastWeek():tmThisWeek();
  const weekSlices=tmSlicesForWeek(weekKey);
  const weekTotal=weekSlices.reduce((s,sl)=>s+sl.value,0);
  const p2=document.getElementById('tm-pie-week'), l2=document.getElementById('tm-legend-week'), t2=document.getElementById('tm-week-total');
  if(p2) p2.innerHTML=tmBuildPie(weekSlices);
  if(l2) l2.innerHTML=tmBuildLegend(weekSlices,weekTotal);
  if(t2) t2.textContent=weekTotal?`Total tracked ${tmWeekView==='last'?'last':'this'} week: ${tmFmtDuration(weekTotal)}`:`No data for ${tmWeekView==='last'?'last':'this'} week`;
}

function renderTMLog(){
  const el=document.getElementById('tm-log-list'); if(!el) return;
  const today=tmTodayStr();
  const entries=timeLog.filter(e=>e.date===today);
  if(entries.length===0){ el.innerHTML='<div style="color:var(--muted);font-size:13px;text-align:center;padding:16px">No entries logged today \u{2014} tap a task above to start</div>'; return; }
  el.innerHTML=entries.map(e=>{
    const task=TM_TASKS.find(t=>t.id===e.type)||{icon:'\u{23F1}',label:e.type,color:'var(--muted)'};
    return `<div style="display:flex;align-items:center;gap:10px;padding:9px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;border-left:3px solid ${task.color};margin-bottom:4px">
      <div style="font-size:16px">${task.icon}</div>
      <div style="flex:1;min-width:0">
        <div style="font-size:13px;font-weight:600;color:${task.color}">${task.label}</div>
        <div style="font-size:11px;color:var(--muted);font-family:'DM Mono',monospace">${tmFmtTime(e.startTime)} \u{2192} ${tmFmtTime(e.endTime)}</div>
      </div>
      <div style="font-family:'DM Mono',monospace;font-size:12px;color:var(--muted);flex-shrink:0">${tmFmtDuration(e.duration)}</div>
      <button class="btn btn-danger btn-sm" onclick="deleteTMEntry(${e.id})">\u{2715}</button>
    </div>`;
  }).join('');
}

function deleteTMEntry(id){ timeLog=timeLog.filter(e=>e.id!==id); saveTimeLog(); renderTMPanel(); }
function clearTodayTMLog(){ if(!confirm('Clear all time entries for today?')) return; timeLog=timeLog.filter(e=>e.date!==tmTodayStr()); saveTimeLog(); renderTMPanel(); }

function renderTMPanel(){
  renderTMActiveCard();
  renderTMTaskButtons();
  renderTMCharts();
  renderTMLog();
}

// \u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}
// INIT
// \u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}
updateDate();
setInterval(updateDate,1000);
initDateInputs();
renderTodos();
renderLinks();
renderOutreach();
loadNotes();
renderConvoNotes();
renderDocs();
startGFPoll();
renderTrips();
renderSavedSchedules();
// Restore saved API key into field
(()=>{ const k=localStorage.getItem('ag_anthropic_key'); if(k){ const el=document.getElementById('sched-api-key'); if(el) el.value=k; } })();
renderTMPanel();
if(activeTimeEntry) startTMTimer();
updateHomeStats();
updateExportCounts();

// \u{2500}\u{2500} AUTH \u{2014} Simple sync key (no auth SDK) \u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}
async function handleLogin() {
  const password = document.getElementById('loginPassword').value.trim();
  if (password.length < 6) { showLoginError('Sync key must be at least 6 characters.'); return; }
  setLoginLoading(true);
  // Hash the password into a deterministic UUID-like sync_id
  const encoder = new TextEncoder();
  const data = encoder.encode('activate-hq:' + password);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  const hex = hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
  const id = `${hex.slice(0,8)}-${hex.slice(8,12)}-4${hex.slice(13,16)}-${hex.slice(16,20)}-${hex.slice(20,32)}`;
  syncId = id;
  currentUser = { id };
  localStorage.setItem('ag_sync_id', id);
  setLoginLoading(false);
  await activateApp();
}

async function handleSignOut() {
  syncId = null;
  currentUser = { id: null };
  localStorage.removeItem('ag_sync_id');
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('syncBar').style.display = 'none';
}

function setLoginLoading(loading) {
  const btn = document.getElementById('loginBtn');
  btn.textContent = loading ? 'Connecting...' : 'Connect \u{2192}';
  btn.disabled = loading;
}

function showLoginError(msg, isSuccess = false) {
  const el = document.getElementById('loginError');
  el.textContent = msg;
  el.style.display = 'block';
  el.style.background = isSuccess ? 'rgba(168,255,62,.1)' : 'rgba(255,77,109,.15)';
  el.style.borderColor = isSuccess ? 'rgba(168,255,62,.3)' : 'rgba(255,77,109,.3)';
  el.style.color = isSuccess ? 'var(--accent3)' : 'var(--accent2)';
}

async function activateApp() {
  document.getElementById('loginScreen').style.display = 'none';
  const syncBar = document.getElementById('syncBar');
  syncBar.style.display = 'flex';
  document.getElementById('syncUser').textContent = 'synced';
  await loadAllFromSupabase();
}

function setSyncStatus(status, msg) {
  const dot = document.getElementById('syncDot');
  const msgEl = document.getElementById('syncMsg');
  if (!dot || !msgEl) return;
  const colors = { synced:'var(--accent3)', syncing:'var(--gold)', error:'var(--accent2)', offline:'var(--muted)' };
  dot.style.background = colors[status] || 'var(--muted)';
  if (status === 'syncing') dot.style.animation = 'pulse 1s infinite';
  else dot.style.animation = '';
  msgEl.textContent = msg || 'Synced';
}

// \u{2500}\u{2500} LOAD ALL DATA FROM SUPABASE (direct REST) \u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}
async function loadAllFromSupabase() {
  if (!syncId) return;
  setSyncStatus('syncing', 'Loading your data...');
  try {
    const results = await Promise.all(
      Object.entries(TABLES).map(([key, table]) =>
        fetch(`${SB_URL}/rest/v1/${table}?sync_id=eq.${syncId}&select=data`, { headers: sbHeaders() })
          .then(r => r.json())
          .then(rows => ({ key, row: rows[0] || null }))
      )
    );
    results.forEach(({ key, row }) => {
      if (!row || !row.data) return;
      const d = row.data;
      if (key === 'todos')        { todos = d;        localStorage.setItem('ag_todos', JSON.stringify(d)); }
      if (key === 'customLinks')  { customLinks = d;  localStorage.setItem('ag_links', JSON.stringify(d)); }
      if (key === 'outreachList') { outreachList = d; localStorage.setItem('ag_outreach', JSON.stringify(d)); }
      if (key === 'convoNotes')   { convoNotes = d;   localStorage.setItem('ag_convonotes', JSON.stringify(d)); }
      if (key === 'handoffs')     { handoffs = d;     localStorage.setItem('ag_handoffs', JSON.stringify(d)); }
      if (key === 'trips')        { trips = d;        localStorage.setItem('ag_trips', JSON.stringify(d)); }
      if (key === 'schedules')    { schedules = d;    localStorage.setItem('ag_schedules', JSON.stringify(d)); }
      if (key === 'timeLog')      { timeLog = d;      localStorage.setItem('ag_timelog',   JSON.stringify(d)); }
    });
    renderTodos(); renderLinks(); renderOutreach();
    loadNotes(); renderConvoNotes(); renderDocs();
    renderHandoffs(); renderTrips(); renderSavedSchedules(); renderTMPanel();
    updateHomeStats(); updateExportCounts();
    setSyncStatus('synced', 'Synced \u{2713}');
  } catch(e) {
    setSyncStatus('error', 'Sync error \u{2014} using local data');
    console.error('Load error:', e);
  }
}

// \u{2500}\u{2500} SAVE A SINGLE KEY TO SUPABASE \u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}


// \u{2500}\u{2500} PATCH SAVE FUNCTIONS TO ALSO SYNC \u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}
// \u{2500}\u{2500} SAVE FUNCTIONS now call syncToCloud directly (see definitions above) \u{2500}\u{2500}

// \u{2500}\u{2500} AUTO-LOGIN + REFRESH \u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}
function refreshAllData() {
  if (!syncId) return;
  loadAllFromSupabase();
}
document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') refreshAllData(); });
window.addEventListener('focus', refreshAllData);
window.addEventListener('pageshow', refreshAllData);
setInterval(() => { if (document.visibilityState === 'visible') refreshAllData(); }, 30000);

// Auto-login if sync key saved
if (syncId) {
  activateApp();
} else {
  document.getElementById('loginScreen').style.display = 'flex';
}

// \u{2500}\u{2500} PWA \u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}\u{2500}
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(() => {});
  });
}
function isIOS() { return /iphone|ipad|ipod/i.test(navigator.userAgent); }
function isInStandaloneMode() { return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone; }
function dismissBanner() { document.getElementById('installBanner').classList.remove('visible'); localStorage.setItem('ag_banner_dismissed','1'); }
if (isIOS() && !isInStandaloneMode() && !localStorage.getItem('ag_banner_dismissed')) {
  document.getElementById('installBanner').classList.add('visible');
}
if (window.location.hash) {
  const target = window.location.hash.replace('#','');
  setTimeout(() => {
    const panel = document.getElementById('panel-'+target);
    if (panel) {
      document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      panel.classList.add('active');
      document.querySelectorAll('.tab-btn').forEach(b=>{ if(b.getAttribute('onclick')&&b.getAttribute('onclick').includes("'"+target+"'")) b.classList.add('active'); });
    }
  }, 100);
}


</script>
</body>
</html>
